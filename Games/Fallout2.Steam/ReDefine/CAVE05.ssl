variable ProtoOfItemGiven;
variable ValueOfRollCheck := 1;
variable Scenery_Creation;
variable Scenery_Creation_Hex;
variable Scenery_Creation_Count;
variable Temp_Scenery_Creation_Hex;
variable Scenery_Creation_Ptr;
variable How_Many_Party_Members_Are_Injured;
variable How_Many_Party_Members_Armed;
variable PartyHealingItem;

procedure checkPartyMembersNearDoor;

variable global_temp;
variable dest_tile;
variable step_tile;
variable in_dialog;
variable forced_node;
variable restock_amt;
variable restock_obj;
variable restock_trash;
variable removed_qty;
variable encounter_pid1;
variable encounter_pid2;
variable encounter_pid3;
variable encounter_pid4;
variable encounter_pid5;
variable encounter_pid6;
variable encounter_sid1;
variable encounter_sid2;
variable encounter_sid3;
variable encounter_sid4;
variable encounter_sid5;
variable encounter_sid6;
variable active_encounter_pids;
variable total_encounter_mobs;
variable special_theif_encounter;
variable choose_enc_pid;
variable choose_enc_sid;

procedure Choose_Encounter;
procedure Choose_Pid;
procedure placeCritter(variable arg0, variable arg1, variable arg2);
procedure start;
procedure map_enter_p_proc;
procedure map_update_p_proc;
procedure map_exit_p_proc;
procedure LoadCritters;
procedure LoadCritterPos;
procedure LoadChests;

variable Critter;
variable Critter_Tile;

procedure Initial_Inven;


procedure checkPartyMembersNearDoor
begin
    if (party_member_obj(16777278) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777278)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777376) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777376)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777377) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777377)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777305) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777305)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777313) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777313)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777323) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777323)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777352) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777352)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777378) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777378)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777368) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777368)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777379) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777379)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777380) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777380)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777295) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777295)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777381) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777381)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777407) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777407)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777411) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777411)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777412) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777412)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777413) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777413)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777481) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777481)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777558) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777558)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777600) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777600)) <= 5) then begin
            return 1;
        end
    end
    return 0;
end

procedure Choose_Encounter
begin
    variable LVar0 := 0;
    special_theif_encounter := 0;
    LVar0 := random(1, 13);
    if (LVar0 == 1) then begin
        active_encounter_pids := 1;
        if (get_pc_stat(PCSTAT_level) < 6) then begin
            encounter_pid1 := 16777296;
            encounter_sid1 := 615;
            total_encounter_mobs := random(3, 5);
        end
        else begin
            if (get_pc_stat(PCSTAT_level) < 12) then begin
                encounter_pid1 := 16777297;
                encounter_sid1 := 615;
                total_encounter_mobs := random(3, 5);
            end
            else begin
                if (get_pc_stat(PCSTAT_level) < 13) then begin
                    encounter_pid1 := 16777456;
                    encounter_sid1 := 615;
                    total_encounter_mobs := random(3, 5);
                end
                else begin
                    encounter_pid1 := 16777457;
                    encounter_sid1 := 615;
                    total_encounter_mobs := random(3, 5);
                end
            end
        end
    end
    else begin
        if (LVar0 == 2) then begin
            active_encounter_pids := 1;
            if (get_pc_stat(PCSTAT_level) < 5) then begin
                encounter_pid1 := 16777299;
                encounter_sid1 := 615;
                total_encounter_mobs := random(3, 5);
            end
            else begin
                if (get_pc_stat(PCSTAT_level) < 12) then begin
                    encounter_pid1 := 16777302;
                    encounter_sid1 := 615;
                    total_encounter_mobs := random(3, 5);
                end
                else begin
                    if (get_pc_stat(PCSTAT_level) < 13) then begin
                        encounter_pid1 := 16777456;
                        encounter_sid1 := 615;
                        total_encounter_mobs := random(3, 5);
                    end
                    else begin
                        encounter_pid1 := 16777457;
                        encounter_sid1 := 615;
                        total_encounter_mobs := random(3, 5);
                    end
                end
            end
        end
        else begin
            if (LVar0 == 3) then begin
                active_encounter_pids := 1;
                encounter_pid1 := 16777221;
                encounter_sid1 := 616;
                total_encounter_mobs := random(3, 5);
            end
            else begin
                if (LVar0 == 4) then begin
                    active_encounter_pids := 1;
                    encounter_pid1 := 16777222;
                    encounter_sid1 := 616;
                    total_encounter_mobs := random(3, 5);
                end
                else begin
                    if (LVar0 == 5) then begin
                        active_encounter_pids := 1;
                        encounter_pid1 := 16777223;
                        encounter_sid1 := 22;
                        total_encounter_mobs := random(3, 5);
                    end
                    else begin
                        if (LVar0 == 6) then begin
                            active_encounter_pids := 1;
                            encounter_pid1 := 16777224;
                            encounter_sid1 := 22;
                            total_encounter_mobs := 5;
                        end
                        else begin
                            if (LVar0 == 7) then begin
                                active_encounter_pids := 1;
                                encounter_pid1 := 16777333;
                                encounter_sid1 := 617;
                                total_encounter_mobs := random(3, 5);
                            end
                            else begin
                                if (LVar0 == 8) then begin
                                    active_encounter_pids := 1;
                                    encounter_pid1 := 16777334;
                                    encounter_sid1 := 617;
                                    total_encounter_mobs := random(4, 5);
                                end
                                else begin
                                    if (LVar0 == 9) then begin
                                        active_encounter_pids := 2;
                                        if (get_pc_stat(PCSTAT_level) < 5) then begin
                                            encounter_pid1 := 16777296;
                                            encounter_pid2 := 16777299;
                                            encounter_sid1 := 615;
                                            encounter_sid2 := 615;
                                            total_encounter_mobs := random(3, 5);
                                        end
                                        else begin
                                            encounter_pid1 := 16777297;
                                            encounter_pid2 := 16777302;
                                            encounter_sid1 := 615;
                                            encounter_sid2 := 615;
                                            if (get_pc_stat(PCSTAT_level) > 12) then begin
                                                active_encounter_pids := 3;
                                                encounter_pid3 := 16777456;
                                                encounter_sid3 := 615;
                                            end
                                            else begin
                                                if (get_pc_stat(PCSTAT_level) > 15) then begin
                                                    active_encounter_pids := 3;
                                                    encounter_pid3 := 16777457;
                                                    encounter_sid3 := 615;
                                                end
                                            end
                                            total_encounter_mobs := 5;
                                        end
                                    end
                                    else begin
                                        if (LVar0 == 10) then begin
                                            active_encounter_pids := 2;
                                            encounter_pid1 := 16777221;
                                            encounter_pid2 := 16777222;
                                            encounter_sid1 := 616;
                                            encounter_sid2 := 616;
                                            total_encounter_mobs := random(3, 5);
                                        end
                                        else begin
                                            if (LVar0 == 11) then begin
                                                active_encounter_pids := 2;
                                                encounter_pid1 := 16777223;
                                                encounter_pid2 := 16777224;
                                                encounter_sid1 := 22;
                                                encounter_sid2 := 22;
                                                total_encounter_mobs := 5;
                                            end
                                            else begin
                                                if (LVar0 == 12) then begin
                                                    active_encounter_pids := 2;
                                                    encounter_pid1 := 16777333;
                                                    encounter_pid1 := 16777334;
                                                    encounter_sid1 := 617;
                                                    encounter_sid2 := 617;
                                                    total_encounter_mobs := 5;
                                                end
                                                else begin
                                                    if (LVar0 == 13) then begin
                                                        if (is_success(do_check(dude_obj, 6, 0))) then begin
                                                            special_theif_encounter := 1;
                                                            active_encounter_pids := 2;
                                                            if (get_pc_stat(PCSTAT_level) < 5) then begin
                                                                encounter_pid1 := 16777486;
                                                                encounter_pid2 := 16777487;
                                                                encounter_sid1 := 625;
                                                                encounter_sid2 := 625;
                                                                total_encounter_mobs := random(2, 3);
                                                            end
                                                            else begin
                                                                if (get_pc_stat(PCSTAT_level) < 11) then begin
                                                                    encounter_pid1 := 16777400;
                                                                    encounter_pid2 := 16777401;
                                                                    encounter_sid1 := 625;
                                                                    encounter_sid2 := 625;
                                                                    total_encounter_mobs := random(3, 4);
                                                                end
                                                                else begin
                                                                    encounter_pid1 := 16777403;
                                                                    encounter_pid2 := 16777404;
                                                                    encounter_sid1 := 625;
                                                                    encounter_sid2 := 625;
                                                                    total_encounter_mobs := random(3, 4);
                                                                end
                                                            end
                                                        end
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end

procedure Choose_Pid
begin
    variable LVar0 := 0;
    LVar0 := random(1, active_encounter_pids);
    if (LVar0 == 1) then begin
        choose_enc_pid := encounter_pid1;
        choose_enc_sid := encounter_sid1;
    end
    else begin
        if (LVar0 == 2) then begin
            choose_enc_pid := encounter_pid2;
            choose_enc_sid := encounter_sid2;
        end
        else begin
            if (LVar0 == 3) then begin
                choose_enc_pid := encounter_pid3;
                choose_enc_sid := encounter_sid3;
            end
            else begin
                if (LVar0 == 4) then begin
                    choose_enc_pid := encounter_pid4;
                    choose_enc_sid := encounter_sid4;
                end
                else begin
                    if (LVar0 == 5) then begin
                        choose_enc_pid := encounter_pid5;
                        choose_enc_sid := encounter_sid5;
                    end
                    else begin
                        if (LVar0 == 6) then begin
                            choose_enc_pid := encounter_pid6;
                            choose_enc_sid := encounter_sid6;
                        end
                        else begin
                            choose_enc_pid := encounter_pid6;
                            choose_enc_sid := encounter_sid6;
                        end
                    end
                end
            end
        end
    end
end

procedure placeCritter(variable arg0, variable arg1, variable arg2)
begin
    variable LVar3 := 0;
    variable LVar4 := 0;
    variable LVar5 := 0;
    if (arg0 >= 1) then begin
        LVar3 := tile_num_in_direction(arg2, random(0, 5), random(1, 3));
        LVar4 := create_object_sid(arg0, 0, 0, arg1);
        if (cur_map_index != MAP_CAVE5) then begin
            critter_attempt_placement(LVar4, LVar3, 1);
        end
        else begin
            critter_attempt_placement(LVar4, LVar3, 2);
        end
        while ((tile_distance(tile_num(LVar4), arg2) > 5) and (LVar5 < 4)) do begin
            LVar3 := tile_num_in_direction(arg2, random(0, 5), random(1, 2));
            debug_msg("tile_num == " + LVar3);
            LVar5 := LVar5 + 1;
        end
        if ((LVar5 >= 4) and (LVar3 > 0)) then begin
            if (cur_map_index != MAP_CAVE5) then begin
                critter_attempt_placement(LVar4, arg2, 1);
            end
            else begin
                critter_attempt_placement(LVar4, arg2, 2);
            end
        end
        if (tile_distance(tile_num(LVar4), arg2) > 5) then begin
            destroy_object(LVar4);
            debug_msg("Couldn't find Safe spot. Destroying Ptr.");
        end
    end
    else begin
        debug_msg("ERROR: Pid < 1. Pid == " + arg0 + ".");
    end
end

procedure start
begin
end

procedure map_enter_p_proc
begin
    variable LVar0 := 0;
    variable LVar1 := 0;
    wm_area_set_pos(27, worldmap_xpos, worldmap_ypos);
    if (not(is_loading_game)) then begin
        call LoadCritters();
        if (special_theif_encounter) then begin
            call LoadChests();
        end
    end
    if (CUR_MAP_CAVE0) then begin
        LVar0 := 18909;
        LVar1 := 0;
    end
    else begin
        if (CUR_MAP_CAVE1) then begin
            LVar0 := 26508;
            LVar1 := 0;
        end
        else begin
            if (CUR_MAP_CAVE2) then begin
                LVar0 := 24706;
                LVar1 := 0;
            end
            else begin
                if (CUR_MAP_CAVE3) then begin
                    LVar0 := 24915;
                    LVar1 := 0;
                end
                else begin
                    if (CUR_MAP_CAVE4) then begin
                        LVar0 := 27512;
                        LVar1 := 0;
                    end
                    else begin
                        if (CUR_MAP_CAVE5) then begin
                            LVar0 := 26292;
                            LVar1 := 0;
                        end
                    end
                end
            end
        end
    end
    if (LVar0 != 0) then begin
        debug_msg("Check_Create_Car(" + LVar0 + "," + LVar1 + ")");
        if (not(is_loading_game)) then begin
            if (global_var(GVAR_PLAYER_GOT_CAR) != 0) then begin
                debug_msg("car_current_town == " + car_current_town + " / map_get_load_area == " + map_get_load_area);
                if ((car_current_town == map_get_load_area) or ((26 <= car_current_town) and (car_current_town <= 29) and (map_get_load_area == -1))) then begin
                    debug_msg("Place_Car(" + LVar0 + "," + LVar1 + ")");
                    debug_msg("   GVAR_CAR_PLACED_TILE == " + global_var(GVAR_CAR_PLACED_TILE));
                    debug_msg("   Car_At_Loc == " + (tile_contains_pid_obj(LVar0, LVar1, 33555441) != 0));
                    if ((global_var(GVAR_CAR_PLACED_TILE) <= 0) or (LVar0 == global_var(GVAR_CAR_PLACED_TILE))) then begin
                        set_global_var(GVAR_CAR_PLACED_TILE, LVar0);
                        if (not(tile_contains_pid_obj(LVar0, LVar1, 33555441) != 0)) then begin
                            Scenery_Creation := create_object_sid(33555441, LVar0, LVar1, SCRIPT_ZSDRVCAR);
                            Scenery_Creation_Hex := LVar0;
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 2) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 1, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 2) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 2, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 2) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 3, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 2) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 4, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 5, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 4, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 5, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 4, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 5, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 4, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 0, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 5, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 2) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 0, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 1, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 2, 1);
                                Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                        end
                    end
                    if (tile_contains_pid_obj(LVar0, LVar1, 33555441) != 0) then begin
                        if (not(tile_contains_pid_obj(tile_num_in_direction(tile_num_in_direction(LVar0, 5, 2), 4, 1), LVar1, 455) != 0)) then begin
                            debug_msg("placing trunk:");
                            Scenery_Creation_Ptr := 0;
                            if (party_member_obj(455) != 0) then begin
                                Scenery_Creation_Ptr := party_member_obj(455);
                            end
                            else begin
                                if (global_var(GVAR_PLAYER_GOT_CAR) == 0) then begin
                                    Scenery_Creation_Ptr := create_object_sid(455, 0, 0, SCRIPT_ZICRTRNK);
                                end
                            end
                            if (Scenery_Creation_Ptr != 0) then begin
                                Scenery_Creation_Hex := tile_num_in_direction(tile_num_in_direction(LVar0, 5, 2), 4, 1);
                                move_to(Scenery_Creation_Ptr, Scenery_Creation_Hex, LVar1);
                                Scenery_Creation_Count := 0;
                                while (Scenery_Creation_Count < 1) do begin
                                    Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 1, 1);
                                    Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                    Scenery_Creation_Count := Scenery_Creation_Count + 1;
                                end
                                Scenery_Creation_Count := 0;
                                while (Scenery_Creation_Count < 1) do begin
                                    Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 2, 1);
                                    Scenery_Creation := create_object(33554499, Scenery_Creation_Hex, LVar1);
                                    Scenery_Creation_Count := Scenery_Creation_Count + 1;
                                end
                            end
                            else begin
                                debug_msg("WE HAD AN ERROR WITH THE TRUNK PTR, OHHH FUCK");
                            end
                        end
                    end
                end
                else begin
                    if (tile_contains_pid_obj(LVar0, LVar1, 33555441) != 0) then begin
                        debug_msg("Dest_Car_Loc(" + LVar0 + "," + LVar1 + ")");
                        Scenery_Creation_Ptr := tile_contains_pid_obj(LVar0, LVar1, 33555441);
                        if (Scenery_Creation_Ptr != 0) then begin
                            destroy_object(Scenery_Creation_Ptr);
                            Scenery_Creation_Hex := LVar0;
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 2) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 1, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 2) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 2, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 2) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 3, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 2) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 4, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 5, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 4, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 5, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 4, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 5, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 4, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 0, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 5, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 2) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 0, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 1, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 2, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 1, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                            Scenery_Creation_Count := 0;
                            while (Scenery_Creation_Count < 1) do begin
                                Scenery_Creation_Hex := tile_num_in_direction(Scenery_Creation_Hex, 2, 1);
                                Scenery_Creation_Ptr := tile_contains_pid_obj(Scenery_Creation_Hex, LVar1, 33554499);
                                destroy_object(Scenery_Creation_Ptr);
                                Scenery_Creation_Count := Scenery_Creation_Count + 1;
                            end
                        end
                        Scenery_Creation_Ptr := tile_contains_pid_obj(tile_num_in_direction(tile_num_in_direction(LVar0, 5, 2), 4, 1), LVar1, 455);
                        if (Scenery_Creation_Ptr != 0) then begin
                            if (Scenery_Creation_Ptr == party_member_obj(455)) then begin
                                set_obj_visibility(Scenery_Creation_Ptr, 1);
                            end
                            else begin
                                destroy_object(Scenery_Creation_Ptr);
                            end
                        end
                    end
                end
            end
            else begin
                debug_msg("the player hasn't gotten the car, can't place it");
            end
        end
        else begin
            debug_msg("sorry, can't place the car, the game's loading");
        end
    end
    else begin
        debug_msg("DIDN'T HAVE MAP HEX FOR CAR, WE NEED TO CREATE ONE");
    end
    if (map_first_run) then begin
        display_msg(message_str(SCRIPT_CAVE01, 100));
    end
    set_light_level(50);
    if (map_first_run and not(global_var(GVAR_MYSTERIOUS_STRANGER) bwand 1) and (random(0, 99) < (30 + (2 * dude_luck))) and has_trait(TRAIT_PERK, dude_obj, PERK_mysterious_stranger)) then begin
        if (not(global_var(GVAR_MYSTERIOUS_STRANGER) bwand 2)) then begin
            set_global_var(GVAR_MYSTERIOUS_STRANGER, global_var(GVAR_MYSTERIOUS_STRANGER) bwor 2);
            debug_msg("Set the Stranger Gender");
            if (random(0, 99) < 50) then begin
                set_global_var(GVAR_MYSTERIOUS_STRANGER, global_var(GVAR_MYSTERIOUS_STRANGER) bwor 4);
            end
        end
        if (global_var(GVAR_MYSTERIOUS_STRANGER) bwand 4) then begin
            if (get_pc_stat(PCSTAT_level) > 26) then begin
                Critter := create_object_sid(16777503, 0, 0, SCRIPT_ECMSTSTR);
            end
            else begin
                if (get_pc_stat(PCSTAT_level) > 22) then begin
                    Critter := create_object_sid(16777501, 0, 0, SCRIPT_ECMSTSTR);
                end
                else begin
                    if (get_pc_stat(PCSTAT_level) > 18) then begin
                        Critter := create_object_sid(16777499, 0, 0, SCRIPT_ECMSTSTR);
                    end
                    else begin
                        if (get_pc_stat(PCSTAT_level) > 14) then begin
                            Critter := create_object_sid(16777497, 0, 0, SCRIPT_ECMSTSTR);
                        end
                        else begin
                            Critter := create_object_sid(16777487, 0, 0, SCRIPT_ECMSTSTR);
                        end
                    end
                end
            end
        end
        else begin
            if (get_pc_stat(PCSTAT_level) > 26) then begin
                Critter := create_object_sid(16777502, 0, 0, SCRIPT_ECMSTSTR);
            end
            else begin
                if (get_pc_stat(PCSTAT_level) > 22) then begin
                    Critter := create_object_sid(16777500, 0, 0, SCRIPT_ECMSTSTR);
                end
                else begin
                    if (get_pc_stat(PCSTAT_level) > 18) then begin
                        Critter := create_object_sid(16777498, 0, 0, SCRIPT_ECMSTSTR);
                    end
                    else begin
                        if (get_pc_stat(PCSTAT_level) > 14) then begin
                            Critter := create_object_sid(16777496, 0, 0, SCRIPT_ECMSTSTR);
                        end
                        else begin
                            Critter := create_object_sid(16777486, 0, 0, SCRIPT_ECMSTSTR);
                        end
                    end
                end
            end
        end
        Critter_Tile := tile_num_in_direction(dude_tile, random(0, 5), random(5, 10));
        critter_attempt_placement(Critter, Critter_Tile, dude_elevation);
    end
    set_global_var(GVAR_LOAD_MAP_INDEX, 0);
end

procedure map_update_p_proc
begin
    set_light_level(50);
end

procedure map_exit_p_proc
begin
    if (not(car_out_of_fuel)) then begin
        if ((tile_contains_pid_obj(global_var(GVAR_CAR_PLACED_TILE), 0, 33555441) != 0) or (tile_contains_pid_obj(global_var(GVAR_CAR_PLACED_TILE), 1, 33555441) != 0) or (tile_contains_pid_obj(global_var(GVAR_CAR_PLACED_TILE), 2, 33555441) != 0)) then begin
            debug_msg("car_give_to_party");
            set_global_var(GVAR_CAR_PLACED_TILE, 0);
            car_give_to_party;
        end
    end
end

procedure LoadCritters
begin
    call Choose_Encounter();
    call LoadCritterPos();
end

procedure LoadCritterPos
begin
    variable LVar0 := 0;
    variable LVar1 := 0;
    variable LVar2 := 0;
    LVar1 := total_encounter_mobs;
    while (LVar1 > 0) do begin
        call Choose_Pid();
        call placeCritter(choose_enc_pid, choose_enc_sid, 12666);
        LVar1 := LVar1 - 1;
    end
    LVar1 := total_encounter_mobs;
    while (LVar1 > 0) do begin
        call Choose_Pid();
        call placeCritter(choose_enc_pid, choose_enc_sid, 16067);
        LVar1 := LVar1 - 1;
    end
    LVar1 := total_encounter_mobs;
    while (LVar1 > 0) do begin
        call Choose_Pid();
        call placeCritter(choose_enc_pid, choose_enc_sid, 20265);
        LVar1 := LVar1 - 1;
    end
    LVar1 := total_encounter_mobs;
    while (LVar1 > 0) do begin
        call Choose_Pid();
        call placeCritter(choose_enc_pid, choose_enc_sid, 21888);
        LVar1 := LVar1 - 1;
    end
    LVar1 := total_encounter_mobs;
    while (LVar1 > 0) do begin
        call Choose_Pid();
        call placeCritter(choose_enc_pid, choose_enc_sid, 28901);
        LVar1 := LVar1 - 1;
    end
    LVar1 := total_encounter_mobs;
    while (LVar1 > 0) do begin
        call Choose_Pid();
        call placeCritter(choose_enc_pid, choose_enc_sid, 24506);
        LVar1 := LVar1 - 1;
    end
    LVar1 := total_encounter_mobs;
    while (LVar1 > 0) do begin
        call Choose_Pid();
        call placeCritter(choose_enc_pid, choose_enc_sid, 20326);
        LVar1 := LVar1 - 1;
    end
    LVar1 := total_encounter_mobs;
    while (LVar1 > 0) do begin
        call Choose_Pid();
        call placeCritter(choose_enc_pid, choose_enc_sid, 14899);
        LVar1 := LVar1 - 1;
    end
end

procedure LoadChests
begin
    variable LVar0 := 0;
    LVar0 := create_object(245, 19929, 2);
    if (LVar0) then begin
        if (random(1, 2) == 1) then begin
            add_mult_objs_to_inven(LVar0, create_object(40, 19929, 1), random(1, 5));
        end
        if (random(1, 4) == 1) then begin
            if (get_pc_stat(PCSTAT_level) > 7) then begin
                add_obj_to_inven(LVar0, create_object(235, 19929, 1));
            end
            else begin
                add_obj_to_inven(LVar0, create_object(160, 19929, 1));
            end
        end
        item_caps_adjust(LVar0, 20 * random(1, dude_luck));
    end
    LVar0 := create_object(245, 29304, 2);
    if (LVar0) then begin
        if (random(1, 2) == 1) then begin
            add_mult_objs_to_inven(LVar0, create_object(40, 29304, 1), random(1, 5));
        end
        if (random(1, 4) == 1) then begin
            if (get_pc_stat(PCSTAT_level) > 5) then begin
                add_obj_to_inven(LVar0, create_object(115, 29304, 1));
            end
            else begin
                add_obj_to_inven(LVar0, create_object(10, 29304, 1));
            end
        end
        item_caps_adjust(LVar0, 20 * random(dude_luck, dude_luck * dude_luck));
    end
    LVar0 := create_object(245, 19863, 2);
    if (LVar0) then begin
        if (random(1, 2) == 1) then begin
            if (get_pc_stat(PCSTAT_level) < 7) then begin
                add_mult_objs_to_inven(LVar0, create_object(25, 19863, 1), random(1, 5));
            end
            else begin
                add_mult_objs_to_inven(LVar0, create_object(26, 19863, 1), random(1, 5));
            end
        end
        if (random(1, 4) == 1) then begin
            if (get_pc_stat(PCSTAT_level) > 10) then begin
                add_obj_to_inven(LVar0, create_object(15, 19863, 1));
            end
            else begin
                add_obj_to_inven(LVar0, create_object(10, 19863, 1));
            end
        end
        item_caps_adjust(LVar0, 20 * random(dude_luck, dude_luck * dude_luck));
    end
end

procedure Initial_Inven
begin
end
