variable ProtoOfItemGiven;
variable ValueOfRollCheck := 1;
variable Scenery_Creation;
variable Scenery_Creation_Hex;
variable Scenery_Creation_Count;
variable Temp_Scenery_Creation_Hex;
variable Scenery_Creation_Ptr;
variable How_Many_Party_Members_Are_Injured;
variable How_Many_Party_Members_Armed;
variable PartyHealingItem;

procedure checkPartyMembersNearDoor;

variable global_temp;
variable dest_tile;
variable step_tile;
variable in_dialog;
variable forced_node;
variable restock_amt;
variable restock_obj;
variable restock_trash;
variable removed_qty;

import variable NPC1;
import variable dealer;

variable hand;
variable stash;
variable num_changes;
variable pl_bet;
variable dealer_bet;
variable npc1_bet;
variable dealer_check;
variable npc1_check;
variable try_open;
variable dealer_try_open;
variable npc1_try_open;
variable dealer_succ_check;
variable npc1_succ_check;
variable step;
variable bet;
variable dealer_pass;
variable npc1_pass;
variable pl_cash;
variable pl_change_done;
variable say_once;
variable total_cash_on_map_enter;

procedure start;
procedure talk_p_proc;
procedure map_enter_p_proc;
procedure pow(variable arg0, variable arg1);
procedure has_pairs;
procedure has_three;
procedure has_full_house;
procedure Has_four;
procedure Has_flesh;
procedure has_straight;
procedure give_straight_flesh;
procedure give_four;
procedure give_full_house;
procedure give_flesh;
procedure give_straight;
procedure give_three;
procedure give_two_pairs;
procedure give_pair;
procedure Start_Game_Dialog(variable arg0);
procedure Poker_End_Seq;
procedure NodeP_Begin;
procedure NodeP_BigGame;
procedure NodeP_NormalGame;
procedure NodePokerStart;
procedure NodeP_PlayerViewCards;
procedure NodeP_PlayerChangeCard;
procedure Done_change_cards;
procedure Player_Change_1_Card;
procedure Player_Change_2_Card;
procedure Player_Change_3_Card;
procedure Show_change_cards;
procedure player_change_card(variable arg0);
procedure NodeChange1;
procedure NodeChange2;
procedure NodeChange3;
procedure NodeChange4;
procedure NodeChange5;
procedure NodeP_DealerChangeCards;
procedure NodeP_NPC1ChangeCards;
procedure NodeP_Barter;
procedure NodeP_BarterDealer;
procedure NodeP_BarterNPC1;
procedure NodeP_PlayerPass;
procedure NodeP_PlayerAccept;
procedure NodeP_NPCPass;
procedure NodeCheckDealer;
procedure NodeCheckNPC1;
procedure Check_Partner(variable arg0);
procedure Show_Dealer_cards;
procedure Show_NPC1_cards;
procedure NodeP_CompareEnd;
procedure NodePokerDoCompare;
procedure check_open(variable arg0);
procedure NodeP_Open;
procedure NodeP_NPC1Open;
procedure Node_Dumb;
procedure Node999;
procedure get_Deck(variable arg0);
procedure get_was_changed(variable arg0);
procedure set_hand(variable arg0, variable arg1);
procedure get_hand(variable arg0);
procedure set_comb(variable arg0, variable arg1);
procedure get_comb(variable arg0);
procedure clean_hands;
procedure get_cash1(variable arg0);
procedure set_cash(variable arg0, variable arg1);
procedure get_total_win;
procedure set_total_win(variable arg0);
procedure get_Card(variable arg0, variable arg1, variable arg2);
procedure setDeck(variable arg0);
procedure Sort;
procedure Sort_By_Color;
procedure CheckLuck(variable arg0);
procedure getCards(variable arg0);
procedure Shuffle_Deck;
procedure checkComb(variable arg0);
procedure showComb(variable arg0);
procedure ChangeCard(variable arg0, variable arg1);
procedure NPCThink(variable arg0);
procedure comb_value(variable arg0);
procedure check_partner_comb(variable arg0, variable arg1);
procedure player_barter_dealer;
procedure player_barter_NPC1;
procedure bart_with_player(variable arg0);
procedure NPCBarter(variable arg0);
procedure Add10;
procedure Add20;
procedure Add50;
procedure Add100;
procedure pr_npc(variable arg0);
procedure other_npc(variable arg0);
procedure set_bet(variable arg0, variable arg1);
procedure get_bet(variable arg0);
procedure get_pass(variable arg0);
procedure set_pass(variable arg0);
procedure generate_bet(variable arg0);
procedure NodeP_DealerWantsOpen;
procedure NodeP_NPC1WantsOpen;
procedure set_try_open(variable arg0, variable arg1);
procedure get_try_open(variable arg0);
procedure npc_wants_open(variable arg0);
procedure npc_do_barter(variable arg0);
procedure npc_change_cards(variable arg0);
procedure know_player_cards(variable arg0);
procedure mod_cash(variable arg0, variable arg1);
procedure get_cash(variable arg0);
procedure aquire_cash(variable arg0, variable arg1, variable arg2);
procedure generate_ending(variable arg0, variable arg1);
procedure pl_gender;
procedure damage_p_proc;
procedure destroy_p_proc;
procedure critter_p_proc;
procedure timed_event_p_proc;
procedure generate_days;
procedure NodeP_Again;


procedure checkPartyMembersNearDoor
begin
    if (party_member_obj(16777278) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777278)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777376) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777376)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777377) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777377)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777305) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777305)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777313) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777313)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777323) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777323)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777352) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777352)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777378) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777378)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777368) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777368)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777379) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777379)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777380) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777380)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777295) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777295)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777381) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777381)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777407) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777407)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777411) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777411)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777412) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777412)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777413) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777413)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777481) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777481)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777558) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777558)) <= 5) then begin
            return 1;
        end
    end
    if (party_member_obj(16777600) != 0) then begin
        if (tile_distance_objs(self_obj, party_member_obj(16777600)) <= 5) then begin
            return 1;
        end
    end
    return 0;
end

procedure start
begin
    dealer := self_obj;
end

procedure talk_p_proc
begin
    bet := 5;
    dealer := self_obj;
    start_gdialog(1360, self_obj, -1, -1, -1);
    gsay_start;
    call NodeP_Begin();
    gsay_end;
    end_dialogue;
end

procedure map_enter_p_proc
begin
    variable LVar0 := 0;
    LVar0 := days_since_visited;
    dealer := self_obj;
    if (LVar0 == -1) then begin
        call set_cash(dealer, 250);
        call set_cash(NPC1, 150);
        call set_total_win(0);
    end
    else begin
        call aquire_cash(dealer, LVar0, 250);
        call aquire_cash(NPC1, LVar0, 150);
    end
    total_cash_on_map_enter := get_cash(dealer) + get_cash(NPC1);
    critter_add_trait(self_obj, 1, 6, 35);
    critter_add_trait(self_obj, 1, 5, 24);
end

procedure pow(variable arg0, variable arg1)
begin
    variable LVar2 := 0;
    variable LVar3 := 0;
    LVar2 := 1;
    if (arg1 == 1) then begin
        return arg0;
    end
    if (arg1 == 0) then begin
        return 1;
    end
    if (arg1 == -1) then begin
        return 1 / arg0;
    end
    if ((arg0 == 2) and (arg1 < 31)) then begin
        if (arg1 < 10) then begin
            if (arg1 < 6) then begin
                if (arg1 == 2) then begin
                    return 4;
                end
                if (arg1 == 3) then begin
                    return 8;
                end
                if (arg1 == 4) then begin
                    return 16;
                end
                if (arg1 == 5) then begin
                    return 32;
                end
            end
            else begin
                if (arg1 == 6) then begin
                    return 64;
                end
                if (arg1 == 7) then begin
                    return 128;
                end
                if (arg1 == 8) then begin
                    return 256;
                end
                if (arg1 == 9) then begin
                    return 512;
                end
            end
        end
        if (arg1 < 20) then begin
            if (arg1 < 16) then begin
                if (arg1 < 13) then begin
                    if (arg1 == 10) then begin
                        return 1024;
                    end
                    if (arg1 == 11) then begin
                        return 2048;
                    end
                    if (arg1 == 12) then begin
                        return 4096;
                    end
                end
                else begin
                    if (arg1 == 13) then begin
                        return 8192;
                    end
                    if (arg1 == 14) then begin
                        return 16384;
                    end
                    if (arg1 == 15) then begin
                        return 32768;
                    end
                end
            end
            else begin
                if (arg1 == 16) then begin
                    return 65536;
                end
                if (arg1 == 17) then begin
                    return 131072;
                end
                if (arg1 == 18) then begin
                    return 262144;
                end
                if (arg1 == 19) then begin
                    return 524288;
                end
            end
        end
        if (arg1 < 31) then begin
            if (arg1 < 26) then begin
                if (arg1 < 23) then begin
                    if (arg1 == 20) then begin
                        return 1048576;
                    end
                    if (arg1 == 21) then begin
                        return 2097152;
                    end
                    if (arg1 == 22) then begin
                        return 4194304;
                    end
                end
                else begin
                    if (arg1 == 23) then begin
                        return 8388608;
                    end
                    if (arg1 == 24) then begin
                        return 16777216;
                    end
                    if (arg1 == 25) then begin
                        return 33554432;
                    end
                end
            end
            else begin
                if (arg1 == 26) then begin
                    return 67108864;
                end
                if (arg1 == 27) then begin
                    return 134217728;
                end
                if (arg1 == 28) then begin
                    return 268435456;
                end
                if (arg1 == 29) then begin
                    return 536870912;
                end
                if (arg1 == 30) then begin
                    return 1073741824;
                end
            end
        end
    end
    LVar3 := arg0;
    if (arg1 > 1) then begin
        while (LVar2 < arg1) do begin
            LVar3 := LVar3 * arg0;
            LVar2 := LVar2 + 1;
        end
        return LVar3;
    end
    if (arg1 < 0) then begin
        while (LVar2 <= (0 - arg1 + 1)) do begin
            LVar3 := LVar3 * arg0;
            LVar2 := LVar2 + 1;
        end
        return 1 / LVar3;
    end
end

procedure has_pairs
begin
    variable LVar0 := 1;
    variable LVar1 := 0;
    while (LVar0 <= 4) do begin
        if ((get_hand(LVar0) - (13 * (((get_hand(LVar0) - 1) / 13) + 1 - 1))) == (get_hand(LVar0 + 1) - (13 * (((get_hand(LVar0 + 1) - 1) / 13) + 1 - 1)))) then begin
            LVar1 := LVar1 + 1;
            if (LVar1 == 1) then begin
                call set_comb(1, LVar0);
                call set_comb(4, LVar0 + 1);
            end
            else begin
                call set_comb(7, LVar0);
                call set_comb(10, LVar0 + 1);
            end
            LVar0 := LVar0 + 1;
        end
        LVar0 := LVar0 + 1;
    end
    return LVar1;
end

procedure has_three
begin
    variable LVar0 := 1;
    while (LVar0 <= 3) do begin
        if (((get_hand(LVar0) - (13 * (((get_hand(LVar0) - 1) / 13) + 1 - 1))) == (get_hand(LVar0 + 1) - (13 * (((get_hand(LVar0 + 1) - 1) / 13) + 1 - 1)))) and ((get_hand(LVar0 + 1) - (13 * (((get_hand(LVar0 + 1) - 1) / 13) + 1 - 1))) == (get_hand(LVar0 + 2) - (13 * (((get_hand(LVar0 + 2) - 1) / 13) + 1 - 1))))) then begin
            call set_comb(13, LVar0);
            call set_comb(15, LVar0 + 1);
            call set_comb(18, LVar0 + 2);
            return 1;
        end
        LVar0 := LVar0 + 1;
    end
end

procedure has_full_house
begin
    if (((get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1))) == (get_hand(2) - (13 * (((get_hand(2) - 1) / 13) + 1 - 1)))) and ((get_hand(2) - (13 * (((get_hand(2) - 1) / 13) + 1 - 1))) == (get_hand(3) - (13 * (((get_hand(3) - 1) / 13) + 1 - 1)))) and ((get_hand(4) - (13 * (((get_hand(4) - 1) / 13) + 1 - 1))) == (get_hand(5) - (13 * (((get_hand(5) - 1) / 13) + 1 - 1))))) then begin
        call set_comb(13, 1);
        call set_comb(15, 2);
        call set_comb(18, 3);
        call set_comb(1, 4);
        call set_comb(4, 5);
        return 1;
    end
    if (((get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1))) == (get_hand(2) - (13 * (((get_hand(2) - 1) / 13) + 1 - 1)))) and ((get_hand(3) - (13 * (((get_hand(3) - 1) / 13) + 1 - 1))) == (get_hand(4) - (13 * (((get_hand(4) - 1) / 13) + 1 - 1)))) and ((get_hand(4) - (13 * (((get_hand(4) - 1) / 13) + 1 - 1))) == (get_hand(5) - (13 * (((get_hand(5) - 1) / 13) + 1 - 1))))) then begin
        call set_comb(13, 3);
        call set_comb(15, 4);
        call set_comb(18, 5);
        call set_comb(1, 1);
        call set_comb(4, 2);
        return 1;
    end
end

procedure Has_four
begin
    if (((get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1))) == (get_hand(2) - (13 * (((get_hand(2) - 1) / 13) + 1 - 1)))) and ((get_hand(2) - (13 * (((get_hand(2) - 1) / 13) + 1 - 1))) == (get_hand(3) - (13 * (((get_hand(3) - 1) / 13) + 1 - 1)))) and ((get_hand(3) - (13 * (((get_hand(3) - 1) / 13) + 1 - 1))) == (get_hand(4) - (13 * (((get_hand(4) - 1) / 13) + 1 - 1))))) then begin
        call set_comb(21, 1);
        call set_comb(23, 2);
        call set_comb(25, 3);
        call set_comb(28, 4);
        return 1;
    end
    if (((get_hand(2) - (13 * (((get_hand(2) - 1) / 13) + 1 - 1))) == (get_hand(3) - (13 * (((get_hand(3) - 1) / 13) + 1 - 1)))) and ((get_hand(3) - (13 * (((get_hand(3) - 1) / 13) + 1 - 1))) == (get_hand(4) - (13 * (((get_hand(4) - 1) / 13) + 1 - 1)))) and ((get_hand(4) - (13 * (((get_hand(4) - 1) / 13) + 1 - 1))) == (get_hand(5) - (13 * (((get_hand(5) - 1) / 13) + 1 - 1))))) then begin
        call set_comb(21, 2);
        call set_comb(23, 3);
        call set_comb(25, 4);
        call set_comb(28, 5);
        return 1;
    end
end

procedure Has_flesh
begin
    variable LVar0 := 1;
    while (((((get_hand(LVar0) - 1) / 13) + 1) == (((get_hand(LVar0 + 1) - 1) / 13) + 1)) and (LVar0 <= 4)) do begin
        LVar0 := LVar0 + 1;
    end
    if (LVar0 == 5) then begin
        return 52 + (((get_hand(1) - 1) / 13) + 1);
    end
    else begin
        return 0;
    end
end

procedure has_straight
begin
    variable LVar0 := 1;
    while (((get_hand(LVar0 + 1) - (13 * (((get_hand(LVar0 + 1) - 1) / 13) + 1 - 1))) == (get_hand(LVar0) - (13 * (((get_hand(LVar0) - 1) / 13) + 1 - 1)) + 1)) and (LVar0 <= 4)) do begin
        LVar0 := LVar0 + 1;
    end
    if (LVar0 == 5) then begin
        return 1;
    end
    else begin
        return 0;
    end
end

procedure give_straight_flesh
begin
    variable LVar0 := 2;
    call get_Card(1, 0, 0);
    if ((get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1))) > 9) then begin
        while (LVar0 <= 5) do begin
            call get_Card(LVar0, get_hand(LVar0 - 1) - (13 * (((get_hand(LVar0 - 1) - 1) / 13) + 1 - 1)) - 1, ((get_hand(1) - 1) / 13) + 1);
            LVar0 := LVar0 + 1;
        end
    end
    else begin
        while (LVar0 <= 5) do begin
            call get_Card(LVar0, get_hand(-1) - (13 * (((get_hand(-1) - 1) / 13) + 1 - 1)) + 1, ((get_hand(1) - 1) / 13) + 1);
            LVar0 := LVar0 + 1;
        end
    end
end

procedure give_four
begin
    call get_Card(1, 0, 0);
    call get_Card(2, 0, 0);
    call get_Card(3, get_hand(2) - (13 * (((get_hand(2) - 1) / 13) + 1 - 1)), 0);
    call get_Card(4, get_hand(2) - (13 * (((get_hand(2) - 1) / 13) + 1 - 1)), 0);
    call get_Card(5, get_hand(2) - (13 * (((get_hand(2) - 1) / 13) + 1 - 1)), 0);
end

procedure give_full_house
begin
    call get_Card(1, 0, 0);
    call get_Card(2, get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1)), 0);
    call get_Card(3, get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1)), 0);
    call get_Card(4, 0, 0);
    call get_Card(5, get_hand(4) - (13 * (((get_hand(4) - 1) / 13) + 1 - 1)), 0);
end

procedure give_flesh
begin
    variable LVar0 := 2;
    call get_Card(1, 0, 0);
    while (LVar0 <= 5) do begin
        call get_Card(LVar0, 0, ((get_hand(1) - 1) / 13) + 1);
        LVar0 := LVar0 + 1;
    end
end

procedure give_straight
begin
    variable LVar0 := 2;
    call get_Card(1, 0, 0);
    if ((get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1))) > 9) then begin
        while (LVar0 <= 5) do begin
            call get_Card(LVar0, get_hand(LVar0 - 1) - (13 * (((get_hand(LVar0 - 1) - 1) / 13) + 1 - 1)) - 1, 0);
            LVar0 := LVar0 + 1;
        end
    end
    else begin
        while (LVar0 <= 5) do begin
            call get_Card(LVar0, get_hand(-1) - (13 * (((get_hand(-1) - 1) / 13) + 1 - 1)) + 1, 0);
            LVar0 := LVar0 + 1;
        end
    end
end

procedure give_three
begin
    call get_Card(1, 0, 0);
    call get_Card(2, get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1)), 0);
    call get_Card(3, get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1)), 0);
    call get_Card(4, 0, 0);
    call get_Card(5, 0, 0);
end

procedure give_two_pairs
begin
    call get_Card(1, 0, 0);
    call get_Card(2, get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1)), 0);
    call get_Card(3, 0, 0);
    call get_Card(4, get_hand(3) - (13 * (((get_hand(3) - 1) / 13) + 1 - 1)), 0);
    call get_Card(5, 0, 0);
end

procedure give_pair
begin
    call get_Card(1, 0, 0);
    call get_Card(2, get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1)), 0);
    call get_Card(3, 0, 0);
    call get_Card(4, 0, 0);
    call get_Card(5, 0, 0);
end

procedure Start_Game_Dialog(variable arg0)
begin
    if (NPC1 == 0) then begin
        gsay_reply(1360, 250);
        gsay_option(1360, 108, Node999, -1);
    end
    else begin
        if ((get_cash(dealer) > bet) and (get_cash(NPC1) > bet)) then begin
            if (((total_cash_on_map_enter - (get_cash(dealer) + get_cash(NPC1))) >= 200) or (get_total_win() >= 200)) then begin
                if (days_since_visited < 1) then begin
                    gsay_reply(1360, 248);
                end
                else begin
                    gsay_reply(1360, message_str(1360, 249) + generate_days());
                end
            end
            else begin
                if (not(arg0)) then begin
                    gsay_reply(1360, message_str(1360, random(235, 237)) + pl_gender() + message_str(1360, random(261, 263)) + generate_ending(bet, 139) + message_str(1360, random(238, 240)) + generate_ending(bet / bet, 139) + message_str(1360, random(241, 243)) + (2 * 10 * bet) + message_str(1360, 113));
                end
                else begin
                    gsay_reply(1360, message_str(1360, random(244, 246)));
                end
                if (get_critter_stat(dude_obj, 4) < 4) then begin
                    gsay_option(1360, 251, Node_Dumb, -1);
                    gsay_option(1360, 252, Node_Dumb, -1);
                end
                else begin
                    if (get_cash(dude_obj) > bet) then begin
                        if (not(arg0)) then begin
                            gsay_option(1360, 303, NodePokerStart, -1);
                        end
                        else begin
                            gsay_option(1360, 106, NodePokerStart, -1);
                        end
                        if ((bet == 5) and (item_caps_total(dude_obj) >= 200)) then begin
                            gsay_option(1360, 330, NodeP_BigGame, -1);
                        end
                        if (bet == 10) then begin
                            gsay_option(1360, 331, NodeP_NormalGame, -1);
                        end
                    end
                    else begin
                        gsay_option(1360, 302, Node999, -1);
                    end
                end
            end
            if (get_critter_stat(dude_obj, 4) > 3) then begin
                if (((total_cash_on_map_enter - (get_cash(dealer) + get_cash(NPC1))) >= 200) or (get_total_win() >= 200)) then begin
                    gsay_option(1360, 304, Node999, -1);
                end
                else begin
                    if (not(arg0)) then begin
                        gsay_option(1360, 301, Node999, -1);
                    end
                    else begin
                        gsay_option(1360, 309, Poker_End_Seq, -1);
                    end
                end
            end
        end
        else begin
            gsay_reply(1360, 207);
            gsay_option(1360, 222, Node999, -1);
        end
    end
end

procedure Poker_End_Seq
begin
    if ((total_cash_on_map_enter - (get_cash(dealer) + get_cash(NPC1))) > 0) then begin
        call set_total_win(get_total_win() + (total_cash_on_map_enter - (get_cash(dealer) + get_cash(NPC1))));
    end
    call Node999();
end

procedure NodeP_Begin
begin
    call Start_Game_Dialog(0);
end

procedure NodeP_BigGame
begin
    bet := 10;
    gsay_reply(1360, 219);
    gsay_option(1360, 108, NodeP_Begin, -1);
end

procedure NodeP_NormalGame
begin
    bet := 5;
    gsay_reply(1360, 220);
    gsay_option(1360, 108, NodeP_Begin, -1);
end

procedure NodePokerStart
begin
    stash := 0;
    pl_cash := item_caps_total(dude_obj);
    call mod_cash(dude_obj, -bet);
    call mod_cash(dealer, -bet);
    call mod_cash(NPC1, -bet);
    gsay_reply(1360, "[" + obj_name(dealer) + message_str(1360, 101));
    call Shuffle_Deck();
    gsay_option(1360, 105, NodeP_PlayerViewCards, -1);
end

procedure NodeP_PlayerViewCards
begin
    call setDeck(dude_obj);
    call Sort_By_Color();
    gsay_reply(1360, message_str(1360, 305) + message_str(1360, get_hand(1)) + ", " + message_str(1360, get_hand(2)) + ", " + message_str(1360, get_hand(3)) + ", " + message_str(1360, get_hand(4)) + message_str(1360, 118) + message_str(1360, get_hand(5)) + "]");
    call Sort();
    gsay_option(1360, "[" + message_str(1360, 112) + showComb(dude_obj) + "]", NodeP_DealerChangeCards, -1);
    if (not(pl_change_done)) then begin
        gsay_option(1360, 306, NodeP_PlayerChangeCard, -1);
    end
end

procedure NodeP_PlayerChangeCard
begin
    gsay_reply(1360, pr_npc(dealer) + message_str(1360, 247));
    gsay_option(1360, message_str(1360, 132) + message_str(1360, 130), Player_Change_1_Card, -1);
    gsay_option(1360, message_str(1360, 133) + message_str(1360, 131), Player_Change_2_Card, -1);
    gsay_option(1360, message_str(1360, 134) + message_str(1360, 131), Player_Change_3_Card, -1);
    gsay_option(1360, message_str(1360, 135), NodeP_PlayerViewCards, -1);
end

procedure Done_change_cards
begin
    variable LVar0 := 1;
    variable LVar1 := 0;
    variable LVar2 := 0;
    if (pl_change_done == 1) then begin
        while (LVar0 <= 5) do begin
            if (get_was_changed(LVar0)) then begin
                gsay_reply(1360, message_str(1360, 310) + message_str(1360, get_hand(LVar0)) + message_str(1360, 113) + "]");
                LVar0 := 6;
            end
            LVar0 := LVar0 + 1;
        end
    end
    else begin
        if (pl_change_done == 2) then begin
            while (LVar0 <= 5) do begin
                LVar1 := LVar0 + 1;
                while (LVar1 <= 5) do begin
                    if (get_was_changed(LVar0) and get_was_changed(LVar1)) then begin
                        gsay_reply(1360, message_str(1360, 310) + message_str(1360, get_hand(LVar0)) + message_str(1360, 118) + message_str(1360, get_hand(LVar1)) + message_str(1360, 113) + "]");
                        LVar0 := 6;
                        LVar1 := 6;
                    end
                    LVar1 := LVar1 + 1;
                end
                LVar0 := LVar0 + 1;
            end
        end
        else begin
            while (LVar0 <= 5) do begin
                LVar1 := LVar0 + 1;
                while (LVar1 <= 5) do begin
                    LVar2 := LVar1 + 1;
                    while (LVar2 <= 5) do begin
                        if (get_was_changed(LVar0) and get_was_changed(LVar1) and get_was_changed(LVar2)) then begin
                            gsay_reply(1360, message_str(1360, 310) + message_str(1360, get_hand(LVar0)) + ", " + message_str(1360, get_hand(LVar1)) + message_str(1360, 118) + message_str(1360, get_hand(LVar2)) + message_str(1360, 113) + "]");
                            LVar0 := 6;
                            LVar1 := 6;
                            LVar2 := 6;
                        end
                        LVar2 := LVar2 + 1;
                    end
                    LVar1 := LVar1 + 1;
                end
                LVar0 := LVar0 + 1;
            end
        end
    end
    gsay_option(1360, 108, NodeP_PlayerViewCards, -1);
end

procedure Player_Change_1_Card
begin
    pl_change_done := 1;
    call Show_change_cards();
end

procedure Player_Change_2_Card
begin
    pl_change_done := 2;
    call Show_change_cards();
end

procedure Player_Change_3_Card
begin
    pl_change_done := 3;
    call Show_change_cards();
end

procedure Show_change_cards
begin
    gsay_reply(1360, 221);
    if (not(get_was_changed(1))) then begin
        gsay_option(1360, message_str(1360, 307) + message_str(1360, get_hand(1)), NodeChange1, -1);
    end
    if (not(get_was_changed(2))) then begin
        gsay_option(1360, message_str(1360, 307) + message_str(1360, get_hand(2)), NodeChange2, -1);
    end
    if (not(get_was_changed(3))) then begin
        gsay_option(1360, message_str(1360, 307) + message_str(1360, get_hand(3)), NodeChange3, -1);
    end
    if (not(get_was_changed(4))) then begin
        gsay_option(1360, message_str(1360, 307) + message_str(1360, get_hand(4)), NodeChange4, -1);
    end
    if (not(get_was_changed(5))) then begin
        gsay_option(1360, message_str(1360, 307) + message_str(1360, get_hand(5)), NodeChange5, -1);
    end
end

procedure player_change_card(variable arg0)
begin
    call ChangeCard(dude_obj, arg0);
    if (num_changes != pl_change_done) then begin
        call Show_change_cards();
    end
    else begin
        if (pl_change_done == 1) then begin
            gsay_reply(1360, message_str(1360, 334) + pl_change_done + message_str(1360, 130) + message_str(1360, 118) + obj_name(dealer) + message_str(1360, 335));
        end
        else begin
            gsay_reply(1360, message_str(1360, 334) + pl_change_done + message_str(1360, 131) + message_str(1360, 118) + obj_name(dealer) + message_str(1360, 335));
        end
        gsay_option(1360, 308, Done_change_cards, -1);
    end
end

procedure NodeChange1
begin
    call player_change_card(1);
end

procedure NodeChange2
begin
    call player_change_card(2);
end

procedure NodeChange3
begin
    call player_change_card(3);
end

procedure NodeChange4
begin
    call player_change_card(4);
end

procedure NodeChange5
begin
    call player_change_card(5);
end

procedure NodeP_DealerChangeCards
begin
    call npc_change_cards(dealer);
end

procedure NodeP_NPC1ChangeCards
begin
    call npc_change_cards(NPC1);
end

procedure NodeP_Barter
begin
    if ((step == 1) and get_pass(dealer)) then begin
        step := 2;
    end
    if ((step == 2) and get_pass(NPC1)) then begin
        step := 0;
    end
    if (step == 0) then begin
        call set_try_open(dealer, 0);
        call set_try_open(NPC1, 0);
        if (((2 * 10 * bet) - stash) > (bet / bet * 2)) then begin
            gsay_reply(1360, "[" + message_str(1360, 208) + generate_ending(stash, 139) + message_str(1360, 209) + " " + message_str(1360, 112) + showComb(dude_obj) + "]");
        end
        else begin
            gsay_reply(1360, "[" + message_str(1360, 103) + generate_ending(stash, 139) + message_str(1360, 104) + " " + message_str(1360, 112) + showComb(dude_obj) + "]");
        end
        if (not(dealer_check or dealer_pass)) then begin
            gsay_option(1360, message_str(1360, 325) + obj_name(dealer) + message_str(1360, 326), NodeCheckDealer, -1);
        end
        if (not(npc1_check or npc1_pass)) then begin
            gsay_option(1360, message_str(1360, 325) + obj_name(NPC1) + message_str(1360, 326), NodeCheckNPC1, -1);
        end
        if (not(try_open)) then begin
            gsay_option(1360, 129, NodeP_Open, -1);
        end
        if (stash < (2 * 10 * bet)) then begin
            if ((get_cash(dude_obj) > (bet / bet)) and ((bet / bet) <= (((2 * 10 * bet) - stash) / 2))) then begin
                gsay_option(1360, message_str(1360, 328) + generate_ending(bet / bet, 139) + message_str(1360, 329) + (stash + (bet / bet)), Add10, -1);
            end
            if ((get_cash(dude_obj) > (bet / 2)) and ((bet / 2) <= (((2 * 10 * bet) - stash) / 2))) then begin
                gsay_option(1360, message_str(1360, 328) + generate_ending(bet / 2, 139) + message_str(1360, 329) + (stash + (bet / 2)), Add20, -1);
            end
            if ((get_cash(dude_obj) > bet) and (bet <= (((2 * 10 * bet) - stash) / 2))) then begin
                gsay_option(1360, message_str(1360, 328) + generate_ending(bet, 139) + message_str(1360, 329) + (stash + bet), Add50, -1);
            end
            if ((get_cash(dude_obj) > (2 * bet)) and ((2 * bet) <= (((2 * 10 * bet) - stash) / 2))) then begin
                gsay_option(1360, message_str(1360, 328) + generate_ending(2 * bet, 139) + message_str(1360, 329) + (stash + (2 * bet)), Add100, -1);
            end
        end
        gsay_option(1360, 324, NodeP_PlayerPass, -1);
    end
    else begin
        if (step == 1) then begin
            step := 2;
            gsay_reply(1360, message_str(1360, 227) + obj_name(dealer) + message_str(1360, 228));
            gsay_option(1360, 108, NodeP_BarterDealer, -1);
        end
        else begin
            if (step == 2) then begin
                step := 0;
                gsay_reply(1360, message_str(1360, 227) + obj_name(NPC1) + message_str(1360, 228));
                gsay_option(1360, 108, NodeP_BarterNPC1, -1);
            end
        end
    end
end

procedure NodeP_BarterDealer
begin
    call npc_do_barter(dealer);
end

procedure NodeP_BarterNPC1
begin
    call npc_do_barter(NPC1);
end

procedure NodeP_PlayerPass
begin
    variable LVar0 := 0;
    LVar0 := stash;
    if (get_pass(dealer)) then begin
        call mod_cash(NPC1, stash);
        gsay_reply(1360, message_str(1360, 116) + obj_name(NPC1) + message_str(1360, 229) + generate_ending(LVar0, 139) + message_str(1360, 230));
    end
    else begin
        if (get_pass(NPC1)) then begin
            call mod_cash(dealer, stash);
            gsay_reply(1360, message_str(1360, 116) + obj_name(dealer) + message_str(1360, 229) + generate_ending(LVar0, 139) + message_str(1360, 230));
        end
        else begin
            if (checkComb(dealer) >= checkComb(NPC1)) then begin
                call mod_cash(dealer, stash);
                gsay_reply(1360, message_str(1360, 116) + obj_name(dealer) + message_str(1360, 118) + obj_name(NPC1) + message_str(1360, 117) + obj_name(dealer) + message_str(1360, 229) + generate_ending(LVar0, 139) + message_str(1360, 230));
            end
            else begin
                call mod_cash(NPC1, stash);
                gsay_reply(1360, message_str(1360, 116) + obj_name(dealer) + message_str(1360, 118) + obj_name(NPC1) + message_str(1360, 117) + obj_name(NPC1) + message_str(1360, 229) + generate_ending(LVar0, 139) + message_str(1360, 230));
            end
        end
    end
    gsay_option(1360, 108, NodeP_Again, -1);
end

procedure NodeP_PlayerAccept
begin
    variable LVar0 := 0;
    if (step == 2) then begin
        call mod_cash(dude_obj, -get_bet(dealer));
        LVar0 := NPC1;
    end
    else begin
        call mod_cash(dude_obj, -get_bet(NPC1));
        LVar0 := dealer;
    end
    if (get_pass(LVar0)) then begin
        call NodeP_Barter();
    end
    else begin
        if (NPCBarter(LVar0) and (get_cash(LVar0) > get_bet(other_npc(LVar0)))) then begin
            gsay_reply(1360, pr_npc(LVar0) + message_str(1360, 115));
            call mod_cash(LVar0, -get_bet(other_npc(LVar0)));
            gsay_option(1360, 108, NodeP_Barter, -1);
        end
        else begin
            gsay_reply(1360, pr_npc(LVar0) + message_str(1360, 114));
            call set_pass(LVar0);
            gsay_option(1360, 108, NodeP_Barter, -1);
        end
    end
end

procedure NodeP_NPCPass
begin
    gsay_reply(1360, 213);
    item_caps_adjust(dude_obj, stash);
    gsay_option(1360, message_str(1360, 322) + generate_ending(item_caps_total(dude_obj) - pl_cash, 139) + message_str(1360, 323), NodeP_Again, -1);
end

procedure NodeCheckDealer
begin
    dealer_check := 1;
    call Check_Partner(dealer);
end

procedure NodeCheckNPC1
begin
    npc1_check := 1;
    call Check_Partner(NPC1);
end

procedure Check_Partner(variable arg0)
begin
    variable LVar1 := 0;
    LVar1 := check_partner_comb(dude_obj, arg0);
    if (LVar1 == 5) then begin
        gsay_reply(1360, 321);
    end
    else begin
        if (LVar1 == 6) then begin
            gsay_reply(1360, 332);
        end
        else begin
            if (LVar1 == 7) then begin
                gsay_reply(1360, 333);
            end
            else begin
                if (LVar1 == 4) then begin
                    gsay_reply(1360, 317);
                end
                else begin
                    if (LVar1 == 3) then begin
                        gsay_reply(1360, 318);
                    end
                    else begin
                        if (LVar1 == 2) then begin
                            gsay_reply(1360, 319);
                        end
                        else begin
                            if (LVar1 <= 1) then begin
                                gsay_reply(1360, 320);
                            end
                        end
                    end
                end
            end
        end
    end
    gsay_option(1360, 108, NodeP_Barter, -1);
end

procedure Show_Dealer_cards
begin
    gsay_reply(1360, pr_npc(dealer) + message_str(1360, 112) + showComb(dealer) + message_str(1360, 113));
    if (get_pass(NPC1)) then begin
        gsay_option(1360, 108, NodeP_CompareEnd, -1);
    end
    else begin
        gsay_option(1360, 108, Show_NPC1_cards, -1);
    end
end

procedure Show_NPC1_cards
begin
    gsay_reply(1360, pr_npc(NPC1) + message_str(1360, 112) + showComb(NPC1) + message_str(1360, 113));
    gsay_option(1360, 108, NodeP_CompareEnd, -1);
end

procedure NodeP_CompareEnd
begin
    variable LVar0 := 0;
    variable LVar1 := 0;
    variable LVar2 := 0;
    variable LVar3 := 0;
    variable LVar4 := 0;
    variable LVar5 := 0;
    variable LVar6 := 0;
    LVar6 := stash;
    LVar3 := checkComb(dude_obj);
    if (get_pass(dealer)) then begin
        LVar0 := NPC1;
    end
    else begin
        if (get_pass(NPC1)) then begin
            LVar0 := dealer;
        end
        else begin
            LVar0 := 0;
        end
    end
    if (LVar0) then begin
        LVar5 := checkComb(LVar0);
        if (LVar3 < LVar5) then begin
            call mod_cash(LVar0, stash);
            gsay_reply(1360, pr_npc(dealer) + message_str(1360, 231) + obj_name(LVar0) + message_str(1360, 113));
            gsay_option(1360, message_str(1360, 315) + message_str(1360, 110) + generate_ending(LVar6, 139) + message_str(1360, 111), NodeP_Again, -1);
        end
        else begin
            if (LVar3 > LVar5) then begin
                call mod_cash(dude_obj, stash);
                gsay_reply(1360, pr_npc(dealer) + message_str(1360, 231) + obj_name(dude_obj) + message_str(1360, 113));
                gsay_option(1360, message_str(1360, 313) + message_str(1360, 110) + generate_ending(LVar6, 139) + message_str(1360, 111), NodeP_Again, -1);
            end
            else begin
                item_caps_adjust(dude_obj, stash / 2);
                call mod_cash(LVar0, stash / 2);
                item_caps_adjust(dude_obj, stash - (stash / 2 * 2));
                gsay_reply(1360, pr_npc(dealer) + obj_name(dude_obj) + message_str(1360, 118) + obj_name(LVar0) + message_str(1360, 119) + message_str(1360, 121) + message_str(1360, 120));
                gsay_option(1360, message_str(1360, 314) + message_str(1360, 110) + generate_ending(stash, 139) + message_str(1360, 111), NodeP_Again, -1);
            end
        end
    end
    else begin
        LVar5 := checkComb(NPC1);
        LVar4 := checkComb(dealer);
        if ((LVar4 == LVar5) and (LVar4 == LVar3)) then begin
            item_caps_adjust(dude_obj, (stash / 3) + (stash % 3));
            call mod_cash(NPC1, stash / 3);
            call mod_cash(dealer, stash / 3);
            item_caps_adjust(dude_obj, stash);
            gsay_reply(1360, pr_npc(dealer) + message_str(1360, 232) + message_str(1360, 119) + message_str(1360, 122) + message_str(1360, 120));
            gsay_option(1360, message_str(1360, 314) + message_str(1360, 110) + generate_ending(stash, 139) + message_str(1360, 111), NodeP_Again, -1);
        end
        else begin
            if ((LVar3 > LVar4) and (LVar3 > LVar5)) then begin
                LVar0 := dude_obj;
            end
            else begin
                if ((LVar4 > LVar3) and (LVar4 > LVar5)) then begin
                    LVar0 := dealer;
                end
                else begin
                    if ((LVar5 > LVar3) and (LVar5 > LVar4)) then begin
                        LVar0 := NPC1;
                    end
                    else begin
                        if (LVar3 == LVar5) then begin
                            LVar1 := dude_obj;
                            LVar2 := NPC1;
                        end
                        else begin
                            if (LVar3 == LVar4) then begin
                                LVar1 := dude_obj;
                                LVar2 := dealer;
                            end
                            else begin
                                LVar1 := dealer;
                                LVar2 := NPC1;
                            end
                        end
                    end
                end
            end
            if (LVar0) then begin
                gsay_reply(1360, pr_npc(dealer) + message_str(1360, 231) + obj_name(LVar0) + message_str(1360, 113));
                call mod_cash(LVar0, stash);
                if (LVar0 == dude_obj) then begin
                    gsay_option(1360, message_str(1360, 313) + message_str(1360, 110) + generate_ending(LVar6, 139) + message_str(1360, 111), NodeP_Again, -1);
                end
                else begin
                    gsay_option(1360, message_str(1360, 315) + message_str(1360, 110) + generate_ending(LVar6, 139) + message_str(1360, 111), NodeP_Again, -1);
                end
            end
            else begin
                gsay_reply(1360, pr_npc(dealer) + message_str(1360, 142) + obj_name(LVar1) + message_str(1360, 118) + obj_name(LVar2) + message_str(1360, 119) + message_str(1360, 121) + message_str(1360, 120));
                call mod_cash(LVar1, (stash / 2) + (stash % 2));
                call mod_cash(LVar2, stash / 2);
                if ((LVar1 == dude_obj) or (LVar2 == dude_obj)) then begin
                    gsay_option(1360, message_str(1360, 314) + message_str(1360, 110) + generate_ending(LVar6, 139) + message_str(1360, 111), NodeP_Again, -1);
                end
                else begin
                    gsay_option(1360, message_str(1360, 315) + message_str(1360, 110) + generate_ending(LVar6, 139) + message_str(1360, 111), NodeP_Again, -1);
                end
            end
        end
    end
end

procedure NodePokerDoCompare
begin
    if (get_pass(dealer)) then begin
        call Show_NPC1_cards();
    end
    else begin
        call Show_Dealer_cards();
    end
end

procedure check_open(variable arg0)
begin
    variable LVar1 := 0;
    variable LVar2 := 0;
    variable LVar3 := 0;
    LVar1 := check_partner_comb(arg0, dude_obj);
    if (not(get_pass(other_npc(arg0)))) then begin
        LVar3 := check_partner_comb(arg0, other_npc(arg0));
    end
    else begin
        LVar3 := 0;
    end
    LVar2 := comb_value(arg0);
    if (((2 * 10 * bet) - stash) < (2 * bet / bet)) then begin
        return 1;
    end
    if (LVar2 == 0) then begin
        return 1;
    end
    if ((LVar1 > 4) and (LVar3 > 4)) then begin
        if (stash >= (LVar2 * 5 * bet)) then begin
            return 1;
        end
        else begin
            return 0;
        end
    end
    else begin
        if (LVar1 > 4) then begin
            if (LVar3 != 0) then begin
                if (LVar2 <= LVar3) then begin
                    return 1;
                end
                else begin
                    if (stash > (((2 * LVar2) - LVar3) * 5 * bet)) then begin
                        return 1;
                    end
                    else begin
                        return 0;
                    end
                end
            end
            else begin
                if (stash >= (LVar2 * 5 * bet)) then begin
                    return 1;
                end
                else begin
                    return 0;
                end
            end
        end
        else begin
            if (LVar3 > 4) then begin
                if (LVar2 <= LVar1) then begin
                    return 1;
                end
                else begin
                    if (stash > (((2 * LVar2) - LVar1) * 5 * bet)) then begin
                        return 1;
                    end
                    else begin
                        return 0;
                    end
                end
            end
            else begin
                if ((LVar3 == LVar2) and (LVar1 == LVar2)) then begin
                    return 1;
                end
                else begin
                    if ((LVar3 > LVar2) or (LVar1 > LVar2)) then begin
                        return 1;
                    end
                    else begin
                        return 0;
                    end
                end
            end
        end
    end
end

procedure NodeP_Open
begin
    try_open := 1;
    if (dealer_pass) then begin
        call NodeP_NPC1Open();
    end
    else begin
        if (check_open(dealer)) then begin
            gsay_reply(1360, pr_npc(dealer) + message_str(1360, random(123, 125)));
            if (not(get_pass(NPC1))) then begin
                gsay_option(1360, 108, NodeP_NPC1Open, -1);
            end
            else begin
                gsay_option(1360, 108, NodePokerDoCompare, -1);
            end
        end
        else begin
            gsay_reply(1360, pr_npc(dealer) + message_str(1360, random(126, 128)));
            gsay_option(1360, 108, NodeP_Barter, -1);
        end
    end
end

procedure NodeP_NPC1Open
begin
    if (get_pass(NPC1)) then begin
        call NodeP_Barter();
    end
    if (check_open(NPC1)) then begin
        gsay_reply(1360, pr_npc(NPC1) + message_str(1360, random(123, 125)));
        gsay_option(1360, 108, NodePokerDoCompare, -1);
    end
    else begin
        gsay_reply(1360, pr_npc(NPC1) + message_str(1360, random(126, 128)));
        gsay_option(1360, 108, NodeP_Barter, -1);
    end
end

procedure Node_Dumb
begin
    gsay_reply(1360, message_str(1360, 253));
    gsay_option(1360, 254, Node999, -1);
end

procedure Node999
begin
end

procedure get_Deck(variable arg0)
begin
    if (arg0 < 31) then begin
        return (local_var(0) bwand pow(2, arg0 - 1)) != 0;
    end
    else begin
        return (local_var(1) bwand pow(2, arg0 - 31)) != 0;
    end
end

procedure get_was_changed(variable arg0)
begin
    if ((local_var(1) bwand pow(2, 21 + arg0)) != 0) then begin
        return 1;
    end
    else begin
        return 0;
    end
end

procedure set_hand(variable arg0, variable arg1)
begin
    variable LVar2 := 5;
    variable LVar3 := 0;
    variable LVar4 := 32;
    LVar3 := (6 * arg0) - 1;
    while (LVar2 >= 0) do begin
        if ((arg1 / LVar4) != 0) then begin
            set_local_var(hand, local_var(hand) bwor pow(2, LVar3 - LVar2));
            arg1 := arg1 - LVar4;
        end
        else begin
            set_local_var(hand, local_var(hand) bwand (-1 - pow(2, LVar3 - LVar2)));
        end
        LVar4 := LVar4 / 2;
        LVar2 := LVar2 - 1;
    end
end

procedure get_hand(variable arg0)
begin
    variable LVar1 := 0;
    variable LVar2 := 0;
    variable LVar3 := 0;
    variable LVar4 := 1;
    LVar3 := (6 * arg0) - 1;
    while (LVar1 <= 5) do begin
        if ((local_var(hand) bwand pow(2, LVar3 - LVar1)) != 0) then begin
            LVar2 := LVar2 + LVar4;
        end
        LVar4 := LVar4 * 2;
        LVar1 := LVar1 + 1;
    end
    return LVar2;
end

procedure set_comb(variable arg0, variable arg1)
begin
    variable LVar2 := 2;
    if ((arg0 == 13) or (arg0 == 21) or (arg0 == 23)) then begin
        LVar2 := 1;
        for (/* O_NOOP */; LVar2 >= 0; LVar2 := LVar2 - 1) begin
            if ((arg1 / pow(2, LVar2)) != 0) then begin
                set_local_var(5, local_var(5) bwor pow(2, arg0 + LVar2));
                arg1 := arg1 - pow(2, LVar2);
                continue;
            end
            set_local_var(5, local_var(5) bwand (-1 - pow(2, arg0 + LVar2)));
        end
    end

procedure get_comb(variable arg0)
begin
    variable LVar1 := 2;
    variable LVar2 := 0;
    if ((arg0 == 13) or (arg0 == 21) or (arg0 == 23)) then begin
        LVar1 := 1;
    end
    while (LVar1 >= 0) do begin
        if ((local_var(5) bwand pow(2, arg0 + LVar1)) != 0) then begin
            LVar2 := LVar2 + pow(2, LVar1);
        end
        LVar1 := LVar1 - 1;
    end
    return LVar2;
end

procedure clean_hands
begin
    variable LVar0 := 0;
    while (LVar0 < 31) do begin
        set_local_var(2, local_var(2) bwand (-1 - pow(2, LVar0)));
        set_local_var(3, local_var(3) bwand (-1 - pow(2, LVar0)));
        set_local_var(4, local_var(4) bwand (-1 - pow(2, LVar0)));
        LVar0 := LVar0 + 1;
    end
end

procedure get_cash1(variable arg0)
begin
    variable LVar1 := 0;
    variable LVar2 := 0;
    variable LVar3 := 0;
    if (arg0 == NPC1) then begin
        LVar3 := 10;
    end
    while (LVar1 < 10) do begin
        if ((local_var(6) bwand pow(2, LVar1 + LVar3)) != 0) then begin
            LVar2 := LVar2 + pow(2, LVar1);
        end
        LVar1 := LVar1 + 1;
    end
    return LVar2;
end

procedure set_cash(variable arg0, variable arg1)
begin
    variable LVar2 := 0;
    variable LVar3 := 0;
    variable LVar4 := 0;
    variable LVar5 := 0;
    variable LVar6 := 0;
    if (arg0 == NPC1) then begin
        LVar4 := 10;
    end
    for (LVar2 := 9; LVar2 >= 0; LVar2 := LVar2 - 1) begin
        LVar5 := pow(2, LVar2);
        LVar6 := pow(2, LVar2 + LVar4);
        if ((arg1 / LVar5) != 0) then begin
            set_local_var(6, local_var(6) bwor LVar6);
            arg1 := arg1 - LVar5;
            continue;
        end
        set_local_var(6, local_var(6) bwand (-1 - LVar6));
    end
end

procedure get_total_win
begin
    variable LVar0 := 0;
    variable LVar1 := 0;
    while (LVar0 < 10) do begin
        if ((local_var(6) bwand pow(2, LVar0 + 20)) != 0) then begin
            LVar1 := LVar1 + pow(2, LVar0);
        end
        LVar0 := LVar0 + 1;
    end
    return LVar1;
end

procedure set_total_win(variable arg0)
begin
    variable LVar1 := 9;
    variable LVar2 := 0;
    variable LVar3 := 0;
    for (0; LVar1 >= 0; LVar1 := LVar1 - 1) begin
        LVar3 := pow(2, LVar1);
        LVar4 := pow(2, LVar1 + 20);
        if ((arg0 / LVar3) != 0) then begin
            set_local_var(6, local_var(6) bwor LVar4);
            arg0 := arg0 - LVar3;
            continue;
        end
        set_local_var(6, local_var(6) bwand (-1 - LVar4));
    end
end

procedure get_Card(variable arg0, variable arg1, variable arg2)
begin
    variable LVar3 := 0;
    variable LVar4 := 1;
    LVar3 := random(1, 52);
    if (arg2 and arg1) then begin
        if (get_Deck(arg1 + (13 * (arg2 - 1))) == 0) then begin
            while (get_Deck(LVar3) == 0) do begin
                LVar3 := random(1, 52);
            end
            if (LVar3 < 31) then begin
                set_local_var(0, local_var(0) bwand (-1 - pow(2, LVar3 - 1)));
            end
            else begin
                set_local_var(1, local_var(1) bwand (-1 - pow(2, LVar3 - 31)));
            end
            call set_hand(arg0, LVar3);
        end
        else begin
            while ((get_Deck(LVar3) == 0) or ((((LVar3 - 1) / 13) + 1) != arg2) or ((LVar3 - (13 * (((LVar3 - 1) / 13) + 1 - 1))) != arg1)) do begin
                LVar3 := random(1, 52);
            end
            if (LVar3 < 31) then begin
                set_local_var(0, local_var(0) bwand (-1 - pow(2, LVar3 - 1)));
            end
            else begin
                set_local_var(1, local_var(1) bwand (-1 - pow(2, LVar3 - 31)));
            end
            call set_hand(arg0, LVar3);
        end
    end
    else begin
        if ((arg2 == 0) and arg1) then begin
            if ((get_Deck(arg1) == 0) and (get_Deck(arg1 + 13) == 0) and (get_Deck(arg1 + 26) == 0) and (get_Deck(arg1 + 39) == 0)) then begin
                while (get_Deck(LVar3) == 0) do begin
                    LVar3 := random(1, 52);
                end
                if (LVar3 < 31) then begin
                    set_local_var(0, local_var(0) bwand (-1 - pow(2, LVar3 - 1)));
                end
                else begin
                    set_local_var(1, local_var(1) bwand (-1 - pow(2, LVar3 - 31)));
                end
                call set_hand(arg0, LVar3);
            end
            else begin
                while ((get_Deck(LVar3) == 0) or ((LVar3 - (13 * (((LVar3 - 1) / 13) + 1 - 1))) != arg1)) do begin
                    LVar3 := random(1, 52);
                end
                if (LVar3 < 31) then begin
                    set_local_var(0, local_var(0) bwand (-1 - pow(2, LVar3 - 1)));
                end
                else begin
                    set_local_var(1, local_var(1) bwand (-1 - pow(2, LVar3 - 31)));
                end
                call set_hand(arg0, LVar3);
            end
        end
        else begin
            if ((arg1 == 0) and arg2) then begin
                while ((get_Deck(LVar3) == 0) or ((((LVar3 - 1) / 13) + 1) != arg2)) do begin
                    LVar3 := random(1, 52);
                end
                if (LVar3 < 31) then begin
                    set_local_var(0, local_var(0) bwand (-1 - pow(2, LVar3 - 1)));
                end
                else begin
                    set_local_var(1, local_var(1) bwand (-1 - pow(2, LVar3 - 31)));
                end
                call set_hand(arg0, LVar3);
            end
            else begin
                while (get_Deck(LVar3) == 0) do begin
                    LVar3 := random(1, 52);
                end
                if (LVar3 < 31) then begin
                    set_local_var(0, local_var(0) bwand (-1 - pow(2, LVar3 - 1)));
                end
                else begin
                    set_local_var(1, local_var(1) bwand (-1 - pow(2, LVar3 - 31)));
                end
                call set_hand(arg0, LVar3);
            end
        end
    end
end

procedure setDeck(variable arg0)
begin
    if (arg0 == self_obj) then begin
        hand := 3;
    end
    else begin
        if (arg0 == dude_obj) then begin
            hand := 2;
        end
        else begin
            hand := 4;
        end
    end
end

procedure Sort
begin
    variable LVar0 := 0;
    variable LVar1 := 1;
    variable LVar2 := 0;
    while (LVar1 <= 5) do begin
        for (LVar2 := LVar1 + 1; LVar2 <= 5; LVar2 := LVar2 + 1) begin
            if ((get_hand(LVar1) - (13 * (((get_hand(LVar1) - 1) / 13) + 1 - 1))) > (get_hand(LVar2) - (13 * (((get_hand(LVar2) - 1) / 13) + 1 - 1)))) then begin
                LVar0 := get_hand(LVar1);
                call set_hand(LVar1, get_hand(LVar2));
                call set_hand(LVar2, LVar0);
                if (not(get_was_changed(LVar1) == get_was_changed(LVar2))) then begin
                    if (get_was_changed(LVar1)) then begin
                        set_local_var(1, local_var(1) bwor pow(2, 21 + LVar2));
                        set_local_var(1, local_var(1) bwand (-1 - pow(2, 21 + LVar1)));
                        continue;
                    end
                    set_local_var(1, local_var(1) bwor pow(2, 21 + LVar1));
                    set_local_var(1, local_var(1) bwand (-1 - pow(2, 21 + LVar2)));
                end
            end
        end
        LVar1 := LVar1 + 1;
    end
end

procedure Sort_By_Color
begin
    variable LVar0 := 1;
    variable LVar1 := 0;
    variable LVar2 := 0;
    variable LVar3 := 0;
    while (LVar0 <= 5) do begin
        for (LVar1 := LVar0 + 1; LVar1 <= 5; LVar1 := LVar1 + 1) begin
            LVar2 := get_hand(LVar0);
            LVar3 := get_hand(LVar1);
            if (LVar2 > LVar3) then begin
                call set_hand(LVar1, LVar2);
                call set_hand(LVar0, LVar3);
                if (not(get_was_changed(LVar0) == get_was_changed(LVar1))) then begin
                    if (get_was_changed(LVar0)) then begin
                        set_local_var(1, local_var(1) bwor pow(2, 21 + LVar1));
                        set_local_var(1, local_var(1) bwand (-1 - pow(2, 21 + LVar0)));
                        continue;
                    end
                    set_local_var(1, local_var(1) bwor pow(2, 21 + LVar0));
                    set_local_var(1, local_var(1) bwand (-1 - pow(2, 21 + LVar1)));
                end
            end
        end
        LVar0 := LVar0 + 1;
    end
end

procedure CheckLuck(variable arg0)
begin
    if (random(1, 200) <= (get_critter_stat(arg0, 6) * get_critter_stat(arg0, 6))) then begin
        return 2;
    end
    if (random(1, 20) <= get_critter_stat(arg0, 6)) then begin
        return 1;
    end
    return 0;
end

procedure getCards(variable arg0)
begin
    variable LVar1 := 1;
    variable LVar2 := 0;
    call setDeck(arg0);
    LVar2 := CheckLuck(arg0);
    if (LVar2 == 2) then begin
        if (random(1, 1000000) <= (50000 + (50000 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
            call give_straight_flesh();
        end
        else begin
            if (random(1, 1000000) <= (100000 + (100000 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                call give_four();
            end
            else begin
                if (random(1, 1000000) <= (200000 + (200000 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                    call give_full_house();
                end
                else begin
                    if (random(1, 1000000) <= (300000 + (300000 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                        call give_flesh();
                    end
                    else begin
                        if (random(1, 1000000) <= (400000 + (400000 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                            call give_straight();
                        end
                        else begin
                            if (random(1, 1000000) <= (500000 + (500000 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                                call give_three();
                            end
                            else begin
                                if (random(1, 1000000) <= (750000 + (750000 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                                    call give_two_pairs();
                                end
                                else begin
                                    call give_pair();
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    else begin
        if (LVar2 == 1) then begin
            if (random(1, 1000000) <= (30 + (30 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                call give_straight_flesh();
            end
            else begin
                if (random(1, 1000000) <= (480 + (480 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                    call give_four();
                end
                else begin
                    if (random(1, 1000000) <= (2800 + (2800 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                        call give_full_house();
                    end
                    else begin
                        if (random(1, 1000000) <= (4000 + (4000 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                            call give_flesh();
                        end
                        else begin
                            if (random(1, 1000000) <= (7800 + (7800 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                                call give_straight();
                            end
                            else begin
                                if (random(1, 1000000) <= (42200 + (42200 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                                    call give_three();
                                end
                                else begin
                                    if (random(1, 1000000) <= (95000 + (95000 / 10 * (get_critter_stat(arg0, 6) - 5)))) then begin
                                        call give_two_pairs();
                                    end
                                    else begin
                                        call give_pair();
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        else begin
            while (LVar1 <= 5) do begin
                call get_Card(LVar1, 0, 0);
                LVar1 := LVar1 + 1;
            end
        end
    end
end

procedure Shuffle_Deck
begin
    variable LVar0 := 1;
    call clean_hands();
    try_open := 0;
    dealer_check := 0;
    npc1_check := 0;
    pl_bet := 0;
    npc1_bet := 0;
    dealer_bet := 0;
    step := 0;
    dealer_pass := 0;
    npc1_pass := 0;
    dealer_try_open := 0;
    npc1_try_open := 0;
    num_changes := 0;
    pl_change_done := 0;
    dealer_succ_check := 0;
    for (npc1_succ_check := 0; LVar0 <= 52; LVar0 := LVar0 + 1) begin
        if (LVar0 <= 5) then begin
            set_local_var(1, local_var(1) bwand (-1 - pow(2, 21 + LVar0)));
        end
        if (LVar0 < 31) then begin
            set_local_var(0, local_var(0) bwor pow(2, LVar0 - 1));
            continue;
        end
        set_local_var(1, local_var(1) bwor pow(2, LVar0 - 31));
    end
    LVar0 := random(1, 3);
    if (LVar0 == 1) then begin
        call getCards(dude_obj);
        if (random(0, 1)) then begin
            call getCards(self_obj);
            call getCards(NPC1);
        end
        else begin
            call getCards(NPC1);
            call getCards(self_obj);
        end
    end
    else begin
        if (LVar0 == 2) then begin
            call getCards(self_obj);
            if (random(0, 1)) then begin
                call getCards(dude_obj);
                call getCards(NPC1);
            end
            else begin
                call getCards(NPC1);
                call getCards(dude_obj);
            end
        end
        else begin
            call getCards(NPC1);
            if (random(0, 1)) then begin
                call getCards(dude_obj);
                call getCards(self_obj);
            end
            else begin
                call getCards(self_obj);
                call getCards(dude_obj);
            end
        end
    end
end

procedure checkComb(variable arg0)
begin
    call setDeck(arg0);
    call Sort();
    if (has_pairs()) then begin
        if (has_three()) then begin
            if (has_full_house()) then begin
                return 76 + (get_hand(get_comb(18)) - (13 * (((get_hand(get_comb(18)) - 1) / 13) + 1 - 1)));
            end
            if (Has_four()) then begin
                return 89 + (get_hand(get_comb(28)) - (13 * (((get_hand(get_comb(28)) - 1) / 13) + 1 - 1)));
            end
            return 39 + (get_hand(get_comb(18)) - (13 * (((get_hand(get_comb(18)) - 1) / 13) + 1 - 1)));
        end
        if (has_pairs() == 2) then begin
            return 26 + (get_hand(get_comb(10)) - (13 * (((get_hand(get_comb(10)) - 1) / 13) + 1 - 1)));
        end
        return 13 + (get_hand(get_comb(4)) - (13 * (((get_hand(get_comb(4)) - 1) / 13) + 1 - 1)));
    end
    if (has_straight()) then begin
        if (Has_flesh()) then begin
            return 102 + (get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1)));
        end
        else begin
            return 52 + (get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1)));
        end
    end
    if (Has_flesh()) then begin
        return 63 + (get_hand(1) - (13 * (((get_hand(1) - 1) / 13) + 1 - 1)));
    end
    return get_hand(5) - (13 * (((get_hand(5) - 1) / 13) + 1 - 1));
end

procedure showComb(variable arg0)
begin
    call setDeck(arg0);
    call Sort();
    if (has_pairs()) then begin
        if (has_three()) then begin
            if (has_full_house()) then begin
                return message_str(1360, 64);
            end
            if (Has_four()) then begin
                return message_str(1360, 65) + message_str(1360, get_hand(get_comb(21))) + ", " + message_str(1360, get_hand(get_comb(23))) + ", " + message_str(1360, get_hand(get_comb(25))) + message_str(1360, 118) + message_str(1360, get_hand(get_comb(28)));
            end
            return message_str(1360, 62) + message_str(1360, get_hand(get_comb(13))) + ", " + message_str(1360, get_hand(get_comb(15))) + message_str(1360, 118) + message_str(1360, get_hand(get_comb(18)));
        end
        if (has_pairs() == 2) then begin
            return message_str(1360, 61) + message_str(1360, get_hand(get_comb(1))) + message_str(1360, 118) + message_str(1360, get_hand(get_comb(4))) + ", " + message_str(1360, get_hand(get_comb(7))) + message_str(1360, 118) + message_str(1360, get_hand(get_comb(10)));
        end
        return message_str(1360, 60) + message_str(1360, get_hand(get_comb(1))) + message_str(1360, 118) + message_str(1360, get_hand(get_comb(4)));
    end
    if (has_straight()) then begin
        if (Has_flesh()) then begin
            return message_str(1360, 67) + message_str(1360, 159) + message_str(1360, get_hand(1)) + message_str(1360, 160) + message_str(1360, get_hand(5));
        end
        else begin
            return message_str(1360, 63) + message_str(1360, 159) + message_str(1360, get_hand(1)) + message_str(1360, 160) + message_str(1360, get_hand(5));
        end
    end
    if (Has_flesh()) then begin
        return message_str(1360, Has_flesh()) + message_str(1360, 66) + message_str(1360, 159) + message_str(1360, get_hand(1));
    end
    return message_str(1360, 68) + message_str(1360, get_hand(5));
end

procedure ChangeCard(variable arg0, variable arg1)
begin
    variable LVar2 := 0;
    call setDeck(arg0);
    num_changes := num_changes + 1;
    LVar2 := random(1, 52);
    while (get_Deck(LVar2) == 0) do begin
        LVar2 := random(1, 52);
    end
    if (LVar2 < 31) then begin
        set_local_var(0, local_var(0) bwand (-1 - pow(2, LVar2 - 1)));
    end
    else begin
        set_local_var(1, local_var(1) bwand (-1 - pow(2, LVar2 - 31)));
    end
    call set_hand(arg1, LVar2);
    set_local_var(1, local_var(1) bwor pow(2, 21 + arg1));
end

procedure NPCThink(variable arg0)
begin
    variable LVar1 := 1;
    variable LVar2 := 0;
    variable LVar3 := 0;
    call setDeck(arg0);
    if (has_straight() or Has_flesh() or has_full_house() or Has_four()) then begin
        return 0;
    end
    num_changes := 0;
    while (LVar1 <= 5) do begin
        set_local_var(1, local_var(1) bwand (-1 - pow(2, 21 + LVar1)));
        LVar1 := LVar1 + 1;
    end
    LVar1 := 1;
    call Sort();
    if (has_three() and random(0, 1)) then begin
        while ((num_changes < 2) and (LVar1 <= 5)) do begin
            if ((LVar1 != get_comb(13)) and (LVar1 != get_comb(15)) and (LVar1 != get_comb(18))) then begin
                call ChangeCard(arg0, LVar1);
            end
            LVar1 := LVar1 + 1;
        end
    end
    else begin
        if ((has_pairs() == 2) and random(0, 3)) then begin
            while ((num_changes < 1) and (LVar1 <= 5)) do begin
                if ((LVar1 != get_comb(1)) and (LVar1 != get_comb(4)) and (LVar1 != get_comb(7)) and (LVar1 != get_comb(10))) then begin
                    call ChangeCard(arg0, LVar1);
                end
                LVar1 := LVar1 + 1;
            end
        end
        else begin
            if (has_pairs() and random(0, 9)) then begin
                while ((num_changes < 3) and (LVar1 <= 5)) do begin
                    if ((LVar1 != get_comb(1)) and (LVar1 != get_comb(4))) then begin
                        call ChangeCard(arg0, LVar1);
                    end
                    LVar1 := LVar1 + 1;
                end
            end
            else begin
                call ChangeCard(arg0, 1);
                call ChangeCard(arg0, 2);
                call ChangeCard(arg0, 3);
            end
        end
    end
end

procedure comb_value(variable arg0)
begin
    call setDeck(arg0);
    if (has_pairs()) then begin
        if (has_three()) then begin
            if (Has_four()) then begin
                return 4;
            end
            else begin
                if (has_full_house()) then begin
                    return 3;
                end
                else begin
                    return 2;
                end
            end
        end
        if (has_pairs() == 2) then begin
            return 2;
        end
        return 1;
    end
    if (has_straight()) then begin
        if (Has_flesh()) then begin
            return 4;
        end
        else begin
            return 3;
        end
    end
    if (Has_flesh()) then begin
        return 3;
    end
    return 0;
end

procedure check_partner_comb(variable arg0, variable arg1)
begin
    variable LVar2 := 0;
    variable LVar3 := 0;
    LVar2 := has_skill(arg0, 16);
    LVar3 := has_skill(arg1, 16);
    if (get_critter_stat(arg0, 1) < 4) then begin
        return 6;
    end
    if (LVar2 < (LVar3 / 2)) then begin
        return 7;
    end
    if (random(LVar3 / 2, LVar3) < random(LVar2 / 2, LVar2)) then begin
        if (arg1 == dude_obj) then begin
            if (arg0 == dealer) then begin
                dealer_succ_check := 1;
            end
            else begin
                npc1_succ_check := 1;
            end
        end
        return comb_value(arg1);
    end
    return 5;
end

procedure player_barter_dealer
begin
    step := 1;
    try_open := 0;
    call mod_cash(dude_obj, -get_bet(dude_obj));
    if (get_pass(dealer)) then begin
        if (get_pass(NPC1)) then begin
            call NodeP_NPCPass();
        end
        else begin
            call player_barter_NPC1();
        end
    end
    else begin
        call bart_with_player(dealer);
    end
end

procedure player_barter_NPC1
begin
    if (not(get_pass(NPC1))) then begin
        call bart_with_player(NPC1);
    end
    else begin
        call NodeP_Barter();
    end
end

procedure bart_with_player(variable arg0)
begin
    if (NPCBarter(arg0) and (get_cash(arg0) > get_bet(dude_obj))) then begin
        gsay_reply(1360, pr_npc(arg0) + message_str(1360, 115));
        call mod_cash(arg0, -get_bet(dude_obj));
        if (arg0 == dealer) then begin
            if (get_pass(NPC1)) then begin
                gsay_option(1360, 108, NodeP_Barter, -1);
            end
            else begin
                gsay_option(1360, 108, player_barter_NPC1, -1);
            end
        end
        else begin
            gsay_option(1360, 108, NodeP_Barter, -1);
        end
    end
    else begin
        gsay_reply(1360, pr_npc(arg0) + message_str(1360, 114));
        call set_pass(arg0);
        if (get_pass(other_npc(arg0))) then begin
            gsay_option(1360, 108, NodeP_NPCPass, -1);
        end
        else begin
            if (arg0 == dealer) then begin
                gsay_option(1360, 108, player_barter_NPC1, -1);
            end
            else begin
                gsay_option(1360, 108, NodeP_Barter, -1);
            end
        end
    end
end

procedure NPCBarter(variable arg0)
begin
    variable LVar1 := 0;
    variable LVar2 := 0;
    variable LVar3 := 0;
    LVar2 := comb_value(arg0);
    if (LVar2 == 0) then begin
        return 0;
    end
    LVar1 := check_partner_comb(arg0, dude_obj);
    if ((LVar1 <= 4) and (LVar1 > LVar2)) then begin
        return 0;
    end
    if (not(get_pass(other_npc(arg0)))) then begin
        LVar3 := check_partner_comb(arg0, other_npc(arg0));
    end
    else begin
        LVar3 := 0;
    end
    if ((LVar3 <= 4) and (LVar3 > LVar2)) then begin
        return 0;
    end
    if ((LVar1 > 4) or (LVar3 > 4) and (stash > ((LVar2 + 1) * 5 * bet))) then begin
        return 0;
    end
    return 1;
end

procedure Add10
begin
    pl_bet := bet / bet;
    call player_barter_dealer();
end

procedure Add20
begin
    pl_bet := bet / 2;
    call player_barter_dealer();
end

procedure Add50
begin
    pl_bet := bet;
    call player_barter_dealer();
end

procedure Add100
begin
    pl_bet := 2 * bet;
    call player_barter_dealer();
end

procedure pr_npc(variable arg0)
begin
    return "[" + obj_name(arg0) + "] ";
end

procedure other_npc(variable arg0)
begin
    if (arg0 == dealer) then begin
        return NPC1;
    end
    else begin
        return dealer;
    end
end

procedure set_bet(variable arg0, variable arg1)
begin
    if (arg0 == dealer) then begin
        dealer_bet := arg1;
    end
    else begin
        if (arg0 == NPC1) then begin
            npc1_bet := arg1;
        end
        else begin
            pl_bet := arg1;
        end
    end
end

procedure get_bet(variable arg0)
begin
    if (arg0 == dealer) then begin
        return dealer_bet;
    end
    else begin
        if (arg0 == NPC1) then begin
            return npc1_bet;
        end
        else begin
            return pl_bet;
        end
    end
end

procedure get_pass(variable arg0)
begin
    if (arg0 == dealer) then begin
        if (dealer_pass) then begin
            return 1;
        end
        else begin
            return 0;
        end
    end
    else begin
        if (npc1_pass) then begin
            return 1;
        end
        else begin
            return 0;
        end
    end
end

procedure set_pass(variable arg0)
begin
    if (arg0 == dealer) then begin
        dealer_pass := 1;
    end
    else begin
        npc1_pass := 1;
    end
end

procedure generate_bet(variable arg0)
begin
    variable LVar1 := 0;
    if (arg0 == 0) then begin
        return bet / bet;
    end
    if ((arg0 == 1) and random(0, 3)) then begin
        return bet / bet;
    end
    else begin
        return bet / 2;
    end
    if (arg0 == 2) then begin
        LVar1 := random(0, 9);
        if (LVar1 < 1) then begin
            return bet / bet;
        end
        if (LVar1 > 7) then begin
            return bet;
        end
        return bet / 2;
    end
    if (arg0 == 3) then begin
        LVar1 := random(0, 19);
        if (LVar1 < 1) then begin
            return bet / bet;
        end
        if (LVar1 < 2) then begin
            return bet / 2;
        end
        if (LVar1 > 17) then begin
            return 2 * bet;
        end
        return bet;
    end
    if (random(0, 2)) then begin
        return 2 * bet;
    end
    else begin
        return bet;
    end
end

procedure NodeP_DealerWantsOpen
begin
    call npc_wants_open(dealer);
end

procedure NodeP_NPC1WantsOpen
begin
    call npc_wants_open(NPC1);
end

procedure set_try_open(variable arg0, variable arg1)
begin
    if (arg0 == dealer) then begin
        dealer_try_open := arg1;
    end
    else begin
        if (arg0 == NPC1) then begin
            npc1_try_open := arg1;
        end
        else begin
            try_open := arg1;
        end
    end
end

procedure get_try_open(variable arg0)
begin
    if (arg0 == dealer) then begin
        return dealer_try_open;
    end
    else begin
        if (arg0 == NPC1) then begin
            return npc1_try_open;
        end
        else begin
            return try_open;
        end
    end
end

procedure npc_wants_open(variable arg0)
begin
    if (get_pass(other_npc(arg0))) then begin
        call NodePokerDoCompare();
    end
    else begin
        if (check_open(other_npc(arg0))) then begin
            gsay_reply(1360, pr_npc(other_npc(arg0)) + message_str(1360, random(123, 125)));
            gsay_option(1360, 108, NodePokerDoCompare, -1);
        end
        else begin
            gsay_reply(1360, pr_npc(other_npc(arg0)) + message_str(1360, random(126, 128)));
            if (arg0 == dealer) then begin
                gsay_option(1360, 108, player_barter_NPC1, -1);
            end
            else begin
                gsay_option(1360, 108, NodeP_Barter, -1);
            end
        end
    end
end

procedure npc_do_barter(variable arg0)
begin
    variable LVar1 := 0;
    variable LVar2 := 0;
    variable LVar3 := 0;
    variable LVar4 := 0;
    LVar4 := ((2 * 10 * bet) - stash) / 2;
    if (check_open(arg0) and not(get_try_open(arg0))) then begin
        call set_try_open(arg0, 1);
        if (((2 * 10 * bet) - stash) < (2 * bet / bet)) then begin
            gsay_reply(1360, pr_npc(dealer) + message_str(1360, 136) + generate_ending(stash, 139) + message_str(1360, 137) + generate_ending(2 * 10 * bet, 139) + message_str(1360, 138));
        end
        else begin
            gsay_reply(1360, pr_npc(arg0) + message_str(1360, 129));
        end
        if (arg0 == dealer) then begin
            gsay_option(1360, 108, NodeP_DealerWantsOpen, -1);
            gsay_option(1360, 107, NodeP_BarterDealer, -1);
        end
        else begin
            gsay_option(1360, 108, NodeP_NPC1WantsOpen, -1);
            gsay_option(1360, 107, NodeP_BarterNPC1, -1);
        end
    end
    else begin
        if (not(NPCBarter(arg0))) then begin
            call set_pass(arg0);
            gsay_reply(1360, pr_npc(arg0) + message_str(1360, 114));
            if (get_pass(other_npc(arg0))) then begin
                gsay_option(1360, 108, NodeP_NPCPass, -1);
            end
            else begin
                gsay_option(1360, 108, NodeP_Barter, -1);
            end
        end
        else begin
            LVar3 := comb_value(arg0);
            LVar1 := check_partner_comb(arg0, dude_obj);
            if (not(get_pass(other_npc(arg0)))) then begin
                LVar2 := check_partner_comb(arg0, other_npc(arg0));
            end
            else begin
                LVar2 := 0;
            end
            if ((LVar2 < 5) and (LVar1 < 5)) then begin
                if (random(0, 1)) then begin
                    call set_bet(arg0, 2 * bet);
                end
                else begin
                    call set_bet(arg0, bet);
                end
            end
            else begin
                call set_bet(arg0, generate_bet(arg0));
            end
            if (know_player_cards(arg0) and (get_critter_stat(dude_obj, 1) > get_critter_stat(arg0, 1))) then begin
                gsay_reply(1360, pr_npc(arg0) + message_str(1360, 233) + generate_ending(get_bet(arg0), 139) + message_str(1360, 234) + message_str(1360, 336));
            end
            else begin
                gsay_reply(1360, pr_npc(arg0) + message_str(1360, 233) + generate_ending(get_bet(arg0), 139) + message_str(1360, 234));
            end
            if (bet > LVar4) then begin
                call set_bet(arg0, LVar4);
            end
            call mod_cash(arg0, -get_bet(arg0));
            if (get_cash(dude_obj) >= get_bet(arg0)) then begin
                gsay_option(1360, 115, NodeP_PlayerAccept, -1);
            end
            gsay_option(1360, 324, NodeP_PlayerPass, -1);
        end
    end
end

procedure npc_change_cards(variable arg0)
begin
    num_changes := 0;
    call NPCThink(arg0);
    if (num_changes > 1) then begin
        gsay_reply(1360, pr_npc(arg0) + message_str(1360, 224) + num_changes + message_str(1360, 225));
    end
    else begin
        if (num_changes == 1) then begin
            gsay_reply(1360, pr_npc(arg0) + message_str(1360, 223));
        end
        else begin
            gsay_reply(1360, pr_npc(arg0) + message_str(1360, 226));
        end
    end
    if (arg0 == dealer) then begin
        gsay_option(1360, 108, NodeP_NPC1ChangeCards, -1);
    end
    else begin
        gsay_option(1360, 108, NodeP_Barter, -1);
    end
end

procedure know_player_cards(variable arg0)
begin
    if (arg0 == dealer) then begin
        return dealer_succ_check;
    end
    else begin
        return npc1_succ_check;
    end
end

procedure mod_cash(variable arg0, variable arg1)
begin
    if (arg0 != dude_obj) then begin
        call set_cash(arg0, get_cash1(arg0) + arg1);
    end
    else begin
        item_caps_adjust(dude_obj, arg1);
    end
    stash := stash - arg1;
end

procedure get_cash(variable arg0)
begin
    if (arg0 == dealer) then begin
        return get_cash1(dealer);
    end
    else begin
        if (arg0 == NPC1) then begin
            return get_cash1(NPC1);
        end
        else begin
            return item_caps_total(dude_obj);
        end
    end
end

procedure aquire_cash(variable arg0, variable arg1, variable arg2)
begin
    variable LVar3 := 0;
    for (0; LVar3 < arg1; LVar3 := LVar3 + 1) begin
        LVar4 := random(1, 5);
        if (get_cash(arg0) < arg2) then begin
            call mod_cash(arg0, LVar4);
        end
        else begin
            call mod_cash(arg0, -LVar4);
        end
        if (get_total_win() < LVar4) then begin
            call set_total_win(0);
            continue;
        end
        call set_total_win(get_total_win() - LVar4);
    end
end

procedure generate_ending(variable arg0, variable arg1)
begin
    variable LVar2 := 0;
    variable LVar3 := 0;
    variable LVar4 := 0;
    LVar2 := arg0 / 10;
    LVar3 := arg0 - (LVar2 * 10);
    LVar4 := LVar2 - (LVar2 / 10 * 10);
    if (arg0 == 0) then begin
        arg0 := 1;
    end
    if ((LVar3 == 1) and ((LVar4 > 1) or (LVar4 == 0))) then begin
        return arg0 + message_str(1360, arg1);
    end
    else begin
        if ((LVar3 >= 2) and (LVar3 <= 4) and ((LVar4 > 1) or (LVar4 == 0))) then begin
            return arg0 + message_str(1360, arg1 + 1);
        end
        else begin
            return arg0 + message_str(1360, arg1 + 2);
        end
    end
end

procedure pl_gender
begin
    if (get_critter_stat(dude_obj, 34) == 0) then begin
        return message_str(1360, random(200, 201));
    end
    else begin
        return message_str(1360, random(203, 204));
    end
end

procedure damage_p_proc
begin
    if (source_obj == dude_obj) then begin
        set_global_var(204, -1);
    end
end

procedure destroy_p_proc
begin
    if (source_obj == dude_obj) then begin
        set_global_var(5, global_var(5) + 1);
        if (metarule(51, self_obj) == 2) then begin
            if (source_obj == dude_obj) then begin
                set_global_var(2, 0);
                set_global_var(1, global_var(1) + 1);
                set_global_var(0, global_var(0) - -15);
                set_global_var(37, 0);
                set_global_var(38, 0);
                set_global_var(39, 0);
                set_global_var(40, 0);
                set_global_var(41, 0);
                set_global_var(42, 0);
                set_global_var(43, 0);
                set_global_var(44, 0);
                set_global_var(45, 0);
                if (global_var(0) >= 1000) then begin
                    set_global_var(37, 1);
                end
                else begin
                    if (global_var(0) >= 750) then begin
                        set_global_var(38, 1);
                    end
                    else begin
                        if (global_var(0) >= 500) then begin
                            set_global_var(39, 1);
                        end
                        else begin
                            if (global_var(0) >= 250) then begin
                                set_global_var(40, 1);
                            end
                            else begin
                                if (global_var(0) > -250) then begin
                                    set_global_var(41, 1);
                                end
                                else begin
                                    if (global_var(0) > -500) then begin
                                        set_global_var(42, 1);
                                    end
                                    else begin
                                        if (global_var(0) > -750) then begin
                                            set_global_var(43, 1);
                                        end
                                        else begin
                                            if (global_var(0) > -1000) then begin
                                                set_global_var(44, 1);
                                            end
                                            else begin
                                                set_global_var(45, 1);
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        if (((global_var(4) + global_var(5)) >= 25) and ((global_var(4) > (3 * global_var(5))) or (global_var(2) == 1)) and (global_var(1) == 0)) then begin
            set_global_var(2, 1);
            set_global_var(3, 0);
        end
        if (((global_var(4) + global_var(5)) >= 25) and ((global_var(5) > (2 * global_var(4))) or (global_var(3) == 1))) then begin
            set_global_var(3, 1);
            set_global_var(2, 0);
        end
        set_global_var(0, global_var(0) + -10);
        debug_msg("Player gains " + -10 + " Karma Points.");
        set_global_var(37, 0);
        set_global_var(38, 0);
        set_global_var(39, 0);
        set_global_var(40, 0);
        set_global_var(41, 0);
        set_global_var(42, 0);
        set_global_var(43, 0);
        set_global_var(44, 0);
        set_global_var(45, 0);
        if (global_var(0) >= 1000) then begin
            set_global_var(37, 1);
        end
        else begin
            if (global_var(0) >= 750) then begin
                set_global_var(38, 1);
            end
            else begin
                if (global_var(0) >= 500) then begin
                    set_global_var(39, 1);
                end
                else begin
                    if (global_var(0) >= 250) then begin
                        set_global_var(40, 1);
                    end
                    else begin
                        if (global_var(0) > -250) then begin
                            set_global_var(41, 1);
                        end
                        else begin
                            if (global_var(0) > -500) then begin
                                set_global_var(42, 1);
                            end
                            else begin
                                if (global_var(0) > -750) then begin
                                    set_global_var(43, 1);
                                end
                                else begin
                                    if (global_var(0) > -1000) then begin
                                        set_global_var(44, 1);
                                    end
                                    else begin
                                        set_global_var(45, 1);
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    set_global_var(204, -1);
    set_global_var(0, global_var(0) - 5);
    set_global_var(0, global_var(48) - 2);
    item_caps_adjust(self_obj, get_cash1(self_obj));
    if (NPC1 != 0) then begin
        item_caps_adjust(NPC1, get_cash1(NPC1));
    end
    dealer := 0;
end

procedure critter_p_proc
begin
    if ((global_var(204) == -1) and obj_can_see_obj(dude_obj, self_obj)) then begin
        attack_complex(dude_obj, 0, 1, 0, 0, 30000, 0, 0);
    end
    else begin
        if (obj_can_see_obj(self_obj, dude_obj) and not(say_once)) then begin
            say_once := 1;
            add_timer_event(self_obj, 0, 1);
        end
    end
end

procedure timed_event_p_proc
begin
    variable LVar0 := 0;
    if ((fixed_param == 1) and not(combat_is_initialized)) then begin
        LVar0 := random(143, 145);
        if (LVar0 == 143) then begin
            float_msg(self_obj, message_str(1360, 143) + pl_gender() + message_str(1360, 161), 8);
        end
        else begin
            float_msg(self_obj, message_str(1360, LVar0), 8);
        end
    end
    else begin
        if ((fixed_param == 5) and obj_can_see_obj(self_obj, dude_obj) and not(combat_is_initialized)) then begin
            if (get_total_win() < 200) then begin
                LVar0 := random(143, 145);
                if (LVar0 == 143) then begin
                    float_msg(self_obj, message_str(1360, 143) + pl_gender() + message_str(1360, 161), 8);
                end
                else begin
                    float_msg(self_obj, message_str(1360, LVar0), 8);
                end
            end
            else begin
                LVar0 := random(146, 148);
                if (LVar0 == 146) then begin
                    if (get_critter_stat(dude_obj, 34) == 0) then begin
                        float_msg(self_obj, message_str(1360, 146) + ".", 8);
                    end
                    else begin
                        float_msg(self_obj, message_str(1360, 146) + ".", 0);
                    end
                end
                else begin
                    float_msg(self_obj, message_str(1360, LVar0), 8);
                end
            end
        end
        else begin
            if (fixed_param == 7) then begin
                if (get_total_win() < 200) then begin
                    float_msg(NPC1, message_str(1360, random(149, 151)), 8);
                end
                else begin
                    float_msg(NPC1, message_str(1360, random(152, 154)), 0);
                end
            end
            else begin
                if (fixed_param == 8) then begin
                    item_caps_adjust(NPC1, get_cash1(NPC1));
                end
            end
        end
    end
    add_timer_event(self_obj, game_ticks(15), 5);
end

procedure generate_days
begin
    variable LVar0 := 0;
    variable LVar1 := 0;
    variable LVar2 := 0;
    LVar0 := get_total_win();
    LVar1 := (LVar0 / 3) + (LVar0 % 3);
    LVar2 := LVar1 / 7;
    if (LVar1 < 7) then begin
        return message_str(1360, 158);
    end
    if (LVar2 == 1) then begin
        return message_str(1360, 155);
    end
    if ((LVar2 >= 2) and (LVar2 <= 4)) then begin
        return message_str(1360, 156);
    end
    return message_str(1360, 157);
end

procedure NodeP_Again
begin
    call Start_Game_Dialog(1);
end

