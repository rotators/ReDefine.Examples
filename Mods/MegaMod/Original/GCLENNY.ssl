variable PartyHealingItem;
variable tmp_gen_rep;
variable global_temp;
variable dest_tile;
variable step_tile;
variable in_dialog;
variable forced_node;
variable restock_amt;
variable restock_obj;
variable restock_trash;
variable removed_qty;
variable Static_Reaction;
variable Evil_Critter;
variable Slavery_Tolerant := 2;
variable Karma_Perception;
variable reaction_bonus_town_rep;
variable reaction_bonus_karma;
variable PartyMemberBackground := -1;
variable ArmourVal;

procedure Check_Next_Third_Of_Areas;
procedure Check_Second_Third_Of_Areas;
procedure Check_Final_Third_Of_Areas;
procedure start;
procedure critter_p_proc;
procedure combat_p_proc;
procedure pickup_p_proc;
procedure push_p_proc;
procedure talk_p_proc;
procedure destroy_p_proc;
procedure look_at_p_proc;
procedure description_p_proc;
procedure use_skill_on_p_proc;
procedure damage_p_proc;
procedure map_enter_p_proc;
procedure map_update_p_proc;
procedure checkarea;
procedure HealPlayer;
procedure PayDude;
procedure PartyFree;
procedure HowMany;
procedure timed_event_p_proc;
procedure Node901;
procedure Node910;
procedure Node920;
procedure Node922;
procedure Node924;
procedure Node926;
procedure Node929;
procedure Node930;
procedure Node931;
procedure Node932;
procedure Node933;
procedure Node934;
procedure Node935;
procedure Node936;
procedure Node937;
procedure Node938;
procedure Node939;
procedure Node940;
procedure Node951;
procedure Node953;
procedure Node954;
procedure Node960;
procedure Node961;
procedure Node962;
procedure Node963;
procedure Node964;
procedure Node965;
procedure Node966;
procedure Node995;
procedure Node996;
procedure Node997;
procedure Node998;
procedure Node999;
procedure Node1a;
procedure Node001;
procedure Node002;
procedure Node02a;
procedure Node003;
procedure Node004;
procedure Node04a;
procedure Node005;
procedure Node006;
procedure Node007;
procedure Node008;
procedure Node009;
procedure Node10a;
procedure Node010;
procedure Node11a;
procedure Node011;
procedure Node12a;
procedure Node012;
procedure Node13a;
procedure Node013;
procedure Node14a;
procedure Node014;
procedure Node015;
procedure Node16a;
procedure Node016;
procedure Node17a;
procedure Node017;
procedure Node18a;
procedure Node018;
procedure Node19a;
procedure Node019;
procedure Node20a;
procedure Node020;
procedure Node021;
procedure Node022;
procedure Node023;
procedure Node024;
procedure Node025;
procedure Node070;
procedure Node071;
procedure Node072;
procedure Node073;
procedure Node074;
procedure Node075;
procedure Node076;
procedure Node077;
procedure Node078;
procedure Node079;
procedure Node080;
procedure Node081;
procedure Node082;
procedure Node083;
procedure Node084;
procedure Node085;
procedure Node086;
procedure Node087;
procedure Node800;
procedure Node1000;
procedure Node1001;
procedure Node1002;
procedure Node1003;
procedure Node1004;
procedure Node1005;
procedure Node1006;
procedure Node1007;
procedure Node1008;
procedure Node1009;
procedure Node1010;
procedure Node1100;
procedure armour_change;
procedure MNode001;
procedure MNode002;
procedure MNode003;
procedure MNode004;
procedure MNode005;
procedure MNode006;

variable Only_Once;
variable area;
variable here;
variable k;
variable ss;
variable visit_04_before;
variable visit_14_before;
variable from6;
variable Heal_Cost;
variable prev_node;
variable waiting;

procedure use_obj_on_p_proc;


procedure Check_Next_Third_Of_Areas
begin
    if (metarule(46, 0) == 16) then begin
        PartyMemberBackground := 15;
    end
    else begin
        if (metarule(46, 0) == 52) then begin
            if (cur_map_index == 182) then begin
                PartyMemberBackground := 14;
            end
            else begin
                PartyMemberBackground := 12;
            end
        end
        else begin
            if ((metarule(46, 0) == 54) or (metarule(46, 0) == 85)) then begin
                if ((cur_map_index == 175) and (elevation(dude_obj) == 1)) then begin
                    PartyMemberBackground := 14;
                end
                else begin
                    if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                        PartyMemberBackground := 22;
                    end
                    else begin
                        PartyMemberBackground := 16;
                    end
                end
            end
            else begin
                if (metarule(46, 0) == 49) then begin
                    if ((cur_map_index == 184) or (cur_map_index == 185) or (cur_map_index == 177)) then begin
                        PartyMemberBackground := 23;
                    end
                    else begin
                        if ((elevation(dude_obj) == 1) or (elevation(dude_obj) == 2)) then begin
                            PartyMemberBackground := 24;
                        end
                        else begin
                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                PartyMemberBackground := 41;
                            end
                            else begin
                                PartyMemberBackground := 40;
                            end
                        end
                    end
                end
                else begin
                    if (metarule(46, 0) == 98) then begin
                        if (elevation(dude_obj) == 0) then begin
                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                PartyMemberBackground := 22;
                            end
                            else begin
                                PartyMemberBackground := 16;
                            end
                        end
                        else begin
                            PartyMemberBackground := 26;
                        end
                    end
                    else begin
                        if (metarule(46, 0) == 20) then begin
                            if ((cur_map_index == 25) or (cur_map_index == 26)) then begin
                                PartyMemberBackground := 14;
                            end
                        end
                        else begin
                            if (metarule(46, 0) == 21) then begin
                                if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                    PartyMemberBackground := 43;
                                end
                                else begin
                                    PartyMemberBackground := 42;
                                end
                            end
                            else begin
                                if (metarule(46, 0) == 22) then begin
                                    PartyMemberBackground := 44;
                                end
                                else begin
                                    if (metarule(46, 0) == 23) then begin
                                        if (elevation(self_obj) == 2) then begin
                                            PartyMemberBackground := 6;
                                        end
                                        else begin
                                            PartyMemberBackground := 14;
                                        end
                                    end
                                    else begin
                                        if (metarule(46, 0) == 24) then begin
                                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                PartyMemberBackground := 22;
                                            end
                                            else begin
                                                PartyMemberBackground := 16;
                                            end
                                        end
                                        else begin
                                            if (metarule(46, 0) == 25) then begin
                                                if (cur_map_index == 92) then begin
                                                    if (elevation(self_obj) == 0) then begin
                                                        if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                            PartyMemberBackground := 22;
                                                        end
                                                        else begin
                                                            PartyMemberBackground := 16;
                                                        end
                                                    end
                                                    else begin
                                                        PartyMemberBackground := 4;
                                                    end
                                                end
                                                else begin
                                                    PartyMemberBackground := 14;
                                                end
                                            end
                                            else begin
                                                if (metarule(46, 0) == 26) then begin
                                                    if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                        PartyMemberBackground := 22;
                                                    end
                                                    else begin
                                                        PartyMemberBackground := 16;
                                                    end
                                                end
                                                else begin
                                                    if ((cur_map_index == 69) or (cur_map_index == 70) or (cur_map_index == 71) or (cur_map_index == 72) or (cur_map_index == 73) or (cur_map_index == 74) or (cur_map_index == 75) or (cur_map_index == 95) or (cur_map_index == 121) or (cur_map_index == 122) or (cur_map_index == 123) or (cur_map_index == 124)) then begin
                                                        if (elevation(self_obj) == 1) then begin
                                                            PartyMemberBackground := 14;
                                                        end
                                                        else begin
                                                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                                PartyMemberBackground := 48;
                                                            end
                                                            else begin
                                                                PartyMemberBackground := 47;
                                                            end
                                                        end
                                                    end
                                                    else begin
                                                        if ((cur_map_index == 68) or (cur_map_index == 125) or (cur_map_index == 141) or (cur_map_index == 142) or (cur_map_index == 143) or (cur_map_index == 144) or (cur_map_index == 145) or (cur_map_index == 146)) then begin
                                                            PartyMemberBackground := 4;
                                                        end
                                                        else begin
                                                            if ((cur_map_index == 76) or (cur_map_index == 77) or (cur_map_index == 85) or (cur_map_index == 86) or (cur_map_index == 87) or (cur_map_index == 88) or (cur_map_index == 89) or (cur_map_index == 90) or (cur_map_index == 91) or (cur_map_index == 110) or (cur_map_index == 111) or (cur_map_index == 112)) then begin
                                                                if (elevation(self_obj) == 1) then begin
                                                                    PartyMemberBackground := 14;
                                                                end
                                                                else begin
                                                                    if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                                        PartyMemberBackground := 46;
                                                                    end
                                                                    else begin
                                                                        PartyMemberBackground := 45;
                                                                    end
                                                                end
                                                            end
                                                            else begin
                                                                if (metarule(46, 0) == 30) then begin
                                                                    if (elevation(self_obj) == 1) then begin
                                                                        PartyMemberBackground := 14;
                                                                    end
                                                                    else begin
                                                                        if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                                            PartyMemberBackground := 32;
                                                                        end
                                                                        else begin
                                                                            PartyMemberBackground := 31;
                                                                        end
                                                                    end
                                                                end
                                                                else begin
                                                                    call Check_Second_Third_Of_Areas();
                                                                end
                                                            end
                                                        end
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end

procedure Check_Second_Third_Of_Areas
begin
    if (metarule(46, 0) == 31) then begin
        if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
            PartyMemberBackground := 22;
        end
        else begin
            PartyMemberBackground := 16;
        end
    end
    else begin
        if (metarule(46, 0) == 32) then begin
            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                PartyMemberBackground := 22;
            end
            else begin
                PartyMemberBackground := 16;
            end
        end
        else begin
            if (metarule(46, 0) == 33) then begin
                if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                    PartyMemberBackground := 22;
                end
                else begin
                    PartyMemberBackground := 16;
                end
            end
            else begin
                if (metarule(46, 0) == 34) then begin
                    if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                        PartyMemberBackground := 22;
                    end
                    else begin
                        PartyMemberBackground := 16;
                    end
                end
                else begin
                    if (metarule(46, 0) == 35) then begin
                        PartyMemberBackground := 4;
                    end
                    else begin
                        if (metarule(46, 0) == 36) then begin
                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                PartyMemberBackground := 22;
                            end
                            else begin
                                PartyMemberBackground := 16;
                            end
                        end
                        else begin
                            if (metarule(46, 0) == 37) then begin
                                PartyMemberBackground := 4;
                            end
                            else begin
                                if (metarule(46, 0) == 38) then begin
                                    if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                        PartyMemberBackground := 22;
                                    end
                                    else begin
                                        PartyMemberBackground := 16;
                                    end
                                end
                                else begin
                                    if (metarule(46, 0) == 39) then begin
                                        if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                            PartyMemberBackground := 22;
                                        end
                                        else begin
                                            PartyMemberBackground := 16;
                                        end
                                    end
                                    else begin
                                        if (metarule(46, 0) == 40) then begin
                                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                PartyMemberBackground := 22;
                                            end
                                            else begin
                                                PartyMemberBackground := 16;
                                            end
                                        end
                                        else begin
                                            if (metarule(46, 0) == 41) then begin
                                                if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                    PartyMemberBackground := 22;
                                                end
                                                else begin
                                                    PartyMemberBackground := 16;
                                                end
                                            end
                                            else begin
                                                if (metarule(46, 0) == 42) then begin
                                                    if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                        PartyMemberBackground := 22;
                                                    end
                                                    else begin
                                                        PartyMemberBackground := 16;
                                                    end
                                                end
                                                else begin
                                                    if (metarule(46, 0) == 43) then begin
                                                        if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                            PartyMemberBackground := 22;
                                                        end
                                                        else begin
                                                            PartyMemberBackground := 16;
                                                        end
                                                    end
                                                    else begin
                                                        if (metarule(46, 0) == 44) then begin
                                                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                                PartyMemberBackground := 22;
                                                            end
                                                            else begin
                                                                PartyMemberBackground := 16;
                                                            end
                                                        end
                                                        else begin
                                                            call Check_Final_Third_Of_Areas();
                                                        end
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end

procedure Check_Final_Third_Of_Areas
begin
    if (metarule(46, 0) == 45) then begin
        if (elevation(self_obj) == 1) then begin
            PartyMemberBackground := 14;
        end
        else begin
            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                PartyMemberBackground := 22;
            end
            else begin
                PartyMemberBackground := 16;
            end
        end
    end
    else begin
        if (metarule(46, 0) == 46) then begin
            if (elevation(self_obj) == 1) then begin
                PartyMemberBackground := 14;
            end
            else begin
                if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                    PartyMemberBackground := 22;
                end
                else begin
                    PartyMemberBackground := 16;
                end
            end
        end
        else begin
            if (metarule(46, 0) == 47) then begin
                if (elevation(self_obj) == 1) then begin
                    PartyMemberBackground := 14;
                end
                else begin
                    if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                        PartyMemberBackground := 22;
                    end
                    else begin
                        PartyMemberBackground := 16;
                    end
                end
            end
            else begin
                if (metarule(46, 0) == 48) then begin
                    if (elevation(self_obj) == 1) then begin
                        PartyMemberBackground := 6;
                    end
                    else begin
                        PartyMemberBackground := 3;
                    end
                end
                else begin
                    if (metarule(46, 0) == 58) then begin
                        if (cur_map_index == 167) then begin
                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                PartyMemberBackground := 22;
                            end
                            else begin
                                PartyMemberBackground := 16;
                            end
                        end
                        else begin
                            PartyMemberBackground := 29;
                        end
                    end
                    else begin
                        if (metarule(46, 0) == 91) then begin
                            if ((elevation(self_obj) == 1) or (elevation(self_obj) == 2)) then begin
                                PartyMemberBackground := 6;
                            end
                            else begin
                                if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                    PartyMemberBackground := 22;
                                end
                                else begin
                                    PartyMemberBackground := 16;
                                end
                            end
                        end
                        else begin
                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                PartyMemberBackground := 22;
                            end
                            else begin
                                PartyMemberBackground := 16;
                            end
                        end
                    end
                end
            end
        end
    end
end

procedure start
begin
end

procedure critter_p_proc
begin
    if ((cur_map_index == 54) and (self_obj == party_member_obj(16777323)) and (map_var(2) == party_member_obj(16777323))) then begin
        set_map_var(2, 0);
        waiting := 1;
        if (get_critter_stat(self_obj, 0) < 10) then begin
            use_obj_on_obj(create_object_sid(482, 0, 0, -1), self_obj);
        end
    end
    if ((cur_map_index == 54) and (self_obj == party_member_obj(16777801)) and (map_var(2) == party_member_obj(16777801))) then begin
        set_map_var(2, 0);
        waiting := 1;
        if (get_critter_stat(self_obj, 0) < 10) then begin
            use_obj_on_obj(create_object_sid(482, 0, 0, -1), self_obj);
        end
    end
    if (local_var(17) == 1) then begin
        obj_set_light_level(self_obj, 100, 3);
        set_local_var(17, 2);
    end
    if ((local_var(5) == 2) or ((metarule(46, 0) == 5) and global_var(238)) or (local_var(6) == 1) and obj_can_see_obj(self_obj, dude_obj)) then begin
        set_local_var(5, 1);
        attack_complex(dude_obj, 0, 1, 0, 0, 30000, 0, 0);
    end
    else begin
        if ((party_member_obj(16777323) != 0) or (party_member_obj(16777801) != 0)) then begin
            debug_msg("Lenny_In_Party == " + (party_member_obj(16777323) != 0) + ". local_var(LVAR_never_again) == " + local_var(14));
            if ((global_var(0) < -100) and not(has_trait(0, dude_obj, 39))) then begin
                call Node070();
                debug_msg("LENNY: Bad Karma");
            end
            else begin
                if ((global_var(1) >= 2) and not(has_trait(0, dude_obj, 39))) then begin
                    call Node071();
                    debug_msg("LENNY: Childkiller");
                end
                else begin
                    if ((global_var(11) == 1) and not(has_trait(0, dude_obj, 39))) then begin
                        call Node073();
                        debug_msg("LENNY: Slaver");
                    end
                    else begin
                        if ((global_var(82) == 8) or (global_var(395) > 0) or (global_var(583) == 1) and not(has_trait(0, dude_obj, 39))) then begin
                            call Node074();
                            debug_msg("LENNY: Destroyed Plant");
                        end
                        else begin
                            if ((get_critter_stat(dude_obj, 3) <= 1) and not(has_trait(0, dude_obj, 39))) then begin
                                call Node075();
                                debug_msg("LENNY: Player Ugly");
                            end
                            else begin
                                if ((metarule(46, 0) == 5) and (global_var(238) == 1) and not(has_trait(0, dude_obj, 39))) then begin
                                    call Node076();
                                    debug_msg("LENNY: Causing trouble in Gecko");
                                end
                                else begin
                                    if ((local_var(10) != 0) == 0) then begin
                                        if (waiting != 1) then begin
                                            if (((local_var(10) != 0) == 0) and ((global_var(398) != 0) == 0)) then begin
                                                if (local_var(11) == 0) then begin
                                                    set_local_var(11, 6);
                                                end
                                                if (tile_distance_objs(self_obj, dude_obj) > (3 * local_var(11) / 2)) then begin
                                                    if (anim_busy(self_obj) == 0) then begin
                                                        dest_tile := tile_num_in_direction(tile_num_in_direction(tile_num(dude_obj), rotation_to_tile(tile_num(dude_obj), tile_num(self_obj)), local_var(11)), random(0, 5), random(0, 2));
                                                        if (tile_distance_objs(self_obj, dude_obj) > (3 * local_var(11) / 2 * 2)) then begin
                                                            animate_move_obj_to_tile(self_obj, dest_tile, 1);
                                                        end
                                                        else begin
                                                            animate_move_obj_to_tile(self_obj, dest_tile, 0);
                                                        end
                                                    end
                                                    else begin
                                                        if (tile_distance(tile_num(self_obj), tile_num(dude_obj)) < tile_distance(tile_num(self_obj), dest_tile)) then begin
                                                            reg_anim_func(2, self_obj);
                                                        end
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        else begin
            if ((metarule(46, 0) == 5) and (global_var(238) == 1)) then begin
                call Node998();
            end
        end
    end
    debug_msg("Gecko Standing: " + global_var(238));
end

procedure combat_p_proc
begin
    variable LVar0 := 0;
    if (((get_critter_stat(dude_obj, 7) / 2) > get_critter_stat(dude_obj, 35)) and (party_member_obj(obj_pid(self_obj)) != 0)) then begin
        animate_move_obj_to_tile(self_obj, tile_num(dude_obj), 1);
        if (obj_is_carrying_obj_pid(self_obj, 91)) then begin
            use_obj_on_obj(obj_carrying_pid_obj(self_obj, 91), dude_obj);
            if (is_success(roll_vs_skill(self_obj, 7, 0))) then begin
                LVar0 := random(10, 25);
                critter_heal(dude_obj, LVar0);
                display_msg(obj_name(self_obj) + " heals you for " + LVar0 + " hit points,with doctor skill.");
            end
        end
        else begin
            if (obj_is_carrying_obj_pid(self_obj, 47)) then begin
                use_obj_on_obj(obj_carrying_pid_obj(self_obj, 47), dude_obj);
                if (is_success(roll_vs_skill(self_obj, 6, 0))) then begin
                    LVar0 := random(5, 15);
                    critter_heal(dude_obj, LVar0);
                    display_msg(obj_name(self_obj) + " heals you for " + LVar0 + " hit points,with first aid skill.");
                end
            end
        end
    end
    return 0;
    LVar0 := 0;
end

procedure pickup_p_proc
begin
    if (source_obj == dude_obj) then begin
        set_local_var(5, 2);
    end
end

procedure push_p_proc
begin
    if ((party_member_obj(16777323) != 0) or (party_member_obj(16777801) != 0)) then begin
        float_msg(self_obj, message_str(139, random(2300, 2307)), 8);
    end
    else begin
        script_overrides;
    end
end

procedure talk_p_proc
begin
    ArmourVal := critter_inven_obj(self_obj, 0);
    set_global_var(1642, get_ini_setting("megamod.ini|SETTINGS|party_armor_graphic"));
    visit_04_before := 0;
    visit_14_before := 0;
    if (local_var(2) == 0) then begin
        set_local_var(2, 1);
        set_local_var(3, (get_critter_stat(dude_obj, 3) - get_critter_stat(self_obj, 3)) * 5);
        debug_msg("Base Reaction == " + local_var(3));
    end
    Static_Reaction := 0;
    set_local_var(0, 0);
    debug_msg("Start Reaction == " + local_var(0));
    if (reaction_bonus_karma >= 0) then begin
        reaction_bonus_karma := reaction_bonus_karma / 1000;
    end
    else begin
        reaction_bonus_karma := -1 * (-1 * reaction_bonus_karma / 1000);
    end
    if (global_var(51) >= 0) then begin
        reaction_bonus_town_rep := global_var(51) / 2;
    end
    else begin
        reaction_bonus_town_rep := -1 * (-1 * global_var(51) / 2);
    end
    if (has_trait(2, dude_obj, 13)) then begin
        if (get_critter_stat(dude_obj, 34) == get_critter_stat(self_obj, 34)) then begin
            Static_Reaction := Static_Reaction + -20;
        end
        else begin
            Static_Reaction := Static_Reaction + 20;
        end
        debug_msg("Sex Appeal Bonus == " + Static_Reaction);
    end
    else begin
        debug_msg("Sex Appeal Bonus == 0");
    end
    if (Evil_Critter == 1) then begin
        if (reaction_bonus_karma >= 0) then begin
            Static_Reaction := Static_Reaction - reaction_bonus_karma;
        end
        else begin
            Static_Reaction := Static_Reaction + reaction_bonus_karma;
        end
        debug_msg("Karma Reaction Bonus == " + Static_Reaction);
        if (reaction_bonus_town_rep >= 0) then begin
            Static_Reaction := Static_Reaction - reaction_bonus_town_rep;
        end
        else begin
            Static_Reaction := Static_Reaction + reaction_bonus_town_rep;
        end
        debug_msg("Town Rep Bonus == " + Static_Reaction);
        set_global_var(37, 0);
        set_global_var(38, 0);
        set_global_var(39, 0);
        set_global_var(40, 0);
        set_global_var(41, 0);
        set_global_var(42, 0);
        set_global_var(43, 0);
        set_global_var(44, 0);
        set_global_var(45, 0);
        tmp_gen_rep := global_var(0);
        if (has_trait(0, dude_obj, 95)) then begin
            tmp_gen_rep := global_var(0) * 2;
        end
        if (tmp_gen_rep >= 1000) then begin
            set_global_var(37, 1);
        end
        else begin
            if (tmp_gen_rep >= 750) then begin
                set_global_var(38, 1);
            end
            else begin
                if (tmp_gen_rep >= 500) then begin
                    set_global_var(39, 1);
                end
                else begin
                    if (tmp_gen_rep >= 250) then begin
                        set_global_var(40, 1);
                    end
                    else begin
                        if (tmp_gen_rep > -250) then begin
                            set_global_var(41, 1);
                        end
                        else begin
                            if (tmp_gen_rep > -500) then begin
                                set_global_var(42, 1);
                            end
                            else begin
                                if (tmp_gen_rep > -750) then begin
                                    set_global_var(43, 1);
                                end
                                else begin
                                    if (tmp_gen_rep > -1000) then begin
                                        set_global_var(44, 1);
                                    end
                                    else begin
                                        set_global_var(45, 1);
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        if (global_var(37) == 1) then begin
            Static_Reaction := Static_Reaction - 20;
        end
        else begin
            if (global_var(38) == 1) then begin
                Static_Reaction := Static_Reaction - 15;
            end
            else begin
                if (global_var(39) == 1) then begin
                    Static_Reaction := Static_Reaction - 10;
                end
                else begin
                    if (global_var(40) == 1) then begin
                        Static_Reaction := Static_Reaction - 5;
                    end
                    else begin
                        if (global_var(41) == 1) then begin
                            Static_Reaction := Static_Reaction - 0;
                        end
                        else begin
                            if (global_var(42) == 1) then begin
                                Static_Reaction := Static_Reaction + -5;
                            end
                            else begin
                                if (global_var(43) == 1) then begin
                                    Static_Reaction := Static_Reaction + -10;
                                end
                                else begin
                                    if (global_var(44) == 1) then begin
                                        Static_Reaction := Static_Reaction + -15;
                                    end
                                    else begin
                                        Static_Reaction := Static_Reaction + -20;
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        debug_msg("Bad Person Reaction Bonus == " + Static_Reaction);
    end
    else begin
        Static_Reaction := Static_Reaction + reaction_bonus_karma;
        debug_msg("Karma Reaction Bonus == " + Static_Reaction);
        Static_Reaction := Static_Reaction + reaction_bonus_town_rep;
        debug_msg("Town Rep Bonus == " + Static_Reaction);
        set_global_var(37, 0);
        set_global_var(38, 0);
        set_global_var(39, 0);
        set_global_var(40, 0);
        set_global_var(41, 0);
        set_global_var(42, 0);
        set_global_var(43, 0);
        set_global_var(44, 0);
        set_global_var(45, 0);
        tmp_gen_rep := global_var(0);
        if (has_trait(0, dude_obj, 95)) then begin
            tmp_gen_rep := global_var(0) * 2;
        end
        if (tmp_gen_rep >= 1000) then begin
            set_global_var(37, 1);
        end
        else begin
            if (tmp_gen_rep >= 750) then begin
                set_global_var(38, 1);
            end
            else begin
                if (tmp_gen_rep >= 500) then begin
                    set_global_var(39, 1);
                end
                else begin
                    if (tmp_gen_rep >= 250) then begin
                        set_global_var(40, 1);
                    end
                    else begin
                        if (tmp_gen_rep > -250) then begin
                            set_global_var(41, 1);
                        end
                        else begin
                            if (tmp_gen_rep > -500) then begin
                                set_global_var(42, 1);
                            end
                            else begin
                                if (tmp_gen_rep > -750) then begin
                                    set_global_var(43, 1);
                                end
                                else begin
                                    if (tmp_gen_rep > -1000) then begin
                                        set_global_var(44, 1);
                                    end
                                    else begin
                                        set_global_var(45, 1);
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        if (global_var(37) == 1) then begin
            Static_Reaction := Static_Reaction + 20;
        end
        else begin
            if (global_var(38) == 1) then begin
                Static_Reaction := Static_Reaction + 15;
            end
            else begin
                if (global_var(39) == 1) then begin
                    Static_Reaction := Static_Reaction + 10;
                end
                else begin
                    if (global_var(40) == 1) then begin
                        Static_Reaction := Static_Reaction + 5;
                    end
                    else begin
                        if (global_var(41) == 1) then begin
                            Static_Reaction := Static_Reaction + 0;
                        end
                        else begin
                            if (global_var(42) == 1) then begin
                                Static_Reaction := Static_Reaction + -5;
                            end
                            else begin
                                if (global_var(43) == 1) then begin
                                    Static_Reaction := Static_Reaction + -10;
                                end
                                else begin
                                    if (global_var(44) == 1) then begin
                                        Static_Reaction := Static_Reaction + -15;
                                    end
                                    else begin
                                        Static_Reaction := Static_Reaction + -20;
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        debug_msg("Good Person Reaction Bonus == " + Static_Reaction);
    end
    if (Slavery_Tolerant == 0) then begin
        if (global_var(11) == 1) then begin
            Static_Reaction := Static_Reaction + (2 * -25);
        end
    end
    else begin
        if (Slavery_Tolerant == 1) then begin
            if (global_var(11) == 1) then begin
                Static_Reaction := Static_Reaction + -25;
            end
        end
        else begin
            if (Slavery_Tolerant == 3) then begin
                if (global_var(11) == 1) then begin
                    Static_Reaction := Static_Reaction - -25;
                end
            end
        end
    end
    debug_msg("Slaver + Aligned Reaction == " + Static_Reaction);
    Static_Reaction := Static_Reaction + (10 * has_trait(0, dude_obj, 10));
    debug_msg("Presence Reaction == " + Static_Reaction);
    if (global_var(1) >= 2) then begin
        Static_Reaction := Static_Reaction + -30;
    end
    debug_msg("Childkiller Reaction == " + Static_Reaction);
    if (has_trait(0, dude_obj, 39)) then begin
        if (Evil_Critter == 1) then begin
            if (Static_Reaction > 0) then begin
                Static_Reaction := Static_Reaction * -1;
            end
        end
        else begin
            if (Static_Reaction < 0) then begin
                Static_Reaction := Static_Reaction * -1;
            end
        end
    end
    set_local_var(0, local_var(3) + Static_Reaction);
    debug_msg("Initial Reaction == " + local_var(0));
    call checkarea();
    if (metarule(46, 0) == 0) then begin
        if (cur_map_index == 3) then begin
            PartyMemberBackground := 34;
        end
        else begin
            if (cur_map_index == 35) then begin
                if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                    PartyMemberBackground := 28;
                end
                else begin
                    PartyMemberBackground := 33;
                end
            end
            else begin
                if (cur_map_index == 5) then begin
                    PartyMemberBackground := 39;
                end
                else begin
                    PartyMemberBackground := 38;
                end
            end
        end
    end
    else begin
        if (metarule(46, 0) == 2) then begin
            if (cur_map_index == 11) then begin
                PartyMemberBackground := 14;
            end
            else begin
                if (cur_map_index == 48) then begin
                    if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                        PartyMemberBackground := 37;
                    end
                    else begin
                        PartyMemberBackground := 36;
                    end
                end
                else begin
                    if ((cur_map_index == 14) or (cur_map_index == 13)) then begin
                        if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                            PartyMemberBackground := 28;
                        end
                        else begin
                            PartyMemberBackground := 33;
                        end
                    end
                    else begin
                        if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                            PartyMemberBackground := 35;
                        end
                        else begin
                            PartyMemberBackground := 27;
                        end
                    end
                end
            end
        end
        else begin
            if (metarule(46, 0) == 1) then begin
                PartyMemberBackground := 3;
            end
            else begin
                if (metarule(46, 0) == 3) then begin
                    if ((cur_map_index == 18) and (elevation(dude_obj) == 2)) then begin
                        PartyMemberBackground := 14;
                    end
                    else begin
                        if ((cur_map_index == 20) or (cur_map_index == 21) or (cur_map_index == 24)) then begin
                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                PartyMemberBackground := 21;
                            end
                            else begin
                                PartyMemberBackground := 16;
                            end
                        end
                        else begin
                            if ((cur_map_index == 22) or (cur_map_index == 23)) then begin
                                PartyMemberBackground := 14;
                            end
                            else begin
                                PartyMemberBackground := 3;
                            end
                        end
                    end
                end
                else begin
                    if (metarule(46, 0) == 4) then begin
                        if (cur_map_index == 30) then begin
                            PartyMemberBackground := 10;
                        end
                        else begin
                            PartyMemberBackground := 20;
                        end
                    end
                    else begin
                        if (metarule(46, 0) == 5) then begin
                            if (cur_map_index == 32) then begin
                                PartyMemberBackground := 6;
                            end
                            else begin
                                if (cur_map_index == 34) then begin
                                    PartyMemberBackground := 14;
                                end
                                else begin
                                    PartyMemberBackground := 3;
                                end
                            end
                        end
                        else begin
                            if (metarule(46, 0) == 6) then begin
                                if (cur_map_index == 79) then begin
                                    if ((elevation(self_obj) == 1) or (elevation(self_obj) == 2)) then begin
                                        PartyMemberBackground := 14;
                                    end
                                end
                                else begin
                                    PartyMemberBackground := 7;
                                end
                            end
                            else begin
                                if (metarule(46, 0) == 7) then begin
                                    if (metarule(46, 0) == 48) then begin
                                        if (elevation(self_obj) == 1) then begin
                                            PartyMemberBackground := 6;
                                        end
                                        else begin
                                            PartyMemberBackground := 27;
                                        end
                                    end
                                    else begin
                                        PartyMemberBackground := 27;
                                    end
                                end
                                else begin
                                    if (metarule(46, 0) == 8) then begin
                                        if (cur_map_index == 27) then begin
                                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                PartyMemberBackground := 21;
                                            end
                                            else begin
                                                PartyMemberBackground := 16;
                                            end
                                        end
                                        else begin
                                            PartyMemberBackground := 6;
                                        end
                                    end
                                    else begin
                                        if (metarule(46, 0) == 9) then begin
                                            if (cur_map_index == 36) then begin
                                                PartyMemberBackground := 10;
                                            end
                                            else begin
                                                if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                    PartyMemberBackground := 21;
                                                end
                                                else begin
                                                    PartyMemberBackground := 16;
                                                end
                                            end
                                        end
                                        else begin
                                            if (metarule(46, 0) == 10) then begin
                                                if (cur_map_index == 45) then begin
                                                    if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                        PartyMemberBackground := 21;
                                                    end
                                                    else begin
                                                        PartyMemberBackground := 16;
                                                    end
                                                end
                                                else begin
                                                    PartyMemberBackground := 20;
                                                end
                                            end
                                            else begin
                                                if (metarule(46, 0) == 11) then begin
                                                    if (cur_map_index == 40) then begin
                                                        PartyMemberBackground := 10;
                                                    end
                                                    else begin
                                                        PartyMemberBackground := 14;
                                                    end
                                                end
                                                else begin
                                                    if (metarule(46, 0) == 12) then begin
                                                        if (cur_map_index == 51) then begin
                                                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                                PartyMemberBackground := 21;
                                                            end
                                                            else begin
                                                                PartyMemberBackground := 16;
                                                            end
                                                        end
                                                        else begin
                                                            PartyMemberBackground := 14;
                                                        end
                                                    end
                                                    else begin
                                                        if (metarule(46, 0) == 13) then begin
                                                            if ((cur_map_index == 66) or (cur_map_index == 67) or (cur_map_index == 63)) then begin
                                                                PartyMemberBackground := 14;
                                                            end
                                                            else begin
                                                                PartyMemberBackground := 3;
                                                            end
                                                        end
                                                        else begin
                                                            if (metarule(46, 0) == 14) then begin
                                                                PartyMemberBackground := 12;
                                                            end
                                                            else begin
                                                                if (metarule(46, 0) == 15) then begin
                                                                    if (elevation(self_obj) == 0) then begin
                                                                        PartyMemberBackground := 7;
                                                                    end
                                                                    else begin
                                                                        if (elevation(self_obj) == 1) then begin
                                                                            PartyMemberBackground := 6;
                                                                        end
                                                                        else begin
                                                                            if ((game_time_hour >= 2000) or (game_time_hour < 600)) then begin
                                                                                PartyMemberBackground := 21;
                                                                            end
                                                                            else begin
                                                                                PartyMemberBackground := 16;
                                                                            end
                                                                        end
                                                                    end
                                                                end
                                                                else begin
                                                                    call Check_Next_Third_Of_Areas();
                                                                end
                                                            end
                                                        end
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    if (local_var(6) == 1) then begin
        call Node998();
    end
    else begin
        if (local_var(4) == 0) then begin
            start_gdialog(139, self_obj, 4, 27, PartyMemberBackground);
            gsay_start;
            call Node001();
            gsay_end;
            end_dialogue;
        end
        else begin
            if (local_var(14) > 0) then begin
                float_msg(self_obj, message_str(139, 3005), 2);
            end
            else begin
                if ((party_member_obj(16777323) != 0) or (party_member_obj(16777801) != 0) and (global_var(0) < -100)) then begin
                    call Node070();
                    debug_msg("LENNY: Bad Karma");
                end
                else begin
                    if ((party_member_obj(16777323) != 0) and (global_var(1) >= 2)) then begin
                        call Node071();
                        debug_msg("LENNY: Childkiller");
                    end
                    else begin
                        if ((party_member_obj(16777323) != 0) or (party_member_obj(16777801) != 0) and (((global_var(4) + global_var(5)) >= 25) and ((global_var(5) > (2 * global_var(4))) or (global_var(3) == 1)))) then begin
                            call Node072();
                            debug_msg("LENNY: Berserker");
                        end
                        else begin
                            if ((party_member_obj(16777323) != 0) or (party_member_obj(16777801) != 0) and (global_var(11) == 1)) then begin
                                call Node073();
                                debug_msg("LENNY: Slaver");
                            end
                            else begin
                                if ((party_member_obj(16777323) != 0) or (party_member_obj(16777801) != 0) and ((global_var(82) == 8) or (global_var(395) > 0) or (global_var(583) == 1))) then begin
                                    call Node074();
                                    debug_msg("LENNY: Destroyed Plant");
                                end
                                else begin
                                    if ((party_member_obj(16777323) != 0) or (party_member_obj(16777801) != 0) or (local_var(10) != 0)) then begin
                                        start_gdialog(139, self_obj, 4, 27, PartyMemberBackground);
                                        gsay_start;
                                        call Node1000();
                                        gsay_end;
                                        end_dialogue;
                                    end
                                    else begin
                                        if (get_critter_stat(dude_obj, 4) <= 3) then begin
                                            call Node003();
                                        end
                                        else begin
                                            start_gdialog(139, self_obj, 4, 27, PartyMemberBackground);
                                            gsay_start;
                                            call Node001();
                                            gsay_end;
                                            end_dialogue;
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    if (global_var(1642) == 1) then begin
        call armour_change();
    end
end

procedure destroy_p_proc
begin
    if (source_obj == dude_obj) then begin
        set_global_var(5, global_var(5) + 1);
        if (((global_var(4) + global_var(5)) >= 25) and ((global_var(4) > (3 * global_var(5))) or (global_var(2) == 1)) and (global_var(1) == 0)) then begin
            set_global_var(2, 1);
            set_global_var(3, 0);
        end
        if (((global_var(4) + global_var(5)) >= 25) and ((global_var(5) > (2 * global_var(4))) or (global_var(3) == 1))) then begin
            set_global_var(3, 1);
            set_global_var(2, 0);
        end
        set_global_var(0, global_var(0) + -10);
        debug_msg("Player gains " + -10 + " Karma Points.");
        set_global_var(37, 0);
        set_global_var(38, 0);
        set_global_var(39, 0);
        set_global_var(40, 0);
        set_global_var(41, 0);
        set_global_var(42, 0);
        set_global_var(43, 0);
        set_global_var(44, 0);
        set_global_var(45, 0);
        tmp_gen_rep := global_var(0);
        if (has_trait(0, dude_obj, 95)) then begin
            tmp_gen_rep := global_var(0) * 2;
        end
        if (tmp_gen_rep >= 1000) then begin
            set_global_var(37, 1);
        end
        else begin
            if (tmp_gen_rep >= 750) then begin
                set_global_var(38, 1);
            end
            else begin
                if (tmp_gen_rep >= 500) then begin
                    set_global_var(39, 1);
                end
                else begin
                    if (tmp_gen_rep >= 250) then begin
                        set_global_var(40, 1);
                    end
                    else begin
                        if (tmp_gen_rep > -250) then begin
                            set_global_var(41, 1);
                        end
                        else begin
                            if (tmp_gen_rep > -500) then begin
                                set_global_var(42, 1);
                            end
                            else begin
                                if (tmp_gen_rep > -750) then begin
                                    set_global_var(43, 1);
                                end
                                else begin
                                    if (tmp_gen_rep > -1000) then begin
                                        set_global_var(44, 1);
                                    end
                                    else begin
                                        set_global_var(45, 1);
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        set_global_var(51, global_var(51) + -5);
        debug_msg("Added " + -5 + " to Town Rep");
    end
end

procedure look_at_p_proc
begin
    script_overrides;
    if (party_member_obj(16777323) != 0) then begin
        display_msg(message_str(139, 104));
    end
    else begin
        if ((party_member_obj(16777323) != 0) or (local_var(10) != 0)) then begin
            display_msg(message_str(139, 103));
        end
        else begin
            if (local_var(15) == 0) then begin
                set_local_var(15, 1);
                display_msg(message_str(139, 100));
            end
            else begin
                display_msg(message_str(139, 101));
            end
        end
    end
end

procedure description_p_proc
begin
    script_overrides;
    display_msg(message_str(139, 101));
end

procedure use_skill_on_p_proc
begin
    if (action_being_used == 12) then begin
        script_overrides;
        if (has_skill(source_obj, 12) > 99) then begin
            display_msg(message_str(139, 6100));
        end
        else begin
            if (has_skill(source_obj, 12) > 69) then begin
                display_msg(message_str(139, 6101));
            end
            else begin
                display_msg(message_str(139, 6102));
            end
        end
    end
end

procedure damage_p_proc
begin
    if (source_obj == dude_obj) then begin
        if (party_member_obj(obj_pid(self_obj)) != 0) then begin
            debug_msg("abandon party: " + obj_name(self_obj));
            party_remove(self_obj);
        end
        if ((obj_pid(self_obj) == 16777380) or (obj_pid(self_obj) == 16777379)) then begin
            debug_msg("start: set_dude_was_married");
            if ((global_var(6) != 0) and ((global_var(449) != 0) == 0)) then begin
                debug_msg("   GVAR_PLAYER_WAS_MARRIED before == " + global_var(449));
                set_global_var(449, global_var(6));
                debug_msg("   GVAR_PLAYER_WAS_MARRIED after == " + global_var(449));
                set_global_var(6, 0);
            end
            debug_msg("finished: set_dude_was_married");
        end
        if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
            critter_add_trait(self_obj, 1, 6, local_var(12));
            set_local_var(12, -1);
        end
        debug_msg("" + obj_name(self_obj) + " has abandoned the party");
        set_local_var(5, 2);
        if (cur_map_index == 31) then begin
            set_global_var(238, 1);
        end
        if (cur_map_index == 33) then begin
            set_global_var(238, 1);
        end
        if (cur_map_index == 32) then begin
            set_global_var(238, 1);
        end
        if (cur_map_index == 34) then begin
            set_global_var(238, 1);
        end
    end
end

procedure map_enter_p_proc
begin
    if ((cur_map_index == 19) or (cur_map_index == 37) or (cur_map_index == 38)) then begin
        if ((elevation(self_obj) != elevation(dude_obj)) and (local_var(10) != 0)) then begin
            move_to(self_obj, tile_num(self_obj), elevation(dude_obj));
        end
    end
    if (party_member_obj(16777323) == 0) then begin
        critter_add_trait(self_obj, 1, 6, 49);
    end
    else begin
        add_timer_event(self_obj, game_ticks(random(50, 150)), 10);
    end
    add_timer_event(self_obj, random(25, 40), 900);
end

procedure map_update_p_proc
begin
    if (combat_is_initialized == 0) then begin
        if (anim_busy(self_obj) == 0) then begin
            if (party_member_obj(obj_pid(self_obj)) != 0) then begin
                if (metarule3(109, self_obj, 0, 0) == 1) then begin
                    if ((100 * get_critter_stat(self_obj, 35) / get_critter_stat(self_obj, 7)) <= 60) then begin
                        global_temp := 1;
                        if (obj_is_carrying_obj_pid(self_obj, 144)) then begin
                            if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                gfade_out(600);
                                if (0 > 0) then begin
                                    game_time_advance(0);
                                end
                                gfade_in(600);
                            end
                            PartyHealingItem := obj_carrying_pid_obj(self_obj, 144);
                            use_obj_on_obj(PartyHealingItem, self_obj);
                            debug_msg(obj_name(self_obj) + " used super stimpak.");
                        end
                        else begin
                            if (obj_is_carrying_obj_pid(self_obj, 40)) then begin
                                if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                    gfade_out(600);
                                    if (0 > 0) then begin
                                        game_time_advance(0);
                                    end
                                    gfade_in(600);
                                end
                                use_obj_on_obj(obj_carrying_pid_obj(self_obj, 40), self_obj);
                                debug_msg(obj_name(self_obj) + " used stimpak.");
                            end
                            else begin
                                if (obj_is_carrying_obj_pid(self_obj, 273)) then begin
                                    if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                        gfade_out(600);
                                        if (0 > 0) then begin
                                            game_time_advance(0);
                                        end
                                        gfade_in(600);
                                    end
                                    use_obj_on_obj(obj_carrying_pid_obj(self_obj, 273), self_obj);
                                    debug_msg(obj_name(self_obj) + " used healing powder.");
                                end
                                else begin
                                    if (obj_is_carrying_obj_pid(self_obj, 91)) then begin
                                        if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                            gfade_out(600);
                                            if (0 > 0) then begin
                                                game_time_advance(0);
                                            end
                                            gfade_in(600);
                                        end
                                        use_obj_on_obj(obj_carrying_pid_obj(self_obj, 91), self_obj);
                                        debug_msg(obj_name(self_obj) + " used doctor's bag kit.");
                                    end
                                    else begin
                                        if (obj_is_carrying_obj_pid(self_obj, 47)) then begin
                                            if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                                gfade_out(600);
                                                if (0 > 0) then begin
                                                    game_time_advance(0);
                                                end
                                                gfade_in(600);
                                            end
                                            use_obj_on_obj(obj_carrying_pid_obj(self_obj, 47), self_obj);
                                            debug_msg(obj_name(self_obj) + " used First Aid kit.");
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
                else begin
                    if (metarule3(109, self_obj, 0, 0) == 2) then begin
                        if ((100 * get_critter_stat(self_obj, 35) / get_critter_stat(self_obj, 7)) <= 30) then begin
                            global_temp := 1;
                            if (obj_is_carrying_obj_pid(self_obj, 144)) then begin
                                if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                    gfade_out(600);
                                    if (0 > 0) then begin
                                        game_time_advance(0);
                                    end
                                    gfade_in(600);
                                end
                                PartyHealingItem := obj_carrying_pid_obj(self_obj, 144);
                                use_obj_on_obj(PartyHealingItem, self_obj);
                                debug_msg(obj_name(self_obj) + " used super stimpak.");
                            end
                            else begin
                                if (obj_is_carrying_obj_pid(self_obj, 40)) then begin
                                    if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                        gfade_out(600);
                                        if (0 > 0) then begin
                                            game_time_advance(0);
                                        end
                                        gfade_in(600);
                                    end
                                    use_obj_on_obj(obj_carrying_pid_obj(self_obj, 40), self_obj);
                                    debug_msg(obj_name(self_obj) + " used stimpak.");
                                end
                                else begin
                                    if (obj_is_carrying_obj_pid(self_obj, 273)) then begin
                                        if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                            gfade_out(600);
                                            if (0 > 0) then begin
                                                game_time_advance(0);
                                            end
                                            gfade_in(600);
                                        end
                                        use_obj_on_obj(obj_carrying_pid_obj(self_obj, 273), self_obj);
                                        debug_msg(obj_name(self_obj) + " used healing powder.");
                                    end
                                    else begin
                                        if (obj_is_carrying_obj_pid(self_obj, 91)) then begin
                                            if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                                gfade_out(600);
                                                if (0 > 0) then begin
                                                    game_time_advance(0);
                                                end
                                                gfade_in(600);
                                            end
                                            use_obj_on_obj(obj_carrying_pid_obj(self_obj, 91), self_obj);
                                            debug_msg(obj_name(self_obj) + " used doctor's bag kit.");
                                        end
                                        else begin
                                            if (obj_is_carrying_obj_pid(self_obj, 47)) then begin
                                                if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                                    gfade_out(600);
                                                    if (0 > 0) then begin
                                                        game_time_advance(0);
                                                    end
                                                    gfade_in(600);
                                                end
                                                use_obj_on_obj(obj_carrying_pid_obj(self_obj, 47), self_obj);
                                                debug_msg(obj_name(self_obj) + " used First Aid kit.");
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                    else begin
                        if (metarule3(109, self_obj, 0, 0) == 3) then begin
                            if ((100 * get_critter_stat(self_obj, 35) / get_critter_stat(self_obj, 7)) <= 50) then begin
                                global_temp := 1;
                                if (obj_is_carrying_obj_pid(self_obj, 144)) then begin
                                    if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                        gfade_out(600);
                                        if (0 > 0) then begin
                                            game_time_advance(0);
                                        end
                                        gfade_in(600);
                                    end
                                    PartyHealingItem := obj_carrying_pid_obj(self_obj, 144);
                                    use_obj_on_obj(PartyHealingItem, self_obj);
                                    debug_msg(obj_name(self_obj) + " used super stimpak.");
                                end
                                else begin
                                    if (obj_is_carrying_obj_pid(self_obj, 40)) then begin
                                        if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                            gfade_out(600);
                                            if (0 > 0) then begin
                                                game_time_advance(0);
                                            end
                                            gfade_in(600);
                                        end
                                        use_obj_on_obj(obj_carrying_pid_obj(self_obj, 40), self_obj);
                                        debug_msg(obj_name(self_obj) + " used stimpak.");
                                    end
                                    else begin
                                        if (obj_is_carrying_obj_pid(self_obj, 273)) then begin
                                            if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                                gfade_out(600);
                                                if (0 > 0) then begin
                                                    game_time_advance(0);
                                                end
                                                gfade_in(600);
                                            end
                                            use_obj_on_obj(obj_carrying_pid_obj(self_obj, 273), self_obj);
                                            debug_msg(obj_name(self_obj) + " used healing powder.");
                                        end
                                        else begin
                                            if (obj_is_carrying_obj_pid(self_obj, 91)) then begin
                                                if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                                    gfade_out(600);
                                                    if (0 > 0) then begin
                                                        game_time_advance(0);
                                                    end
                                                    gfade_in(600);
                                                end
                                                use_obj_on_obj(obj_carrying_pid_obj(self_obj, 91), self_obj);
                                                debug_msg(obj_name(self_obj) + " used doctor's bag kit.");
                                            end
                                            else begin
                                                if (obj_is_carrying_obj_pid(self_obj, 47)) then begin
                                                    if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                                        gfade_out(600);
                                                        if (0 > 0) then begin
                                                            game_time_advance(0);
                                                        end
                                                        gfade_in(600);
                                                    end
                                                    use_obj_on_obj(obj_carrying_pid_obj(self_obj, 47), self_obj);
                                                    debug_msg(obj_name(self_obj) + " used First Aid kit.");
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                        else begin
                            if (metarule3(109, self_obj, 0, 0) == 4) then begin
                                if ((100 * get_critter_stat(self_obj, 35) / get_critter_stat(self_obj, 7)) <= 50) then begin
                                    global_temp := 1;
                                    if (obj_is_carrying_obj_pid(self_obj, 144)) then begin
                                        if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                            gfade_out(600);
                                            if (0 > 0) then begin
                                                game_time_advance(0);
                                            end
                                            gfade_in(600);
                                        end
                                        PartyHealingItem := obj_carrying_pid_obj(self_obj, 144);
                                        use_obj_on_obj(PartyHealingItem, self_obj);
                                        debug_msg(obj_name(self_obj) + " used super stimpak.");
                                    end
                                    else begin
                                        if (obj_is_carrying_obj_pid(self_obj, 40)) then begin
                                            if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                                gfade_out(600);
                                                if (0 > 0) then begin
                                                    game_time_advance(0);
                                                end
                                                gfade_in(600);
                                            end
                                            use_obj_on_obj(obj_carrying_pid_obj(self_obj, 40), self_obj);
                                            debug_msg(obj_name(self_obj) + " used stimpak.");
                                        end
                                        else begin
                                            if (obj_is_carrying_obj_pid(self_obj, 273)) then begin
                                                if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                                    gfade_out(600);
                                                    if (0 > 0) then begin
                                                        game_time_advance(0);
                                                    end
                                                    gfade_in(600);
                                                end
                                                use_obj_on_obj(obj_carrying_pid_obj(self_obj, 273), self_obj);
                                                debug_msg(obj_name(self_obj) + " used healing powder.");
                                            end
                                            else begin
                                                if (obj_is_carrying_obj_pid(self_obj, 91)) then begin
                                                    if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                                        gfade_out(600);
                                                        if (0 > 0) then begin
                                                            game_time_advance(0);
                                                        end
                                                        gfade_in(600);
                                                    end
                                                    use_obj_on_obj(obj_carrying_pid_obj(self_obj, 91), self_obj);
                                                    debug_msg(obj_name(self_obj) + " used doctor's bag kit.");
                                                end
                                                else begin
                                                    if (obj_is_carrying_obj_pid(self_obj, 47)) then begin
                                                        if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                                            gfade_out(600);
                                                            if (0 > 0) then begin
                                                                game_time_advance(0);
                                                            end
                                                            gfade_in(600);
                                                        end
                                                        use_obj_on_obj(obj_carrying_pid_obj(self_obj, 47), self_obj);
                                                        debug_msg(obj_name(self_obj) + " used First Aid kit.");
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    if (waiting == 1) then begin
        waiting := 0;
    end
end

procedure checkarea
begin
    here := tile_num(self_obj);
    area := 0;
    if (tile_distance(here, 17926) < 5) then begin
        area := 1;
    end
    else begin
        if (tile_distance(here, 18100) < 4) then begin
            area := 2;
        end
    end
end

procedure HealPlayer
begin
    Heal_Cost := 30;
    critter_heal(dude_obj, get_critter_stat(dude_obj, 7) - get_critter_stat(dude_obj, 35));
    if ((critter_state(dude_obj) bwand 4) or (critter_state(dude_obj) bwand 8) or (critter_state(dude_obj) bwand 16) or (critter_state(dude_obj) bwand 32)) then begin
        Heal_Cost := 60;
        critter_injure(dude_obj, 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
    end
    gfade_out(600);
    game_time_advance(game_ticks(8 * (60 * (60 * 10))));
    gfade_in(600);
end

procedure PayDude
begin
    k := item_caps_total(dude_obj);
    if (k >= Heal_Cost) then begin
        item_caps_adjust(dude_obj, -Heal_Cost);
        if (prev_node == 922) then begin
        end
        else begin
            call Node001();
        end
    end
    else begin
        item_caps_adjust(dude_obj, -k);
        call Node024();
    end
end

procedure PartyFree
begin
    k := 0;
    Heal_Cost := 30;
    if ((get_critter_stat(dude_obj, 7) > get_critter_stat(dude_obj, 35)) or ((critter_state(dude_obj) bwand 4) or (critter_state(dude_obj) bwand 8) or (critter_state(dude_obj) bwand 16) or (critter_state(dude_obj) bwand 32))) then begin
        k := k + 1;
        critter_heal(dude_obj, get_critter_stat(dude_obj, 7) - get_critter_stat(dude_obj, 35));
        critter_injure(dude_obj, 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
    end
    if (party_member_obj(16777278) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777278), 35) < get_critter_stat(party_member_obj(16777278), 7)) or (critter_state(party_member_obj(16777278)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777278), get_critter_stat(party_member_obj(16777278), 7) - get_critter_stat(party_member_obj(16777278), 35));
            critter_injure(party_member_obj(16777278), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777376) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777376), 35) < get_critter_stat(party_member_obj(16777376), 7)) or (critter_state(party_member_obj(16777376)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777376), get_critter_stat(party_member_obj(16777376), 7) - get_critter_stat(party_member_obj(16777376), 35));
            critter_injure(party_member_obj(16777376), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777377) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777377), 35) < get_critter_stat(party_member_obj(16777377), 7)) or (critter_state(party_member_obj(16777377)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777377), get_critter_stat(party_member_obj(16777377), 7) - get_critter_stat(party_member_obj(16777377), 35));
            critter_injure(party_member_obj(16777377), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777305) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777305), 35) < get_critter_stat(party_member_obj(16777305), 7)) or (critter_state(party_member_obj(16777305)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777305), get_critter_stat(party_member_obj(16777305), 7) - get_critter_stat(party_member_obj(16777305), 35));
            critter_injure(party_member_obj(16777305), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777313) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777313), 35) < get_critter_stat(party_member_obj(16777313), 7)) or (critter_state(party_member_obj(16777313)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777313), get_critter_stat(party_member_obj(16777313), 7) - get_critter_stat(party_member_obj(16777313), 35));
            critter_injure(party_member_obj(16777313), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777323) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777323), 35) < get_critter_stat(party_member_obj(16777323), 7)) or (critter_state(party_member_obj(16777323)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777323), get_critter_stat(party_member_obj(16777323), 7) - get_critter_stat(party_member_obj(16777323), 35));
            critter_injure(party_member_obj(16777323), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777352) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777352), 35) < get_critter_stat(party_member_obj(16777352), 7)) or (critter_state(party_member_obj(16777352)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777352), get_critter_stat(party_member_obj(16777352), 7) - get_critter_stat(party_member_obj(16777352), 35));
            critter_injure(party_member_obj(16777352), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777378) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777378), 35) < get_critter_stat(party_member_obj(16777378), 7)) or (critter_state(party_member_obj(16777378)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777378), get_critter_stat(party_member_obj(16777378), 7) - get_critter_stat(party_member_obj(16777378), 35));
            critter_injure(party_member_obj(16777378), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777368) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777368), 35) < get_critter_stat(party_member_obj(16777368), 7)) or (critter_state(party_member_obj(16777368)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777368), get_critter_stat(party_member_obj(16777368), 7) - get_critter_stat(party_member_obj(16777368), 35));
            critter_injure(party_member_obj(16777368), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777379) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777379), 35) < get_critter_stat(party_member_obj(16777379), 7)) or (critter_state(party_member_obj(16777379)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777379), get_critter_stat(party_member_obj(16777379), 7) - get_critter_stat(party_member_obj(16777379), 35));
            critter_injure(party_member_obj(16777379), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777380) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777380), 35) < get_critter_stat(party_member_obj(16777380), 7)) or (critter_state(party_member_obj(16777380)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777380), get_critter_stat(party_member_obj(16777380), 7) - get_critter_stat(party_member_obj(16777380), 35));
            critter_injure(party_member_obj(16777380), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777295) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777295), 35) < get_critter_stat(party_member_obj(16777295), 7)) or (critter_state(party_member_obj(16777295)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777295), get_critter_stat(party_member_obj(16777295), 7) - get_critter_stat(party_member_obj(16777295), 35));
            critter_injure(party_member_obj(16777295), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777558) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777558), 35) < get_critter_stat(party_member_obj(16777558), 7)) or (critter_state(party_member_obj(16777558)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777558), get_critter_stat(party_member_obj(16777558), 7) - get_critter_stat(party_member_obj(16777558), 35));
            critter_injure(party_member_obj(16777558), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777687) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777687), 35) < get_critter_stat(party_member_obj(16777687), 7)) or (critter_state(party_member_obj(16777687)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777687), get_critter_stat(party_member_obj(16777687), 7) - get_critter_stat(party_member_obj(16777687), 35));
            critter_injure(party_member_obj(16777687), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777859) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777859), 35) < get_critter_stat(party_member_obj(16777859), 7)) or (critter_state(party_member_obj(16777859)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777859), get_critter_stat(party_member_obj(16777859), 7) - get_critter_stat(party_member_obj(16777859), 35));
            critter_injure(party_member_obj(16777859), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777801) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777801), 35) < get_critter_stat(party_member_obj(16777801), 7)) or (critter_state(party_member_obj(16777801)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777801), get_critter_stat(party_member_obj(16777801), 7) - get_critter_stat(party_member_obj(16777801), 35));
            critter_injure(party_member_obj(16777801), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777872) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777872), 35) < get_critter_stat(party_member_obj(16777872), 7)) or (critter_state(party_member_obj(16777872)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777872), get_critter_stat(party_member_obj(16777872), 7) - get_critter_stat(party_member_obj(16777872), 35));
            critter_injure(party_member_obj(16777872), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777875) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777875), 35) < get_critter_stat(party_member_obj(16777875), 7)) or (critter_state(party_member_obj(16777875)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777875), get_critter_stat(party_member_obj(16777875), 7) - get_critter_stat(party_member_obj(16777875), 35));
            critter_injure(party_member_obj(16777875), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777876) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777876), 35) < get_critter_stat(party_member_obj(16777876), 7)) or (critter_state(party_member_obj(16777876)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777876), get_critter_stat(party_member_obj(16777876), 7) - get_critter_stat(party_member_obj(16777876), 35));
            critter_injure(party_member_obj(16777876), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (party_member_obj(16777874) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777874), 35) < get_critter_stat(party_member_obj(16777874), 7)) or (critter_state(party_member_obj(16777874)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
            critter_heal(party_member_obj(16777874), get_critter_stat(party_member_obj(16777874), 7) - get_critter_stat(party_member_obj(16777874), 35));
            critter_injure(party_member_obj(16777874), 4 bwor 8 bwor 16 bwor 32 bwor 8388608);
        end
    end
    if (k > 1) then begin
        Heal_Cost := 60;
    end
    gfade_out(600);
    game_time_advance(game_ticks(8 * (60 * (60 * 10))));
    gfade_in(600);
end

procedure HowMany
begin
    k := 0;
    if (party_member_obj(16777278) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777278), 35) < get_critter_stat(party_member_obj(16777278), 7)) or (critter_state(party_member_obj(16777278)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777376) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777376), 35) < get_critter_stat(party_member_obj(16777376), 7)) or (critter_state(party_member_obj(16777376)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777377) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777377), 35) < get_critter_stat(party_member_obj(16777377), 7)) or (critter_state(party_member_obj(16777377)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777305) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777305), 35) < get_critter_stat(party_member_obj(16777305), 7)) or (critter_state(party_member_obj(16777305)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777313) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777313), 35) < get_critter_stat(party_member_obj(16777313), 7)) or (critter_state(party_member_obj(16777313)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777323) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777323), 35) < get_critter_stat(party_member_obj(16777323), 7)) or (critter_state(party_member_obj(16777323)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777352) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777352), 35) < get_critter_stat(party_member_obj(16777352), 7)) or (critter_state(party_member_obj(16777352)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777378) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777378), 35) < get_critter_stat(party_member_obj(16777378), 7)) or (critter_state(party_member_obj(16777378)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777368) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777368), 35) < get_critter_stat(party_member_obj(16777368), 7)) or (critter_state(party_member_obj(16777368)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777379) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777379), 35) < get_critter_stat(party_member_obj(16777379), 7)) or (critter_state(party_member_obj(16777379)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777380) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777380), 35) < get_critter_stat(party_member_obj(16777380), 7)) or (critter_state(party_member_obj(16777380)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777295) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777295), 35) < get_critter_stat(party_member_obj(16777295), 7)) or (critter_state(party_member_obj(16777295)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777558) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777558), 35) < get_critter_stat(party_member_obj(16777558), 7)) or (critter_state(party_member_obj(16777558)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777687) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777687), 35) < get_critter_stat(party_member_obj(16777687), 7)) or (critter_state(party_member_obj(16777687)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777875) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777875), 35) < get_critter_stat(party_member_obj(16777875), 7)) or (critter_state(party_member_obj(16777875)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777876) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777876), 35) < get_critter_stat(party_member_obj(16777876), 7)) or (critter_state(party_member_obj(16777876)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777874) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777874), 35) < get_critter_stat(party_member_obj(16777874), 7)) or (critter_state(party_member_obj(16777874)) bwand (4 bwor 8 bwor 16 bwor 32))) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777801) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777801), 35) < get_critter_stat(party_member_obj(16777801), 7)) or (critter_state(party_member_obj(16777801)) bwand 60)) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777872) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777872), 35) < get_critter_stat(party_member_obj(16777872), 7)) or (critter_state(party_member_obj(16777872)) bwand 60)) then begin
            k := k + 1;
        end
    end
    if (party_member_obj(16777859) != 0) then begin
        if ((get_critter_stat(party_member_obj(16777859), 35) < get_critter_stat(party_member_obj(16777859), 7)) or (critter_state(party_member_obj(16777859)) bwand 60)) then begin
            k := k + 1;
        end
    end
end

procedure timed_event_p_proc
begin
    if (fixed_param == 900) then begin
        metarule3(100, self_obj, 900, 0);
        if (has_trait(1, self_obj, 666)) then begin
            if ((party_member_obj(16777323) != 0) or (party_member_obj(16777801) != 0)) then begin
                if (critter_state(self_obj) bwand (4 bwor 8 bwor 16 bwor 32)) then begin
                    float_msg(self_obj, message_str(139, 5000), 2);
                end
                else begin
                    if (get_critter_stat(self_obj, 37)) then begin
                        float_msg(self_obj, message_str(139, 5001), 2);
                    end
                    else begin
                        if (get_poison(self_obj)) then begin
                            float_msg(self_obj, message_str(139, 5002), 2);
                        end
                    end
                end
            end
        end
    end
    else begin
        if (fixed_param == 10) then begin
            metarule3(100, self_obj, 10, 0);
            if ((global_var(398) and combat_is_initialized) == 0) then begin
                float_msg(self_obj, message_str(139, random(6200, 6224)), 8);
            end
            add_timer_event(self_obj, game_ticks(random(50, 150)), 10);
        end
    end
end

procedure Node901
begin
end

procedure Node910
begin
    if (global_var(83) == 9) then begin
        call Node008();
    end
    else begin
        call Node007();
    end
end

procedure Node920
begin
    call HealPlayer();
    if (local_var(9) == 0) then begin
        call PayDude();
    end
end

procedure Node922
begin
    call HealPlayer();
    if (local_var(9) == 0) then begin
        call PayDude();
    end
    prev_node := 922;
end

procedure Node924
begin
    call PartyFree();
    if (local_var(9) == 0) then begin
        call PayDude();
    end
end

procedure Node926
begin
    call PartyFree();
    if (local_var(9) == 0) then begin
        call PayDude();
    end
end

procedure Node929
begin
end

procedure Node930
begin
end

procedure Node931
begin
end

procedure Node932
begin
end

procedure Node933
begin
end

procedure Node934
begin
end

procedure Node935
begin
end

procedure Node936
begin
end

procedure Node937
begin
end

procedure Node938
begin
end

procedure Node939
begin
end

procedure Node940
begin
end

procedure Node951
begin
    if (has_trait(0, dude_obj, 39) or ((global_var(0) > 0) and (local_var(0) > 30))) then begin
        call Node021();
    end
    else begin
        call Node022();
    end
end

procedure Node953
begin
    if (party_member_obj(obj_pid(self_obj)) != 0) then begin
        debug_msg("abandon party: " + obj_name(self_obj));
        party_remove(self_obj);
    end
    if ((obj_pid(self_obj) == 16777380) or (obj_pid(self_obj) == 16777379)) then begin
        debug_msg("start: set_dude_was_married");
        if ((global_var(6) != 0) and ((global_var(449) != 0) == 0)) then begin
            debug_msg("   GVAR_PLAYER_WAS_MARRIED before == " + global_var(449));
            set_global_var(449, global_var(6));
            debug_msg("   GVAR_PLAYER_WAS_MARRIED after == " + global_var(449));
            set_global_var(6, 0);
        end
        debug_msg("finished: set_dude_was_married");
    end
    if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
        critter_add_trait(self_obj, 1, 6, local_var(12));
        set_local_var(12, -1);
    end
    debug_msg("" + obj_name(self_obj) + " has abandoned the party");
end

procedure Node954
begin
end

procedure Node960
begin
end

procedure Node961
begin
end

procedure Node962
begin
end

procedure Node963
begin
end

procedure Node964
begin
end

procedure Node965
begin
end

procedure Node966
begin
end

procedure Node995
begin
    if (get_critter_stat(dude_obj, 3) >= 7) then begin
        set_local_var(3, 100);
        set_local_var(1, 4);
    end
    else begin
        set_local_var(1, -4);
        set_local_var(3, -100);
    end
end

procedure Node996
begin
    set_local_var(1, -4);
    set_local_var(3, -100);
end

procedure Node997
begin
    if (get_critter_stat(dude_obj, 3) >= 8) then begin
        call Node004();
    end
    else begin
        call Node005();
    end
end

procedure Node998
begin
    set_local_var(5, 2);
end

procedure Node999
begin
end

procedure Node1a
begin
    set_local_var(3, local_var(3) + 10);
    set_local_var(0, local_var(0) + 10);
    if (local_var(0) <= -75) then begin
        set_local_var(1, -4);
    end
    else begin
        if (local_var(0) <= -50) then begin
            set_local_var(1, -3);
        end
        else begin
            if (local_var(0) <= -25) then begin
                set_local_var(1, -2);
            end
            else begin
                if (local_var(0) <= -10) then begin
                    set_local_var(1, -1);
                end
                else begin
                    if (local_var(0) <= 10) then begin
                        set_local_var(1, 0);
                    end
                    else begin
                        if (local_var(0) <= 25) then begin
                            set_local_var(1, 1);
                        end
                        else begin
                            if (local_var(0) <= 50) then begin
                                set_local_var(1, 2);
                            end
                            else begin
                                if (local_var(0) <= 75) then begin
                                    set_local_var(1, 3);
                                end
                                else begin
                                    set_local_var(1, 4);
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    call Node001();
end

procedure Node001
begin
    if (local_var(4) == 0) then begin
        set_local_var(4, 1);
        if (local_var(9) == 0) then begin
            gsay_reply(139, 110);
        end
        else begin
            gsay_reply(139, 112);
        end
    end
    else begin
        if (local_var(9) == 0) then begin
            gsay_reply(139, 113);
        end
        else begin
            gsay_reply(139, 111);
        end
    end
    giq_option(-3, 139, 114, Node002, 50);
    giq_option(4, 139, 115, Node005, 50);
    if (local_var(18)) then begin
        giq_option(4, 139, 122, Node02a, 50);
    end
    if (global_var(233) < 0) then begin
        giq_option(4, 139, 119, Node004, 50);
    end
    if (local_var(9) > 0) then begin
        giq_option(4, 139, 120, Node008, 50);
    end
    giq_option(4, 139, 121, Node999, 50);
end

procedure Node002
begin
    gsay_reply(139, 130);
    giq_option(1, 139, 131, Node999, 50);
end

procedure Node02a
begin
    call HowMany();
    gsay_reply(139, 125);
    if ((get_critter_stat(dude_obj, 35) < get_critter_stat(dude_obj, 7)) or ((critter_state(dude_obj) bwand 4) or (critter_state(dude_obj) bwand 8) or (critter_state(dude_obj) bwand 16) or (critter_state(dude_obj) bwand 32))) then begin
        giq_option(4, 139, 116, Node006, 50);
    end
    if (k > 0) then begin
        giq_option(4, 139, 117, Node007, 50);
    end
    giq_option(4, 139, 126, Node999, 50);
end

procedure Node003
begin
    float_msg(self_obj, message_str(139, random(140, 142)), 2);
end

procedure Node004
begin
    call HowMany();
    gsay_reply(139, 150);
    if ((get_critter_stat(dude_obj, 35) < get_critter_stat(dude_obj, 7)) or ((critter_state(dude_obj) bwand 4) or (critter_state(dude_obj) bwand 8) or (critter_state(dude_obj) bwand 16) or (critter_state(dude_obj) bwand 32))) then begin
        giq_option(4, 139, 151, Node006, 50);
    end
    if (k > 0) then begin
        giq_option(4, 139, 152, Node007, 50);
    end
    giq_option(4, 139, 153, Node04a, 50);
    giq_option(4, 139, 154, Node999, 50);
end

procedure Node04a
begin
    set_local_var(9, 1);
    call Node008();
end

procedure Node005
begin
    if (local_var(18) != 1) then begin
        set_local_var(18, 1);
    end
    call HowMany();
    gsay_reply(139, 160);
    giq_option(4, 139, 161, Node023, 50);
    giq_option(4, 139, 162, Node001, 50);
    giq_option(4, 139, 163, Node009, 50);
    if ((get_critter_stat(dude_obj, 35) < get_critter_stat(dude_obj, 7)) or ((critter_state(dude_obj) bwand 4) or (critter_state(dude_obj) bwand 8) or (critter_state(dude_obj) bwand 16) or (critter_state(dude_obj) bwand 32))) then begin
        giq_option(4, 139, 164, Node006, 50);
    end
    if (k > 0) then begin
        giq_option(4, 139, 165, Node007, 50);
    end
    giq_option(4, 139, 166, Node999, 50);
end

procedure Node006
begin
    from6 := 1;
    if (local_var(9) == 0) then begin
        gsay_reply(139, 174);
    end
    else begin
        gsay_reply(139, 170);
        giq_option(4, 139, 171, Node015, 50);
    end
    giq_option(4, 139, 172, Node920, 50);
    giq_option(4, 139, 173, Node922, 50);
    giq_option(4, 139, 175, Node999, 50);
end

procedure Node007
begin
    from6 := 0;
    call HowMany();
    if (k == 0) then begin
        gsay_message(139, 187, 50);
    end
    else begin
        if (local_var(9) == 0) then begin
            if (k < 2) then begin
                gsay_reply(139, 185);
            end
            else begin
                gsay_reply(139, 186);
            end
        end
        else begin
            if (k < 2) then begin
                gsay_reply(139, 180);
            end
            else begin
                gsay_reply(139, 181);
            end
            giq_option(4, 139, 182, Node015, 50);
        end
        giq_option(4, 139, 183, Node924, 50);
        giq_option(4, 139, 184, Node926, 50);
        giq_option(4, 139, 175, Node999, 50);
    end
end

procedure Node008
begin
    gsay_reply(139, 190);
    giq_option(4, 139, 191, Node16a, 49);
    giq_option(4, 139, 192, Node999, 50);
end

procedure Node009
begin
    gsay_reply(139, 200);
    giq_option(4, 139, 201, Node10a, 49);
    giq_option(4, 139, 202, Node999, 50);
end

procedure Node10a
begin
    set_local_var(3, local_var(3) + 5);
    set_local_var(0, local_var(0) + 5);
    if (local_var(0) <= -75) then begin
        set_local_var(1, -4);
    end
    else begin
        if (local_var(0) <= -50) then begin
            set_local_var(1, -3);
        end
        else begin
            if (local_var(0) <= -25) then begin
                set_local_var(1, -2);
            end
            else begin
                if (local_var(0) <= -10) then begin
                    set_local_var(1, -1);
                end
                else begin
                    if (local_var(0) <= 10) then begin
                        set_local_var(1, 0);
                    end
                    else begin
                        if (local_var(0) <= 25) then begin
                            set_local_var(1, 1);
                        end
                        else begin
                            if (local_var(0) <= 50) then begin
                                set_local_var(1, 2);
                            end
                            else begin
                                if (local_var(0) <= 75) then begin
                                    set_local_var(1, 3);
                                end
                                else begin
                                    set_local_var(1, 4);
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    call Node010();
end

procedure Node010
begin
    gsay_reply(139, 210);
    giq_option(4, 139, 211, Node11a, 50);
    giq_option(4, 139, 212, Node999, 50);
end

procedure Node11a
begin
    set_local_var(3, local_var(3) + 5);
    set_local_var(0, local_var(0) + 5);
    if (local_var(0) <= -75) then begin
        set_local_var(1, -4);
    end
    else begin
        if (local_var(0) <= -50) then begin
            set_local_var(1, -3);
        end
        else begin
            if (local_var(0) <= -25) then begin
                set_local_var(1, -2);
            end
            else begin
                if (local_var(0) <= -10) then begin
                    set_local_var(1, -1);
                end
                else begin
                    if (local_var(0) <= 10) then begin
                        set_local_var(1, 0);
                    end
                    else begin
                        if (local_var(0) <= 25) then begin
                            set_local_var(1, 1);
                        end
                        else begin
                            if (local_var(0) <= 50) then begin
                                set_local_var(1, 2);
                            end
                            else begin
                                if (local_var(0) <= 75) then begin
                                    set_local_var(1, 3);
                                end
                                else begin
                                    set_local_var(1, 4);
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    call Node011();
end

procedure Node011
begin
    gsay_reply(139, 220);
    giq_option(4, 139, 221, Node12a, 49);
    giq_option(4, 139, 222, Node999, 50);
end

procedure Node12a
begin
    set_local_var(3, local_var(3) + 10);
    set_local_var(0, local_var(0) + 10);
    if (local_var(0) <= -75) then begin
        set_local_var(1, -4);
    end
    else begin
        if (local_var(0) <= -50) then begin
            set_local_var(1, -3);
        end
        else begin
            if (local_var(0) <= -25) then begin
                set_local_var(1, -2);
            end
            else begin
                if (local_var(0) <= -10) then begin
                    set_local_var(1, -1);
                end
                else begin
                    if (local_var(0) <= 10) then begin
                        set_local_var(1, 0);
                    end
                    else begin
                        if (local_var(0) <= 25) then begin
                            set_local_var(1, 1);
                        end
                        else begin
                            if (local_var(0) <= 50) then begin
                                set_local_var(1, 2);
                            end
                            else begin
                                if (local_var(0) <= 75) then begin
                                    set_local_var(1, 3);
                                end
                                else begin
                                    set_local_var(1, 4);
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    call Node012();
end

procedure Node012
begin
    gsay_reply(139, 230);
    giq_option(4, 139, 231, Node13a, 49);
    giq_option(4, 139, 232, Node999, 50);
end

procedure Node13a
begin
    set_local_var(3, local_var(3) + 10);
    set_local_var(0, local_var(0) + 10);
    if (local_var(0) <= -75) then begin
        set_local_var(1, -4);
    end
    else begin
        if (local_var(0) <= -50) then begin
            set_local_var(1, -3);
        end
        else begin
            if (local_var(0) <= -25) then begin
                set_local_var(1, -2);
            end
            else begin
                if (local_var(0) <= -10) then begin
                    set_local_var(1, -1);
                end
                else begin
                    if (local_var(0) <= 10) then begin
                        set_local_var(1, 0);
                    end
                    else begin
                        if (local_var(0) <= 25) then begin
                            set_local_var(1, 1);
                        end
                        else begin
                            if (local_var(0) <= 50) then begin
                                set_local_var(1, 2);
                            end
                            else begin
                                if (local_var(0) <= 75) then begin
                                    set_local_var(1, 3);
                                end
                                else begin
                                    set_local_var(1, 4);
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    call Node013();
end

procedure Node013
begin
    gsay_reply(139, 240);
    giq_option(4, 139, 241, Node14a, 49);
    giq_option(4, 139, 242, Node999, 50);
end

procedure Node14a
begin
    set_local_var(3, local_var(3) + 10);
    set_local_var(0, local_var(0) + 10);
    if (local_var(0) <= -75) then begin
        set_local_var(1, -4);
    end
    else begin
        if (local_var(0) <= -50) then begin
            set_local_var(1, -3);
        end
        else begin
            if (local_var(0) <= -25) then begin
                set_local_var(1, -2);
            end
            else begin
                if (local_var(0) <= -10) then begin
                    set_local_var(1, -1);
                end
                else begin
                    if (local_var(0) <= 10) then begin
                        set_local_var(1, 0);
                    end
                    else begin
                        if (local_var(0) <= 25) then begin
                            set_local_var(1, 1);
                        end
                        else begin
                            if (local_var(0) <= 50) then begin
                                set_local_var(1, 2);
                            end
                            else begin
                                if (local_var(0) <= 75) then begin
                                    set_local_var(1, 3);
                                end
                                else begin
                                    set_local_var(1, 4);
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    call Node014();
end

procedure Node014
begin
    gsay_reply(139, 250);
    giq_option(4, 139, 251, Node1a, 49);
    giq_option(4, 139, 252, Node999, 50);
end

procedure Node015
begin
    gsay_reply(139, 260);
    if (from6) then begin
        giq_option(4, 139, 261, Node006, 50);
    end
    else begin
        giq_option(4, 139, 261, Node007, 50);
    end
end

procedure Node16a
begin
    set_local_var(3, local_var(3) + 5);
    set_local_var(0, local_var(0) + 5);
    if (local_var(0) <= -75) then begin
        set_local_var(1, -4);
    end
    else begin
        if (local_var(0) <= -50) then begin
            set_local_var(1, -3);
        end
        else begin
            if (local_var(0) <= -25) then begin
                set_local_var(1, -2);
            end
            else begin
                if (local_var(0) <= -10) then begin
                    set_local_var(1, -1);
                end
                else begin
                    if (local_var(0) <= 10) then begin
                        set_local_var(1, 0);
                    end
                    else begin
                        if (local_var(0) <= 25) then begin
                            set_local_var(1, 1);
                        end
                        else begin
                            if (local_var(0) <= 50) then begin
                                set_local_var(1, 2);
                            end
                            else begin
                                if (local_var(0) <= 75) then begin
                                    set_local_var(1, 3);
                                end
                                else begin
                                    set_local_var(1, 4);
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    call Node016();
end

procedure Node016
begin
    gsay_reply(139, 270);
    giq_option(4, 139, 271, Node17a, 50);
    giq_option(4, 139, 272, Node999, 50);
end

procedure Node17a
begin
    set_local_var(3, local_var(3) + 5);
    set_local_var(0, local_var(0) + 5);
    if (local_var(0) <= -75) then begin
        set_local_var(1, -4);
    end
    else begin
        if (local_var(0) <= -50) then begin
            set_local_var(1, -3);
        end
        else begin
            if (local_var(0) <= -25) then begin
                set_local_var(1, -2);
            end
            else begin
                if (local_var(0) <= -10) then begin
                    set_local_var(1, -1);
                end
                else begin
                    if (local_var(0) <= 10) then begin
                        set_local_var(1, 0);
                    end
                    else begin
                        if (local_var(0) <= 25) then begin
                            set_local_var(1, 1);
                        end
                        else begin
                            if (local_var(0) <= 50) then begin
                                set_local_var(1, 2);
                            end
                            else begin
                                if (local_var(0) <= 75) then begin
                                    set_local_var(1, 3);
                                end
                                else begin
                                    set_local_var(1, 4);
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    call Node017();
end

procedure Node017
begin
    gsay_reply(139, 280);
    giq_option(4, 139, 281, Node18a, 49);
    giq_option(4, 139, 282, Node999, 51);
    giq_option(4, 139, 283, Node999, 50);
end

procedure Node18a
begin
    set_local_var(3, local_var(3) + 5);
    set_local_var(0, local_var(0) + 5);
    if (local_var(0) <= -75) then begin
        set_local_var(1, -4);
    end
    else begin
        if (local_var(0) <= -50) then begin
            set_local_var(1, -3);
        end
        else begin
            if (local_var(0) <= -25) then begin
                set_local_var(1, -2);
            end
            else begin
                if (local_var(0) <= -10) then begin
                    set_local_var(1, -1);
                end
                else begin
                    if (local_var(0) <= 10) then begin
                        set_local_var(1, 0);
                    end
                    else begin
                        if (local_var(0) <= 25) then begin
                            set_local_var(1, 1);
                        end
                        else begin
                            if (local_var(0) <= 50) then begin
                                set_local_var(1, 2);
                            end
                            else begin
                                if (local_var(0) <= 75) then begin
                                    set_local_var(1, 3);
                                end
                                else begin
                                    set_local_var(1, 4);
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    call Node018();
end

procedure Node018
begin
    gsay_reply(139, 290);
    giq_option(4, 139, 291, Node019, 49);
    giq_option(4, 139, 292, Node999, 50);
end

procedure Node19a
begin
    set_local_var(3, local_var(3) + 10);
    set_local_var(0, local_var(0) + 10);
    if (local_var(0) <= -75) then begin
        set_local_var(1, -4);
    end
    else begin
        if (local_var(0) <= -50) then begin
            set_local_var(1, -3);
        end
        else begin
            if (local_var(0) <= -25) then begin
                set_local_var(1, -2);
            end
            else begin
                if (local_var(0) <= -10) then begin
                    set_local_var(1, -1);
                end
                else begin
                    if (local_var(0) <= 10) then begin
                        set_local_var(1, 0);
                    end
                    else begin
                        if (local_var(0) <= 25) then begin
                            set_local_var(1, 1);
                        end
                        else begin
                            if (local_var(0) <= 50) then begin
                                set_local_var(1, 2);
                            end
                            else begin
                                if (local_var(0) <= 75) then begin
                                    set_local_var(1, 3);
                                end
                                else begin
                                    set_local_var(1, 4);
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    call Node019();
end

procedure Node019
begin
    gsay_reply(139, 300);
    giq_option(4, 139, 301, Node20a, 49);
    giq_option(4, 139, 302, Node999, 50);
end

procedure Node20a
begin
    set_local_var(3, local_var(3) + 10);
    set_local_var(0, local_var(0) + 10);
    if (local_var(0) <= -75) then begin
        set_local_var(1, -4);
    end
    else begin
        if (local_var(0) <= -50) then begin
            set_local_var(1, -3);
        end
        else begin
            if (local_var(0) <= -25) then begin
                set_local_var(1, -2);
            end
            else begin
                if (local_var(0) <= -10) then begin
                    set_local_var(1, -1);
                end
                else begin
                    if (local_var(0) <= 10) then begin
                        set_local_var(1, 0);
                    end
                    else begin
                        if (local_var(0) <= 25) then begin
                            set_local_var(1, 1);
                        end
                        else begin
                            if (local_var(0) <= 50) then begin
                                set_local_var(1, 2);
                            end
                            else begin
                                if (local_var(0) <= 75) then begin
                                    set_local_var(1, 3);
                                end
                                else begin
                                    set_local_var(1, 4);
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    call Node020();
end

procedure Node020
begin
    gsay_reply(139, 310);
    if (((((metarule(16, 0) - 1) >= (floor(get_critter_stat(dude_obj, 3) / 2) + has_trait(0, dude_obj, 98) + (20 * has_trait(0, dude_obj, 39)))) or ((metarule(16, 0) - 1) >= (5 + (20 * has_trait(0, dude_obj, 39))))) == 0) and ((party_member_obj(16777323) != 0) == 0)) then begin
        giq_option(4, 139, 311, Node951, 49);
    end
    giq_option(4, 139, 312, Node001, 50);
    giq_option(4, 139, 313, Node999, 51);
    giq_option(4, 139, 314, Node999, 50);
end

procedure Node021
begin
    if ((get_critter_stat(dude_obj, 3) <= 1) and (has_trait(0, dude_obj, 39) == 0)) then begin
        gsay_message(139, 330, 50);
    end
    else begin
        gsay_reply(139, 320);
        giq_option(4, 139, 321, Node800, 49);
        giq_option(4, 139, 322, Node001, 51);
    end
end

procedure Node022
begin
    gsay_reply(139, 330);
    giq_option(4, 139, 333, Node999, 50);
    giq_option(4, 139, 334, Node999, 51);
end

procedure Node023
begin
    gsay_reply(139, 340);
    giq_option(4, 139, 341, Node005, 50);
    giq_option(4, 139, 342, Node999, 50);
end

procedure Node024
begin
    gsay_reply(139, 350);
    giq_option(4, 139, 351, Node001, 50);
    giq_option(4, 139, 352, Node999, 50);
end

procedure Node025
begin
    gsay_reply(139, 360);
    giq_option(1, 139, 372, Node953, 50);
    giq_option(1, 139, 373, Node953, 51);
    giq_option(1, 139, 374, Node953, 51);
    giq_option(1, 139, 375, Node953, 50);
end

procedure Node070
begin
    if (has_trait(1, self_obj, 666)) then begin
        float_msg(self_obj, message_str(139, 3000), 2);
    end
    if (party_member_obj(obj_pid(self_obj)) != 0) then begin
        debug_msg("abandon party: " + obj_name(self_obj));
        party_remove(self_obj);
    end
    if ((obj_pid(self_obj) == 16777380) or (obj_pid(self_obj) == 16777379)) then begin
        debug_msg("start: set_dude_was_married");
        if ((global_var(6) != 0) and ((global_var(449) != 0) == 0)) then begin
            debug_msg("   GVAR_PLAYER_WAS_MARRIED before == " + global_var(449));
            set_global_var(449, global_var(6));
            debug_msg("   GVAR_PLAYER_WAS_MARRIED after == " + global_var(449));
            set_global_var(6, 0);
        end
        debug_msg("finished: set_dude_was_married");
    end
    if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
        critter_add_trait(self_obj, 1, 6, local_var(12));
        set_local_var(12, -1);
    end
    debug_msg("" + obj_name(self_obj) + " has abandoned the party");
end

procedure Node071
begin
    set_local_var(14, 1);
    if (has_trait(1, self_obj, 666)) then begin
        float_msg(self_obj, message_str(139, 370), 2);
    end
    if (party_member_obj(obj_pid(self_obj)) != 0) then begin
        debug_msg("abandon party: " + obj_name(self_obj));
        party_remove(self_obj);
    end
    if ((obj_pid(self_obj) == 16777380) or (obj_pid(self_obj) == 16777379)) then begin
        debug_msg("start: set_dude_was_married");
        if ((global_var(6) != 0) and ((global_var(449) != 0) == 0)) then begin
            debug_msg("   GVAR_PLAYER_WAS_MARRIED before == " + global_var(449));
            set_global_var(449, global_var(6));
            debug_msg("   GVAR_PLAYER_WAS_MARRIED after == " + global_var(449));
            set_global_var(6, 0);
        end
        debug_msg("finished: set_dude_was_married");
    end
    if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
        critter_add_trait(self_obj, 1, 6, local_var(12));
        set_local_var(12, -1);
    end
    debug_msg("" + obj_name(self_obj) + " has abandoned the party");
    critter_add_trait(self_obj, 1, 6, 49);
end

procedure Node072
begin
    if (has_trait(1, self_obj, 666)) then begin
        float_msg(self_obj, message_str(139, 3002), 2);
    end
    if (party_member_obj(obj_pid(self_obj)) != 0) then begin
        debug_msg("abandon party: " + obj_name(self_obj));
        party_remove(self_obj);
    end
    if ((obj_pid(self_obj) == 16777380) or (obj_pid(self_obj) == 16777379)) then begin
        debug_msg("start: set_dude_was_married");
        if ((global_var(6) != 0) and ((global_var(449) != 0) == 0)) then begin
            debug_msg("   GVAR_PLAYER_WAS_MARRIED before == " + global_var(449));
            set_global_var(449, global_var(6));
            debug_msg("   GVAR_PLAYER_WAS_MARRIED after == " + global_var(449));
            set_global_var(6, 0);
        end
        debug_msg("finished: set_dude_was_married");
    end
    if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
        critter_add_trait(self_obj, 1, 6, local_var(12));
        set_local_var(12, -1);
    end
    debug_msg("" + obj_name(self_obj) + " has abandoned the party");
end

procedure Node073
begin
    if (has_trait(1, self_obj, 666)) then begin
        float_msg(self_obj, message_str(139, 370), 2);
    end
    if (party_member_obj(obj_pid(self_obj)) != 0) then begin
        debug_msg("abandon party: " + obj_name(self_obj));
        party_remove(self_obj);
    end
    if ((obj_pid(self_obj) == 16777380) or (obj_pid(self_obj) == 16777379)) then begin
        debug_msg("start: set_dude_was_married");
        if ((global_var(6) != 0) and ((global_var(449) != 0) == 0)) then begin
            debug_msg("   GVAR_PLAYER_WAS_MARRIED before == " + global_var(449));
            set_global_var(449, global_var(6));
            debug_msg("   GVAR_PLAYER_WAS_MARRIED after == " + global_var(449));
            set_global_var(6, 0);
        end
        debug_msg("finished: set_dude_was_married");
    end
    if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
        critter_add_trait(self_obj, 1, 6, local_var(12));
        set_local_var(12, -1);
    end
    debug_msg("" + obj_name(self_obj) + " has abandoned the party");
end

procedure Node074
begin
    set_local_var(14, 1);
    set_local_var(6, 1);
    if (has_trait(1, self_obj, 666)) then begin
        float_msg(self_obj, message_str(139, 370), 2);
    end
    if (party_member_obj(obj_pid(self_obj)) != 0) then begin
        debug_msg("abandon party: " + obj_name(self_obj));
        party_remove(self_obj);
    end
    if ((obj_pid(self_obj) == 16777380) or (obj_pid(self_obj) == 16777379)) then begin
        debug_msg("start: set_dude_was_married");
        if ((global_var(6) != 0) and ((global_var(449) != 0) == 0)) then begin
            debug_msg("   GVAR_PLAYER_WAS_MARRIED before == " + global_var(449));
            set_global_var(449, global_var(6));
            debug_msg("   GVAR_PLAYER_WAS_MARRIED after == " + global_var(449));
            set_global_var(6, 0);
        end
        debug_msg("finished: set_dude_was_married");
    end
    if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
        critter_add_trait(self_obj, 1, 6, local_var(12));
        set_local_var(12, -1);
    end
    debug_msg("" + obj_name(self_obj) + " has abandoned the party");
    critter_add_trait(self_obj, 1, 6, 49);
end

procedure Node075
begin
    if (has_trait(1, self_obj, 666)) then begin
        float_msg(self_obj, message_str(139, 371), 2);
    end
    if (party_member_obj(obj_pid(self_obj)) != 0) then begin
        debug_msg("abandon party: " + obj_name(self_obj));
        party_remove(self_obj);
    end
    if ((obj_pid(self_obj) == 16777380) or (obj_pid(self_obj) == 16777379)) then begin
        debug_msg("start: set_dude_was_married");
        if ((global_var(6) != 0) and ((global_var(449) != 0) == 0)) then begin
            debug_msg("   GVAR_PLAYER_WAS_MARRIED before == " + global_var(449));
            set_global_var(449, global_var(6));
            debug_msg("   GVAR_PLAYER_WAS_MARRIED after == " + global_var(449));
            set_global_var(6, 0);
        end
        debug_msg("finished: set_dude_was_married");
    end
    if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
        critter_add_trait(self_obj, 1, 6, local_var(12));
        set_local_var(12, -1);
    end
    debug_msg("" + obj_name(self_obj) + " has abandoned the party");
    set_local_var(10, game_time);
end

procedure Node076
begin
    set_local_var(14, 1);
    if (has_trait(1, self_obj, 666)) then begin
        float_msg(self_obj, message_str(139, 370), 2);
    end
    if (party_member_obj(obj_pid(self_obj)) != 0) then begin
        debug_msg("abandon party: " + obj_name(self_obj));
        party_remove(self_obj);
    end
    if ((obj_pid(self_obj) == 16777380) or (obj_pid(self_obj) == 16777379)) then begin
        debug_msg("start: set_dude_was_married");
        if ((global_var(6) != 0) and ((global_var(449) != 0) == 0)) then begin
            debug_msg("   GVAR_PLAYER_WAS_MARRIED before == " + global_var(449));
            set_global_var(449, global_var(6));
            debug_msg("   GVAR_PLAYER_WAS_MARRIED after == " + global_var(449));
            set_global_var(6, 0);
        end
        debug_msg("finished: set_dude_was_married");
    end
    if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
        critter_add_trait(self_obj, 1, 6, local_var(12));
        set_local_var(12, -1);
    end
    debug_msg("" + obj_name(self_obj) + " has abandoned the party");
    critter_add_trait(self_obj, 1, 6, 49);
end

procedure Node077
begin
    gsay_reply(139, 6010);
    if (party_member_obj(16777305) != 0) then begin
        giq_option(4, 139, 6011, Node079, 50);
    end
    if ((global_var(174) bwand 8) != 0) then begin
        giq_option(4, 139, 6012, Node078, 50);
    end
    giq_option(4, 139, 6013, Node079, 50);
end

procedure Node078
begin
    gsay_reply(139, 6020);
    giq_option(4, 139, message_str(14, 352), Node079, 50);
end

procedure Node079
begin
    gsay_reply(139, 6021);
    giq_option(4, 139, 6022, Node081, 50);
    if (has_skill(dude_obj, 7) >= 40) then begin
        giq_option(4, 139, 6023, Node081, 50);
    end
end

procedure Node080
begin
    gsay_reply(139, 6030);
    giq_option(4, 139, message_str(14, 352), Node081, 50);
end

procedure Node081
begin
    set_local_var(19, 1);
    gsay_reply(139, 6040);
    giq_option(4, 139, 6041, Node1000, 50);
    if ((global_var(174) bwand 8) != 0) then begin
        giq_option(4, 139, 6042, Node083, 50);
    end
    if (party_member_obj(16777305) != 0) then begin
        giq_option(4, 139, 6043, Node082, 50);
    end
end

procedure Node082
begin
    gsay_reply(139, 6050);
    giq_option(4, 139, 6051, Node083, 50);
    giq_option(4, 139, 6052, Node083, 50);
end

procedure Node083
begin
    gsay_reply(139, 6060);
    giq_option(4, 139, 6061, Node084, 50);
end

procedure Node084
begin
    gsay_reply(139, 6070);
    giq_option(4, 139, 6071, Node085, 50);
    giq_option(4, 139, 6072, Node086, 50);
end

procedure Node085
begin
    gsay_reply(139, 6080 + (get_critter_stat(dude_obj, 34) == 1));
    giq_option(4, 139, message_str(14, 352), Node086, 50);
end

procedure Node086
begin
    set_global_var(174, global_var(174) bwor 256);
    gsay_reply(139, 6082);
    giq_option(4, 139, 6083, Node087, 50);
    giq_option(4, 139, 6084, Node999, 50);
end

procedure Node087
begin
    gsay_reply(139, 6090);
    giq_option(4, 139, 6091, Node1000, 50);
    giq_option(4, 139, 6092, Node999, 50);
end

procedure Node800
begin
    if (local_var(13) == 0) then begin
        set_local_var(13, 1);
        set_global_var(0, global_var(0) + 5);
        debug_msg("Player gains " + 5 + " Karma Points.");
        set_global_var(37, 0);
        set_global_var(38, 0);
        set_global_var(39, 0);
        set_global_var(40, 0);
        set_global_var(41, 0);
        set_global_var(42, 0);
        set_global_var(43, 0);
        set_global_var(44, 0);
        set_global_var(45, 0);
        tmp_gen_rep := global_var(0);
        if (has_trait(0, dude_obj, 95)) then begin
            tmp_gen_rep := global_var(0) * 2;
        end
        if (tmp_gen_rep >= 1000) then begin
            set_global_var(37, 1);
        end
        else begin
            if (tmp_gen_rep >= 750) then begin
                set_global_var(38, 1);
            end
            else begin
                if (tmp_gen_rep >= 500) then begin
                    set_global_var(39, 1);
                end
                else begin
                    if (tmp_gen_rep >= 250) then begin
                        set_global_var(40, 1);
                    end
                    else begin
                        if (tmp_gen_rep > -250) then begin
                            set_global_var(41, 1);
                        end
                        else begin
                            if (tmp_gen_rep > -500) then begin
                                set_global_var(42, 1);
                            end
                            else begin
                                if (tmp_gen_rep > -750) then begin
                                    set_global_var(43, 1);
                                end
                                else begin
                                    if (tmp_gen_rep > -1000) then begin
                                        set_global_var(44, 1);
                                    end
                                    else begin
                                        set_global_var(45, 1);
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        set_global_var(51, global_var(51) + 10);
    end
    if ((critter_state(self_obj) bwand 1) == 0) then begin
        if (local_var(11) == 0) then begin
            set_local_var(11, 6);
        end
        set_local_var(10, 0);
        if (has_trait(1, self_obj, 6) != 0) then begin
            set_local_var(12, has_trait(1, self_obj, 6));
        end
        critter_add_trait(self_obj, 1, 6, 0);
        party_add(self_obj);
    end
    call Node1000();
end

procedure Node1000
begin
    gsay_reply(139, 1000);
    if (local_var(10) == 0) then begin
        if (local_var(11) == 0) then begin
            set_local_var(11, 6);
        end
        if (get_critter_stat(self_obj, 35) < get_critter_stat(self_obj, 7)) then begin
            giq_option(4, 139, 384, Node1001, 50);
        end
        giq_option(4, 139, 382, Node1008, 50);
        giq_option(4, 139, 383, Node1002, 50);
        if (local_var(11) == 3) then begin
            giq_option(4, 139, 381, Node1007, 50);
        end
        else begin
            giq_option(4, 139, 6125, Node1007, 50);
        end
        if (((global_var(174) bwand 8) != 0) or (party_member_obj(16777305) != 0) and (local_var(19) == 0)) then begin
            giq_option(4, 139, 6000, Node077, 50);
        end
        if (obj_is_carrying_obj_pid(dude_obj, 333) and not((global_var(174) bwand 256) != 0)) then begin
            giq_option(4, 139, 6001, Node081, 50);
        end
    end
    else begin
        giq_option(4, 139, 388, Node1100, 50);
    end
    giq_option(4, 139, 389, Node999, 50);
    giq_option(-3, 139, message_str(14, random(300, 303)), Node999, 50);
    if ((global_var(1072) == 1) or (global_var(1072) == 2)) then begin
        giq_option(4, 139, 4010, MNode001, 50);
    end
    if ((global_var(1072) == 1) or (global_var(1072) == 2)) then begin
        giq_option(-3, 139, 4010, MNode004, 50);
    end
end

procedure Node1001
begin
    if (obj_is_carrying_obj_pid(self_obj, 144)) then begin
        if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
            gfade_out(600);
            PartyHealingItem := obj_carrying_pid_obj(self_obj, 144);
            use_obj_on_obj(PartyHealingItem, self_obj);
            debug_msg(obj_name(self_obj) + " used super stimpak.");
            gfade_in(600);
        end
    end
    else begin
        if (obj_is_carrying_obj_pid(self_obj, 40)) then begin
            if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                gfade_out(600);
                PartyHealingItem := obj_carrying_pid_obj(self_obj, 40);
                use_obj_on_obj(PartyHealingItem, self_obj);
                debug_msg(obj_name(self_obj) + " used stimpak.");
                gfade_in(600);
            end
        end
        else begin
            if (obj_is_carrying_obj_pid(self_obj, 273)) then begin
                if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                    gfade_out(600);
                    PartyHealingItem := obj_carrying_pid_obj(self_obj, 273);
                    use_obj_on_obj(PartyHealingItem, self_obj);
                    debug_msg(obj_name(self_obj) + " used healing powder.");
                    gfade_in(600);
                end
            end
            else begin
                if (obj_is_carrying_obj_pid(self_obj, 91)) then begin
                    if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                        gfade_out(600);
                        use_obj_on_obj(obj_carrying_pid_obj(self_obj, 91), self_obj);
                        debug_msg(obj_name(self_obj) + " used doctor's bag kit.");
                        gfade_in(600);
                    end
                end
                else begin
                    if (obj_is_carrying_obj_pid(self_obj, 47)) then begin
                        if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                            gfade_out(600);
                            use_obj_on_obj(obj_carrying_pid_obj(self_obj, 47), self_obj);
                            debug_msg(obj_name(self_obj) + " used First Aid kit.");
                            gfade_in(600);
                        end
                    end
                    else begin
                        if (has_skill(self_obj, 7) > has_skill(self_obj, 6)) then begin
                            if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                gfade_out(600);
                                if ((60 * (60 * 10)) > 0) then begin
                                    game_time_advance(60 * (60 * 10));
                                end
                                gfade_in(600);
                            end
                            if (is_success(roll_vs_skill(self_obj, 7, 0))) then begin
                                critter_heal(self_obj, random(10, 25));
                                debug_msg(obj_name(self_obj) + " healed some using doctor skill.");
                            end
                        end
                        else begin
                            if ((global_temp == 0) and (combat_is_initialized == 0)) then begin
                                gfade_out(600);
                                if ((15 * (60 * 10)) > 0) then begin
                                    game_time_advance(15 * (60 * 10));
                                end
                                gfade_in(600);
                            end
                            if (is_success(roll_vs_skill(self_obj, 6, 0))) then begin
                                critter_heal(self_obj, random(5, 15));
                                debug_msg(obj_name(self_obj) + " healed some using first aid skill.");
                            end
                        end
                    end
                end
            end
        end
    end
    global_temp := 0;
    if (get_critter_stat(self_obj, 35) == get_critter_stat(self_obj, 7)) then begin
        gsay_reply(139, 1100);
    end
    else begin
        if ((get_critter_stat(self_obj, 35) * 100 / get_critter_stat(self_obj, 7)) >= 90) then begin
            gsay_reply(139, 1200);
        end
        else begin
            if ((get_critter_stat(self_obj, 35) * 100 / get_critter_stat(self_obj, 7)) >= 70) then begin
                gsay_reply(139, 1300);
            end
            else begin
                gsay_reply(139, 1400);
            end
        end
    end
    if (get_critter_stat(self_obj, 35) < get_critter_stat(self_obj, 7)) then begin
        giq_option(4, 139, 384, Node1001, 50);
    end
    giq_option(4, 139, 382, Node1008, 50);
    giq_option(4, 139, 383, Node1002, 50);
    if (local_var(11) == 3) then begin
        giq_option(4, 139, 381, Node1007, 50);
    end
    else begin
        giq_option(4, 139, 6125, Node1007, 50);
    end
    if (((global_var(174) bwand 8) != 0) or (party_member_obj(16777305) != 0) and (local_var(19) == 0)) then begin
        giq_option(4, 139, 6000, Node077, 50);
    end
    if (obj_is_carrying_obj_pid(dude_obj, 333) and not((global_var(174) bwand 256) != 0)) then begin
        giq_option(4, 139, 6001, Node081, 50);
    end
    giq_option(4, 139, 389, Node999, 50);
    giq_option(-3, 139, message_str(14, random(300, 303)), Node999, 50);
end

procedure Node1002
begin
    set_local_var(10, game_time);
    party_remove(self_obj);
    gsay_reply(139, 1500);
    giq_option(4, 139, 6127, Node999, 50);
    giq_option(-3, 139, message_str(14, random(300, 303)), Node999, 50);
end

procedure Node1003
begin
    metarule(43, self_obj);
    gsay_reply(139, 4001);
    giq_option(4, 139, 6128, Node1010, 50);
    if (obj_item_subtype(critter_inven_obj(self_obj, 0)) == 0) then begin
        giq_option(4, 139, 6130, Node1009, 50);
    end
    giq_option(4, 139, 6131, Node1000, 50);
end

procedure Node1004
begin
    set_local_var(11, 3);
    gsay_reply(139, 1700);
    giq_option(4, 139, 6131, Node1000, 50);
    giq_option(4, 139, 389, Node999, 50);
end

procedure Node1005
begin
    set_local_var(11, 6);
    gsay_reply(139, 1800);
    giq_option(4, 139, 6131, Node1000, 50);
    giq_option(4, 139, 389, Node999, 50);
end

procedure Node1006
begin
    set_local_var(11, 9);
    gsay_reply(139, 1900);
    giq_option(4, 139, 6131, Node1000, 50);
    giq_option(4, 139, 389, Node999, 50);
end

procedure Node1007
begin
    gsay_reply(139, 4000);
    if (local_var(11) != 3) then begin
        giq_option(4, 139, 6132, Node1004, 50);
    end
    if (local_var(11) != 6) then begin
        giq_option(4, 139, 6133, Node1005, 50);
    end
    if (local_var(11) != 9) then begin
        giq_option(4, 139, 511, Node1006, 50);
    end
    giq_option(4, 139, 6131, Node1000, 50);
end

procedure Node1008
begin
    gsay_reply(139, 400);
    giq_option(4, 139, 6128, Node1010, 50);
    if ((obj_item_subtype(critter_inven_obj(self_obj, 1)) == 3) or (obj_item_subtype(critter_inven_obj(self_obj, 2)) == 3)) then begin
        giq_option(4, 139, 6129, Node1003, 50);
    end
    if (obj_item_subtype(critter_inven_obj(self_obj, 0)) == 0) then begin
        giq_option(4, 139, 6130, Node1009, 50);
    end
    giq_option(4, 139, 6131, Node1000, 50);
end

procedure Node1009
begin
    if (obj_item_subtype(critter_inven_obj(self_obj, 0)) == 0) then begin
        restock_obj := critter_inven_obj(self_obj, 0);
        debug_msg("armour pid == " + obj_pid(restock_obj));
        rm_obj_from_inven(self_obj, restock_obj);
        add_obj_to_inven(self_obj, restock_obj);
    end
    gsay_reply(139, 4003);
    giq_option(4, 139, 6128, Node1010, 50);
    if ((obj_item_subtype(critter_inven_obj(self_obj, 1)) == 3) or (obj_item_subtype(critter_inven_obj(self_obj, 2)) == 3)) then begin
        giq_option(4, 139, 6129, Node1003, 50);
    end
    giq_option(4, 139, 6131, Node1000, 50);
end

procedure Node1010
begin
    gsay_reply(139, 4002);
    if ((obj_item_subtype(critter_inven_obj(self_obj, 1)) == 3) or (obj_item_subtype(critter_inven_obj(self_obj, 2)) == 3)) then begin
        giq_option(4, 139, 6129, Node1003, 50);
    end
    if (obj_item_subtype(critter_inven_obj(self_obj, 0)) == 0) then begin
        giq_option(4, 139, 6130, Node1009, 50);
    end
    giq_option(4, 139, 6131, Node1000, 50);
end

procedure Node1100
begin
    if ((get_critter_stat(dude_obj, 3) <= 1) and not(has_trait(0, dude_obj, 39))) then begin
        if (party_member_obj(obj_pid(self_obj)) != 0) then begin
            debug_msg("abandon party: " + obj_name(self_obj));
            party_remove(self_obj);
        end
        if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
            critter_add_trait(self_obj, 1, 6, local_var(12));
            set_local_var(12, -1);
        end
        debug_msg("" + obj_name(self_obj) + " has abandoned the party");
        gsay_reply(139, 371);
        giq_option(1, 139, message_str(14, 10007), Node999, 50);
    end
    else begin
        if (((metarule(16, 0) - 1) >= (floor(get_critter_stat(dude_obj, 3) / 2) + has_trait(0, dude_obj, 98) + (20 * has_trait(0, dude_obj, 39)))) or ((metarule(16, 0) - 1) >= (5 + (20 * has_trait(0, dude_obj, 39))))) then begin
            if (party_member_obj(obj_pid(self_obj)) != 0) then begin
                debug_msg("abandon party: " + obj_name(self_obj));
                party_remove(self_obj);
            end
            if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
                critter_add_trait(self_obj, 1, 6, local_var(12));
                set_local_var(12, -1);
            end
            debug_msg("" + obj_name(self_obj) + " has abandoned the party");
            gsay_reply(139, 2000);
            giq_option(1, 139, message_str(14, 10007), Node999, 50);
        end
        else begin
            if ((global_var(51) <= -15) and not(has_trait(0, dude_obj, 39))) then begin
                if (party_member_obj(obj_pid(self_obj)) != 0) then begin
                    debug_msg("abandon party: " + obj_name(self_obj));
                    party_remove(self_obj);
                end
                if ((local_var(12) != -1) and (has_trait(1, self_obj, 6) == 0)) then begin
                    critter_add_trait(self_obj, 1, 6, local_var(12));
                    set_local_var(12, -1);
                end
                debug_msg("" + obj_name(self_obj) + " has abandoned the party");
                gsay_reply(139, 2100);
                giq_option(1, 139, message_str(14, 10007), Node999, 50);
            end
            else begin
                if ((critter_state(self_obj) bwand 1) == 0) then begin
                    if (local_var(11) == 0) then begin
                        set_local_var(11, 6);
                    end
                    set_local_var(10, 0);
                    if (has_trait(1, self_obj, 6) != 0) then begin
                        set_local_var(12, has_trait(1, self_obj, 6));
                    end
                    critter_add_trait(self_obj, 1, 6, 0);
                    party_add(self_obj);
                end
                debug_msg("join party: " + obj_name(self_obj));
                gsay_reply(139, 2200);
                if (local_var(11) == 0) then begin
                    set_local_var(11, 6);
                end
                giq_option(4, 139, 389, Node999, 50);
                if (((global_var(174) bwand 8) != 0) or (party_member_obj(16777305) != 0) and (local_var(19) == 0)) then begin
                    giq_option(4, 139, 6000, Node077, 50);
                end
                if (obj_is_carrying_obj_pid(dude_obj, 333) and ((global_var(174) bwand 256) == 0)) then begin
                    giq_option(4, 139, 6001, Node081, 50);
                end
                if (get_critter_stat(self_obj, 35) < get_critter_stat(self_obj, 7)) then begin
                    giq_option(4, 139, 384, Node1001, 50);
                end
                giq_option(4, 139, 401, Node1007, 50);
                giq_option(4, 139, 382, Node1008, 50);
                giq_option(4, 139, 383, Node1002, 50);
                giq_option(-3, 139, message_str(14, random(300, 303)), Node999, 50);
            end
        end
    end
end

procedure armour_change
begin
    if (critter_inven_obj(self_obj, 0) != ArmourVal) then begin
        ArmourVal := obj_pid(critter_inven_obj(self_obj, 0));
        if ((critter_inven_obj(self_obj, 0) == 0) and (global_var(1015) == 0)) then begin
            metarule3(107, self_obj, 16777295, 0);
        end
        else begin
            if ((critter_inven_obj(self_obj, 0) == 0) and (global_var(1015) == 1)) then begin
                metarule3(107, self_obj, 16777229, 0);
            end
            else begin
                if ((obj_pid(critter_inven_obj(self_obj, 0)) == 1) or (obj_pid(critter_inven_obj(self_obj, 0)) == 379)) then begin
                    metarule3(107, self_obj, 16777260, 0);
                end
                else begin
                    if ((obj_pid(critter_inven_obj(self_obj, 0)) == 232) or (obj_pid(critter_inven_obj(self_obj, 0)) == 3)) then begin
                        metarule3(107, self_obj, 16777217, 0);
                    end
                    else begin
                        if ((obj_pid(critter_inven_obj(self_obj, 0)) == 349) or (obj_pid(critter_inven_obj(self_obj, 0)) == 348)) then begin
                            metarule3(107, self_obj, 16777287, 0);
                        end
                        else begin
                            if ((obj_pid(critter_inven_obj(self_obj, 0)) == 240) or (obj_pid(critter_inven_obj(self_obj, 0)) == 380) or (obj_pid(critter_inven_obj(self_obj, 0)) == 2)) then begin
                                metarule3(107, self_obj, 16777230, 0);
                            end
                            else begin
                                if ((obj_pid(critter_inven_obj(self_obj, 0)) == 74) or (obj_pid(critter_inven_obj(self_obj, 0)) == 265)) then begin
                                    metarule3(107, self_obj, 16777229, 0);
                                end
                                else begin
                                    if ((obj_pid(critter_inven_obj(self_obj, 0)) == 239) or (obj_pid(critter_inven_obj(self_obj, 0)) == 17) or (obj_pid(critter_inven_obj(self_obj, 0)) == 381)) then begin
                                        metarule3(107, self_obj, 16777226, 0);
                                    end
                                    else begin
                                        if ((obj_pid(critter_inven_obj(self_obj, 0)) == 524) or (obj_pid(critter_inven_obj(self_obj, 0)) == 113)) then begin
                                            metarule3(107, self_obj, 16777218, 0);
                                        end
                                        else begin
                                            if (obj_pid(critter_inven_obj(self_obj, 0)) == 554) then begin
                                                metarule3(107, self_obj, 16777301, 0);
                                            end
                                            else begin
                                                if (obj_pid(critter_inven_obj(self_obj, 0)) == 580) then begin
                                                    metarule3(107, self_obj, 16777328, 0);
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        restock_obj := critter_inven_obj(self_obj, 1);
        debug_msg("armour pid == " + obj_pid(restock_obj));
        rm_obj_from_inven(self_obj, restock_obj);
        add_obj_to_inven(self_obj, restock_obj);
    end
end

procedure MNode001
begin
    gsay_reply(139, 4011);
    giq_option(1, 139, 4012, MNode002, 49);
    giq_option(1, 139, 4013, Node1000, 50);
end

procedure MNode002
begin
    gsay_reply(139, 4014);
    if (has_skill(dude_obj, 14) > 105) then begin
        giq_option(1, 139, 4015, MNode003, 50);
    end
    giq_option(1, 139, 4016, Node1000, 50);
end

procedure MNode003
begin
    set_global_var(1072, 2);
    gsay_reply(139, 4017);
    giq_option(1, 139, 4018, Node999, 50);
end

procedure MNode004
begin
    gsay_reply(139, 4021);
    giq_option(1, 139, 4022, MNode005, 49);
    giq_option(1, 139, 4023, Node1000, 50);
end

procedure MNode005
begin
    gsay_reply(139, 4024);
    if (has_skill(dude_obj, 14) > 105) then begin
        giq_option(1, 139, 4025, MNode006, 50);
    end
    giq_option(1, 139, 4026, Node1000, 50);
end

procedure MNode006
begin
    set_global_var(1072, 2);
    gsay_reply(139, 4027);
    giq_option(1, 139, 4028, Node999, 50);
end

procedure use_obj_on_p_proc
begin
    if ((obj_pid(obj_being_used_with) == 39) or (obj_pid(obj_being_used_with) == 38)) then begin
        script_overrides;
        display_msg(message_str(14, 20000));
    end
    if ((obj_pid(obj_being_used_with) == 310) or (obj_pid(obj_being_used_with) == 311) or (obj_pid(obj_being_used_with) == 469)) then begin
        if (local_var(17) == 0) then begin
            set_local_var(17, 1);
            float_msg(self_obj, message_str(139, 5100), 3);
        end
    end
    if ((obj_pid(obj_being_used_with) == 48) and (local_var(17) == 2)) then begin
        obj_set_light_level(self_obj, 0, 0);
        set_local_var(17, 0);
        float_msg(self_obj, message_str(139, 5101), 8);
    end
    if (obj_pid(obj_being_used_with) == 473) then begin
        script_overrides;
        float_msg(self_obj, message_str(139, 6106), 8);
    end
    if ((obj_pid(obj_being_used_with) == 281) or (obj_pid(obj_being_used_with) == 282)) then begin
        script_overrides;
        float_msg(self_obj, message_str(139, 6107), 8);
    end
    if ((obj_pid(obj_being_used_with) == 321) or (obj_pid(obj_being_used_with) == 322) or (obj_pid(obj_being_used_with) == 323) or (obj_pid(obj_being_used_with) == 324)) then begin
        script_overrides;
        if (obj_pid(obj_being_used_with) == 321) then begin
            float_msg(self_obj, message_str(139, 6110) + message_str(139, 6111), 8);
        end
        else begin
            if (obj_pid(obj_being_used_with) == 322) then begin
                float_msg(self_obj, message_str(139, 6110) + message_str(139, 6112), 8);
            end
            else begin
                if (obj_pid(obj_being_used_with) == 323) then begin
                    float_msg(self_obj, message_str(139, 6110) + message_str(139, 6113), 8);
                end
                else begin
                    if (obj_pid(obj_being_used_with) == 324) then begin
                        float_msg(self_obj, message_str(139, 6110) + message_str(139, 6114), 8);
                    end
                end
            end
        end
        if (source_obj == dude_obj) then begin
            restock_obj := obj_carrying_pid_obj(dude_obj, obj_pid(obj_being_used_with));
            if ((critter_inven_obj(dude_obj, 2) == restock_obj) or (critter_inven_obj(dude_obj, 1) == restock_obj)) then begin
                metarule(43, dude_obj);
            end
            rm_obj_from_inven(dude_obj, restock_obj);
            destroy_object(restock_obj);
            restock_obj := 0;
        end
    end
    if (obj_pid(obj_being_used_with) == 606) then begin
        script_overrides;
        float_msg(self_obj, message_str(139, 6105), 8);
    end
    if (obj_pid(obj_being_used_with) == 618) then begin
        script_overrides;
        float_msg(self_obj, message_str(139, 6120), 8);
    end
    if (obj_pid(obj_being_used_with) == 317) then begin
        script_overrides;
        float_msg(self_obj, message_str(139, 6121), 8);
    end
end

