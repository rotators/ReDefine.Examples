procedure start;
procedure Get_Facing(variable arg0, variable arg1);
procedure Calculate_Facing_Bonus(variable arg0, variable arg1);

variable range_perks;
variable math;
variable float_math := 0.00000;

procedure modify_critter(variable arg0);
procedure CalculateBonuses;
procedure HealCritter(variable arg0);
procedure MapEnterHealCritter(variable arg0);


procedure start
begin
    variable LVar0 := 0;
    variable LVar1 := 0;
    variable LVar2 := 0;
    variable LVar3 := 0;
    variable LVar4 := 0;
    if (init_hook) then begin
        set_sfall_global(4506, get_ini_setting("Damage.ini|MISC|FacingBonusToHitBackToFront"));
        set_sfall_global(4507, get_ini_setting("Damage.ini|MISC|FacingBonusToHitRearFlank"));
        set_sfall_global(4508, get_ini_setting("Damage.ini|MISC|FacingBonusToHitFrontFlank"));
        set_sfall_global(4509, get_ini_setting("Damage.ini|MISC|FacingBonusToHitFaceToFace"));
        set_sfall_global(6200, get_ini_setting("Damage.ini|MISC|FacingBonusEnable"));
    end
    else begin
        LVar1 := get_sfall_arg;
        LVar0 := get_sfall_arg;
        LVar3 := get_sfall_arg;
        LVar4 := get_sfall_arg;
        set_sfall_global(4420, LVar1);
        if (get_sfall_global_int(2095) >= 1) then begin
            set_target_knockback(dude_obj, 0, 0);
            set_attacker_knockback(dude_obj, 0, 0);
            if (get_sfall_global_int(2095) >= 2) then begin
                set_target_knockback(LVar0, 0, 0);
                set_attacker_knockback(LVar0, 0, 0);
                set_target_knockback(LVar3, 0, 0);
                set_attacker_knockback(LVar3, 0, 0);
            end
        end
        if ((LVar0 > 0) and (LVar3 > 0)) then begin
            if (((obj_in_party(LVar0)) == 0) and (LVar0 != dude_obj)) then begin
                if (get_sfall_global_int(2191) > 0) then begin
                    LVar2 := LVar1 + get_sfall_global_int(2191) + Calculate_Facing_Bonus(LVar3, LVar0);
                    if (LVar2 > 100) then begin
                        LVar2 := 100;
                    end
                    set_sfall_global(4420, LVar2);
                    set_sfall_return(LVar2);
                end
            end
            else begin
                if ((obj_in_party(LVar0)) or (LVar0 == dude_obj)) then begin
                    if (LVar0 == dude_obj) then begin
                        if (has_fake_perk("True Aim")) then begin
                            LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                            LVar2 := LVar1 + has_fake_perk("True Aim");
                            if (LVar2 > (95 + has_fake_perk("True Aim"))) then begin
                                LVar2 := 95 + has_fake_perk("True Aim");
                            end
                            set_sfall_global(4420, LVar2);
                            set_sfall_return(LVar2);
                        end
                    end
                    else begin
                        if (obj_pid(LVar0) == 16777376) then begin
                            if (has_fake_perk("Combat Skills(Myron)") > 0) then begin
                                LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                LVar2 := LVar1 + (has_fake_perk("Combat Skills(Myron)") * get_sfall_global_int(151));
                                if (LVar2 > (95 + has_fake_perk("Combat Skills(Myron)"))) then begin
                                    LVar2 := 95 + has_fake_perk("Combat Skills(Myron)");
                                end
                                set_sfall_global(4420, LVar2);
                                set_sfall_return(LVar2);
                            end
                        end
                        else begin
                            if (obj_pid(LVar0) == 16777377) then begin
                                if (has_fake_perk("Combat Skills(Marcus)") > 0) then begin
                                    LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                    LVar2 := LVar1 + (has_fake_perk("Combat Skills(Marcus)") * get_sfall_global_int(151));
                                    if (LVar2 > (95 + has_fake_perk("Combat Skills(Marcus)"))) then begin
                                        LVar2 := 95 + has_fake_perk("Combat Skills(Marcus)");
                                    end
                                    set_sfall_global(4420, LVar2);
                                    set_sfall_return(LVar2);
                                end
                            end
                            else begin
                                if (obj_pid(LVar0) == 16777305) then begin
                                    if (has_fake_perk("Combat Skills(Cassidy)") > 0) then begin
                                        LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                        LVar2 := LVar1 + (has_fake_perk("Combat Skills(Cassidy)") * get_sfall_global_int(151));
                                        if (LVar2 > (95 + has_fake_perk("Combat Skills(Cassidy)"))) then begin
                                            LVar2 := 95 + has_fake_perk("Combat Skills(Cassidy)");
                                        end
                                        set_sfall_global(4420, LVar2);
                                        set_sfall_return(LVar2);
                                    end
                                end
                                else begin
                                    if (obj_pid(LVar0) == 16777313) then begin
                                        if (has_fake_perk("Combat Skills(Sulik)") > 0) then begin
                                            LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                            LVar2 := LVar1 + (has_fake_perk("Combat Skills(Sulik)") * get_sfall_global_int(151));
                                            if (LVar2 > (95 + has_fake_perk("Combat Skills(Sulik)"))) then begin
                                                LVar2 := 95 + has_fake_perk("Combat Skills(Sulik)");
                                            end
                                            set_sfall_global(4420, LVar2);
                                            set_sfall_return(LVar2);
                                        end
                                    end
                                    else begin
                                        if (obj_pid(LVar0) == 16777323) then begin
                                            if (has_fake_perk("Combat Skills(Lenny)") > 0) then begin
                                                LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                LVar2 := LVar1 + (has_fake_perk("Combat Skills(Lenny)") * get_sfall_global_int(151));
                                                if (LVar2 > (95 + has_fake_perk("Combat Skills(Lenny)"))) then begin
                                                    LVar2 := 95 + has_fake_perk("Combat Skills(Lenny)");
                                                end
                                                set_sfall_global(4420, LVar2);
                                                set_sfall_return(LVar2);
                                            end
                                        end
                                        else begin
                                            if (obj_pid(LVar0) == 16777352) then begin
                                                if (has_fake_perk("Combat Skills(Cyberdog)") > 0) then begin
                                                    LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                    LVar2 := LVar1 + (has_fake_perk("Combat Skills(Cyberdog)") * get_sfall_global_int(151));
                                                    if (LVar2 > (95 + has_fake_perk("Combat Skills(Cyberdog)"))) then begin
                                                        LVar2 := 95 + has_fake_perk("Combat Skills(Cyberdog)");
                                                    end
                                                    set_sfall_global(4420, LVar2);
                                                    set_sfall_return(LVar2);
                                                end
                                            end
                                            else begin
                                                if (obj_pid(LVar0) == 16777368) then begin
                                                    if (has_fake_perk("Combat Skills(Goris)") > 0) then begin
                                                        LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                        LVar2 := LVar1 + (has_fake_perk("Combat Skills(Goris)") * get_sfall_global_int(151));
                                                        if (LVar2 > (95 + has_fake_perk("Combat Skills(Goris)"))) then begin
                                                            LVar2 := 95 + has_fake_perk("Combat Skills(Goris)");
                                                        end
                                                        set_sfall_global(4420, LVar2);
                                                        set_sfall_return(LVar2);
                                                    end
                                                end
                                                else begin
                                                    if (obj_pid(LVar0) == 16777379) then begin
                                                        if (has_fake_perk("Combat Skills(Davin)") > 0) then begin
                                                            LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                            LVar2 := LVar1 + (has_fake_perk("Combat Skills(Davin)") * get_sfall_global_int(151));
                                                            if (LVar2 > (95 + has_fake_perk("Combat Skills(Davin)"))) then begin
                                                                LVar2 := 95 + has_fake_perk("Combat Skills(Davin)");
                                                            end
                                                            set_sfall_global(4420, LVar2);
                                                            set_sfall_return(LVar2);
                                                        end
                                                    end
                                                    else begin
                                                        if (obj_pid(LVar0) == 16777380) then begin
                                                            if (has_fake_perk("Combat Skills(Miria)") > 0) then begin
                                                                LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                LVar2 := LVar1 + (has_fake_perk("Combat Skills(Miria)") * get_sfall_global_int(151));
                                                                if (LVar2 > (95 + has_fake_perk("Combat Skills(Miria)"))) then begin
                                                                    LVar2 := 95 + has_fake_perk("Combat Skills(Miria)");
                                                                end
                                                                set_sfall_global(4420, LVar2);
                                                                set_sfall_return(LVar2);
                                                            end
                                                        end
                                                        else begin
                                                            if (obj_pid(LVar0) == 16777291) then begin
                                                                if (has_fake_perk("Combat Skills(Robobrain)") > 0) then begin
                                                                    LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                    LVar2 := LVar1 + (has_fake_perk("Combat Skills(Robobrain)") * get_sfall_global_int(151));
                                                                    if (LVar2 > (95 + has_fake_perk("Combat Skills(Robobrain)"))) then begin
                                                                        LVar2 := 95 + has_fake_perk("Combat Skills(Robobrain)");
                                                                    end
                                                                    set_sfall_global(4420, LVar2);
                                                                    set_sfall_return(LVar2);
                                                                end
                                                            end
                                                            else begin
                                                                if (obj_pid(LVar0) == 16777278) then begin
                                                                    if (has_fake_perk("Combat Skills(Vic)") > 0) then begin
                                                                        LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                        LVar2 := LVar1 + (has_fake_perk("Combat Skills(Vic)") * get_sfall_global_int(151));
                                                                        if (LVar2 > (95 + has_fake_perk("Combat Skills(Vic)"))) then begin
                                                                            LVar2 := 95 + has_fake_perk("Combat Skills(Vic)");
                                                                        end
                                                                        set_sfall_global(4420, LVar2);
                                                                        set_sfall_return(LVar2);
                                                                    end
                                                                end
                                                                else begin
                                                                    if (obj_pid(LVar0) == 16777558) then begin
                                                                        if (has_fake_perk("Combat Skills(Dogmeat)") > 0) then begin
                                                                            LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                            LVar2 := LVar1 + (has_fake_perk("Combat Skills(Dogmeat)") * get_sfall_global_int(151));
                                                                            if (LVar2 > (95 + has_fake_perk("Combat Skills(Dogmeat)"))) then begin
                                                                                LVar2 := 95 + has_fake_perk("Combat Skills(Dogmeat)");
                                                                            end
                                                                            set_sfall_global(4420, LVar2);
                                                                            set_sfall_return(LVar2);
                                                                        end
                                                                    end
                                                                    else begin
                                                                        if (obj_pid(LVar0) == 16777687) then begin
                                                                            if (has_fake_perk("Combat Skills(K9)") > 0) then begin
                                                                                LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                                LVar2 := LVar1 + (has_fake_perk("Combat Skills(K9)") * get_sfall_global_int(151));
                                                                                if (LVar2 > (95 + has_fake_perk("Combat Skills(K9)"))) then begin
                                                                                    LVar2 := 95 + has_fake_perk("Combat Skills(K9)");
                                                                                end
                                                                                set_sfall_global(4420, LVar2);
                                                                                set_sfall_return(LVar2);
                                                                            end
                                                                        end
                                                                        else begin
                                                                            if (obj_pid(LVar0) == 16777785) then begin
                                                                                if (has_fake_perk("Combat Skills(Skynet)") > 0) then begin
                                                                                    LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                                    LVar2 := LVar1 + (has_fake_perk("Combat Skills(Skynet)") * get_sfall_global_int(151));
                                                                                    if (LVar2 > (95 + has_fake_perk("Combat Skills(Skynet)"))) then begin
                                                                                        LVar2 := 95 + has_fake_perk("Combat Skills(Skynet)");
                                                                                    end
                                                                                    set_sfall_global(4420, LVar2);
                                                                                    set_sfall_return(LVar2);
                                                                                end
                                                                            end
                                                                            else begin
                                                                                if (obj_pid(LVar0) == 16777859) then begin
                                                                                    if (has_fake_perk("Combat Skills(Klint)") > 0) then begin
                                                                                        LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                                        LVar2 := LVar1 + (has_fake_perk("Combat Skills(Klint)") * get_sfall_global_int(151));
                                                                                        if (LVar2 > (95 + has_fake_perk("Combat Skills(Klint)"))) then begin
                                                                                            LVar2 := 95 + has_fake_perk("Combat Skills(Klint)");
                                                                                        end
                                                                                        set_sfall_global(4420, LVar2);
                                                                                        set_sfall_return(LVar2);
                                                                                    end
                                                                                end
                                                                                else begin
                                                                                    if (obj_pid(LVar0) == 16777766) then begin
                                                                                        if (has_fake_perk("Combat Skills(Diago)") > 0) then begin
                                                                                            LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                                            LVar2 := LVar1 + (has_fake_perk("Combat Skills(Diago)") * get_sfall_global_int(151));
                                                                                            if (LVar2 > (95 + has_fake_perk("Combat Skills(Diago)"))) then begin
                                                                                                LVar2 := 95 + has_fake_perk("Combat Skills(Diago)");
                                                                                            end
                                                                                            set_sfall_global(4420, LVar2);
                                                                                            set_sfall_return(LVar2);
                                                                                        end
                                                                                    end
                                                                                    else begin
                                                                                        if (obj_pid(LVar0) == 16777762) then begin
                                                                                            if (has_fake_perk("Combat Skills(Meris)") > 0) then begin
                                                                                                LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                                                LVar2 := LVar1 + (has_fake_perk("Combat Skills(Meris)") * get_sfall_global_int(151));
                                                                                                if (LVar2 > (95 + has_fake_perk("Combat Skills(Meris)"))) then begin
                                                                                                    LVar2 := 95 + has_fake_perk("Combat Skills(Meris)");
                                                                                                end
                                                                                                set_sfall_global(4420, LVar2);
                                                                                                set_sfall_return(LVar2);
                                                                                            end
                                                                                        end
                                                                                        else begin
                                                                                            if (obj_pid(LVar0) == 16777718) then begin
                                                                                                if (has_fake_perk("Combat Skills(Kitsune)") > 0) then begin
                                                                                                    LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                                                    LVar2 := LVar1 + (has_fake_perk("Combat Skills(Kitsune)") * get_sfall_global_int(151));
                                                                                                    if (LVar2 > (95 + has_fake_perk("Combat Skills(Kitsune)"))) then begin
                                                                                                        LVar2 := 95 + has_fake_perk("Combat Skills(Kitsune)");
                                                                                                    end
                                                                                                    set_sfall_global(4420, LVar2);
                                                                                                    set_sfall_return(LVar2);
                                                                                                end
                                                                                            end
                                                                                            else begin
                                                                                                if (obj_pid(LVar0) == 16777719) then begin
                                                                                                    if (has_fake_perk("Combat Skills(Dex)") > 0) then begin
                                                                                                        LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                                                        LVar2 := LVar1 + (has_fake_perk("Combat Skills(Dex)") * get_sfall_global_int(151));
                                                                                                        if (LVar2 > (95 + has_fake_perk("Combat Skills(Dex)"))) then begin
                                                                                                            LVar2 := 95 + has_fake_perk("Combat Skills(Dex)");
                                                                                                        end
                                                                                                        set_sfall_global(4420, LVar2);
                                                                                                        set_sfall_return(LVar2);
                                                                                                    end
                                                                                                end
                                                                                                else begin
                                                                                                    if (obj_pid(LVar0) == 16777720) then begin
                                                                                                        if (has_fake_perk("Combat Skills(Cat Jules)") > 0) then begin
                                                                                                            LVar1 := LVar1 + Calculate_Facing_Bonus(LVar3, LVar0);
                                                                                                            LVar2 := LVar1 + (has_fake_perk("Combat Skills(Cat Jules)") * get_sfall_global_int(151));
                                                                                                            if (LVar2 > (95 + has_fake_perk("Combat Skills(Cat Jules)"))) then begin
                                                                                                                LVar2 := 95 + has_fake_perk("Combat Skills(Cat Jules)");
                                                                                                            end
                                                                                                            set_sfall_global(4420, LVar2);
                                                                                                            set_sfall_return(LVar2);
                                                                                                        end
                                                                                                    end
                                                                                                end
                                                                                            end
                                                                                        end
                                                                                    end
                                                                                end
                                                                            end
                                                                        end
                                                                    end
                                                                end
                                                            end
                                                        end
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
                else begin
                end
            end
        end
        else begin
            display_msg("stock_to_hit " + LVar1 + " target " + LVar3 + " attacker " + LVar0 + " body_part " + LVar4);
        end
    end
end

procedure Get_Facing(variable arg0, variable arg1)
begin
    if (get_sfall_global_int(6200) != 1) then begin
        return 0;
    end
    if ((arg0 == dude_obj) and has_fake_perk("Lightning Reflexes")) then begin
        return 1;
    end
    if (obj_get_rot(arg1) == obj_get_rot(arg0)) then begin
        return 4;
    end
    else begin
        if ((obj_get_rot(arg1) == (obj_get_rot(arg0) + 1)) or (obj_get_rot(arg1) == (obj_get_rot(arg0) - 1))) then begin
            return 3;
        end
        else begin
            if ((obj_get_rot(arg1) == (obj_get_rot(arg0) + 2)) or (obj_get_rot(arg1) == (obj_get_rot(arg0) - 2))) then begin
                return 2;
            end
            else begin
                if ((obj_get_rot(arg1) == (obj_get_rot(arg0) + 3)) or (obj_get_rot(arg1) == (obj_get_rot(arg0) - 3))) then begin
                    return 1;
                end
            end
        end
    end
end

procedure Calculate_Facing_Bonus(variable arg0, variable arg1)
begin
    variable LVar2 := 0;
    if (Get_Facing(arg0, arg1) == 4) then begin
        LVar2 := get_sfall_global_int(4506);
    end
    else begin
        if (Get_Facing(arg0, arg1) == 3) then begin
            LVar2 := get_sfall_global_int(4507);
        end
        else begin
            if (Get_Facing(arg0, arg1) == 2) then begin
                LVar2 := get_sfall_global_int(4508);
            end
            else begin
                if (Get_Facing(arg0, arg1) == 1) then begin
                    LVar2 := get_sfall_global_int(4509);
                end
            end
        end
    end
    return LVar2;
end

procedure modify_critter(variable arg0)
begin
    if (((obj_in_party(arg0)) == 0) and (arg0 != dude_obj) and (obj_pid(arg0) != 16777376) and (obj_pid(arg0) != 16777377) and (obj_pid(arg0) != 16777305) and (obj_pid(arg0) != 16777313) and (obj_pid(arg0) != 16777323) and (obj_pid(arg0) != 16777352) and (obj_pid(arg0) != 16777368) and (obj_pid(arg0) != 16777291) and (obj_pid(arg0) != 16777278) and (obj_pid(arg0) != 16777379) and (obj_pid(arg0) != 16777380) and (obj_pid(arg0) != 16777859) and (obj_pid(arg0) != 16777558) and (obj_pid(arg0) != 16777687) and (obj_pid(arg0) != 16777766) and (obj_pid(arg0) != 16777762) and (obj_pid(arg0) != 16777785) and (obj_pid(arg0) != 16777720) and (obj_pid(arg0) != 16777718) and (obj_pid(arg0) != 16777719) and (get_sfall_global_int(4306) == 0) or ((arg0 != dude_obj) and (get_sfall_global_int(4306) == 1))) then begin
        if (get_critter_base_stat(arg0, 29) < 10) then begin
            set_critter_base_stat(arg0, 29, 10);
            if (get_sfall_global_int(2197) > 0) then begin
                if ((get_critter_extra_stat(arg0, 7) + get_critter_base_stat(arg0, 7) + get_sfall_global_int(2197)) > 2000) then begin
                    set_critter_extra_stat(arg0, 7, 2000 - (get_critter_extra_stat(arg0, 7) + get_critter_base_stat(arg0, 7)));
                end
                else begin
                    set_critter_extra_stat(arg0, 7, get_critter_extra_stat(arg0, 7) + get_sfall_global_int(2197));
                end
            end
            if (get_sfall_global_int(2190) > 0) then begin
                if ((get_critter_extra_stat(arg0, 8) + get_critter_base_stat(arg0, 8) + get_sfall_global_int(2190)) > (get_pc_stat(PCSTAT_level) + 5)) then begin
                    set_critter_extra_stat(arg0, 8, get_pc_stat(PCSTAT_level) + 5 - (get_critter_extra_stat(arg0, 8) + get_critter_base_stat(arg0, 8)));
                end
                else begin
                    set_critter_extra_stat(arg0, 8, get_critter_extra_stat(arg0, 8) + get_sfall_global_int(2190));
                end
            end
            if (get_sfall_global_int(2196) > 0) then begin
                if ((get_critter_extra_stat(arg0, 9) + get_critter_base_stat(arg0, 9) + get_sfall_global_int(2196)) > (get_pc_stat(PCSTAT_level) + 5)) then begin
                    set_critter_extra_stat(arg0, 9, get_pc_stat(PCSTAT_level) + 5 - (get_critter_extra_stat(arg0, 9) + get_critter_base_stat(arg0, 9)));
                end
                else begin
                    set_critter_extra_stat(arg0, 9, get_critter_extra_stat(arg0, 9) + get_sfall_global_int(2196));
                end
            end
        end
    end
end

procedure CalculateBonuses
begin
    math := 0;
    if (get_sfall_global_int(2161) > 0) then begin
        math := get_pc_stat(PCSTAT_level) / get_sfall_global_int(2161);
    end
    if ((get_sfall_global_int(2162) > 0) and (math > 0)) then begin
        math := math * get_sfall_global_int(2162);
    end
    if (get_sfall_global_int(2163) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(2163);
        end
        else begin
            math := get_sfall_global_int(2163);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > (get_pc_stat(PCSTAT_level) + 5)) then begin
        math := get_pc_stat(PCSTAT_level) + 5;
    end
    set_sfall_global(2190, math);
    math := 0;
    if (get_sfall_global_int(2164) > 0) then begin
        math := get_pc_stat(PCSTAT_level) / get_sfall_global_int(2164);
    end
    if ((get_sfall_global_int(2165) > 0) and (math > 0)) then begin
        math := math * get_sfall_global_int(2165);
    end
    if (get_sfall_global_int(2166) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(2166);
        end
        else begin
            math := get_sfall_global_int(2166);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > 200) then begin
        math := 200;
    end
    set_sfall_global(2191, math);
    math := 0;
    if (get_sfall_global_int(2167) > 0) then begin
        math := get_pc_stat(PCSTAT_level) / get_sfall_global_int(2167);
    end
    if ((get_sfall_global_int(2168) > 0) and (math > 0)) then begin
        math := math * get_sfall_global_int(2168);
    end
    if (get_sfall_global_int(2169) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(2169);
        end
        else begin
            math := get_sfall_global_int(2169);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > 95) then begin
        math := 95;
    end
    set_sfall_global(2192, math);
    math := 0;
    if (get_sfall_global_int(2170) > 0) then begin
        math := get_pc_stat(PCSTAT_level) / get_sfall_global_int(2170);
    end
    if ((get_sfall_global_int(2171) > 0) and (math > 0)) then begin
        math := math * get_sfall_global_int(2171);
    end
    if (get_sfall_global_int(2172) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(2172);
        end
        else begin
            math := get_sfall_global_int(2172);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > (get_pc_stat(PCSTAT_level) + 5)) then begin
        math := get_pc_stat(PCSTAT_level) + 5;
    end
    set_sfall_global(2193, math);
    math := 0;
    if (get_sfall_global_int(2173) > 0) then begin
        math := get_pc_stat(PCSTAT_level) / get_sfall_global_int(2173);
    end
    if ((get_sfall_global_int(2174) > 0) and (math > 0)) then begin
        math := math * get_sfall_global_int(2174);
    end
    if (get_sfall_global_int(2175) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(2175);
        end
        else begin
            math := get_sfall_global_int(2175);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > 200) then begin
        math := 200;
    end
    set_sfall_global(2194, math);
    math := 0;
    if (get_sfall_global_int(2176) > 0) then begin
        math := get_pc_stat(PCSTAT_level) / get_sfall_global_int(2176);
    end
    if ((get_sfall_global_int(2177) > 0) and (math > 0)) then begin
        math := math * get_sfall_global_int(2177);
    end
    if (get_sfall_global_int(2178) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(2178);
        end
        else begin
            math := get_sfall_global_int(2178);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > 200) then begin
        math := 200;
    end
    set_sfall_global(2195, math);
    math := 0;
    if (get_sfall_global_int(2179) > 0) then begin
        math := get_pc_stat(PCSTAT_level) / get_sfall_global_int(2179);
    end
    if ((get_sfall_global_int(2180) > 0) and (math > 0)) then begin
        math := math * get_sfall_global_int(2180);
    end
    if (get_sfall_global_int(2181) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(2181);
        end
        else begin
            math := get_sfall_global_int(2181);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > (get_pc_stat(PCSTAT_level) + 5)) then begin
        math := get_pc_stat(PCSTAT_level) + 5;
    end
    set_sfall_global(2196, math);
    math := 0;
    if (get_sfall_global_int(2182) > 0) then begin
        math := get_pc_stat(PCSTAT_level) * get_sfall_global_int(2182);
    end
    if (get_sfall_global_int(2183) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(2183);
        end
        else begin
            math := get_sfall_global_int(2183);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > 2000) then begin
        math := 2000;
    end
    set_sfall_global(2197, math);
    math := 0;
    if (get_sfall_global_int(2184) > 0) then begin
        math := get_pc_stat(PCSTAT_level) / get_sfall_global_int(2184);
    end
    if ((get_sfall_global_int(2185) > 0) and (math > 0)) then begin
        math := math * get_sfall_global_int(2185);
    end
    if (get_sfall_global_int(2186) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(2186);
        end
        else begin
            math := get_sfall_global_int(2186);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > 90) then begin
        math := 90;
    end
    set_sfall_global(2198, math);
    math := 0;
    if (get_sfall_global_int(2187) > 0) then begin
        math := get_pc_stat(PCSTAT_level) / get_sfall_global_int(2187);
    end
    if ((get_sfall_global_int(2188) > 0) and (math > 0)) then begin
        math := math * get_sfall_global_int(2188);
    end
    if (get_sfall_global_int(2189) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(2189);
        end
        else begin
            math := get_sfall_global_int(2189);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > 90) then begin
        math := 90;
    end
    set_sfall_global(2199, math);
    math := 0;
    if (get_sfall_global_int(4259) > 0) then begin
        math := get_pc_stat(PCSTAT_level) / get_sfall_global_int(4259);
    end
    if ((get_sfall_global_int(4260) > 0) and (math > 0)) then begin
        math := math * get_sfall_global_int(4260);
    end
    if (get_sfall_global_int(4261) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(4261);
        end
        else begin
            math := get_sfall_global_int(4261);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > 90) then begin
        math := 90;
    end
    set_sfall_global(4262, math);
    math := 0;
    if (get_sfall_global_int(4297) > 0) then begin
        math := get_pc_stat(PCSTAT_level) / get_sfall_global_int(4297);
    end
    if ((get_sfall_global_int(4298) > 0) and (math > 0)) then begin
        math := math * get_sfall_global_int(4298);
    end
    if (get_sfall_global_int(4299) > 0) then begin
        if (math > 0) then begin
            math := math + get_sfall_global_int(4299);
        end
        else begin
            math := get_sfall_global_int(4299);
        end
    end
    else begin
        if (math > 0) then begin
            math := math;
        end
        else begin
            math := 0;
        end
    end
    if (math > 200) then begin
        math := 200;
    end
    set_sfall_global(4300, math);
end

procedure HealCritter(variable arg0)
begin
    if (((obj_in_party(arg0)) == 0) and (arg0 != dude_obj) or ((arg0 != dude_obj) and (get_sfall_global_int(4306) == 1)) and not(combat_is_initialized) and not(critter_state(arg0) bwand 2)) then begin
        critter_heal(arg0, 2000);
        critter_injure(arg0, 4 bwor 8 bwor 16 bwor 32 bwor 64 bwor 8388608);
    end
end

procedure MapEnterHealCritter(variable arg0)
begin
    if (((obj_in_party(arg0)) == 0) and (arg0 != dude_obj) or ((arg0 != dude_obj) and (get_sfall_global_int(4306) == 1)) and not(critter_state(arg0) bwand 2)) then begin
        critter_heal(arg0, 2000);
    end
end
